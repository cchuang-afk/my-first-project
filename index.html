<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç¿’å ±åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä½œç‚ºä¸»è¦å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* å½ˆçª—èƒŒæ™¯å±¤çš„å‹•ç•«æ•ˆæœ */
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        /* å½ˆçª—å…§å®¹çš„å‹•ç•«æ•ˆæœ */
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-50px);
            opacity: 0;
        }
        .modal-open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* å¾Œå°æ¸…å–®è¡¨æ ¼æ¨£å¼ */
        .backend-table th, .backend-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            text-align: left;
        }
        .backend-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ -->
    <div class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

        <h1 class="text-4xl font-bold text-gray-800 mb-2">ç ”ç¿’å ±åç³»çµ±</h1>
        <p class="text-gray-600 mb-8">è«‹å¡«å¯«æ‚¨çš„å ±åè³‡è¨Š</p>

        <!-- Firebase ç‹€æ…‹/éŒ¯èª¤è¨Šæ¯ -->
        <div id="statusMessage" class="w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300">
            æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...
        </div>

        <!-- å ±åè¡¨å–®å€å¡Š -->
        <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">å ±åè¡¨å–®</h2>

            <form id="registrationForm" class="space-y-4">
                
                <!-- å­¸æ ¡æ¬„ä½ -->
                <div>
                    <label for="school" class="block text-sm font-medium text-gray-700 mb-1">å­¸æ ¡ (School)</label>
                    <input type="text" id="school" name="school" placeholder="è«‹è¼¸å…¥å­¸æ ¡åç¨±" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                </div>

                <!-- å§“åæ¬„ä½ -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">å§“å (Name)</label>
                    <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                </div>

                <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ -->
                <div>
                    <label for="id_number" class="block text-sm font-medium text-gray-700 mb-1">èº«ä»½è­‰å­—è™Ÿ (ID Number)</label>
                    <input type="text" id="id_number" name="id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿ (ä¾‹å¦‚: A123456789)" required
                           maxlength="10" pattern="[A-Z][0-9]{9}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    <p class="mt-1 text-xs text-gray-500">æ ¼å¼: 1ä½è‹±æ–‡å­—æ¯ + 9ä½æ•¸å­—</p>
                </div>
                
                <!-- æäº¤æŒ‰éˆ• -->
                <button type="submit" id="submitButton"
                        class="w-full bg-sky-600 text-white py-3 mt-6 rounded-lg font-semibold hover:bg-sky-700 transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50"
                        disabled>
                    ç«‹å³å ±å
                </button>
            </form>
        </div>

        <!-- ç ”ç¿’æ´»å‹•ç°½åˆ°å€å¡Š (æ›´æ–°ç‚ºä¸‰éšæ®µ) -->
        <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">ç ”ç¿’æ´»å‹•ç°½åˆ°</h2>

            <div class="space-y-4">
                <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ for Sign-In/Out -->
                <div>
                    <label for="sign_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                        ç°½åˆ°/ç°½é€€èº«ä»½è­‰å­—è™Ÿ (ID Number)
                    </label>
                    <input type="text" id="sign_id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿé€²è¡Œç°½åˆ°æˆ–ç°½é€€" required
                           maxlength="10" pattern="[A-Z][0-9]{9}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                </div>
                
                <!-- ç°½åˆ°/ç°½é€€æ™‚é–“è¨­å®š (å·²ç§»é™¤ï¼Œå°‡ä½¿ç”¨ç³»çµ±ç•¶å‰æ™‚é–“) -->

                <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 pt-2">
                    <!-- ä¸Šåˆç°½åˆ°æŒ‰éˆ• -->
                    <button id="morningCheckInButton" type="button" disabled
                            class="w-full sm:w-1/3 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50">
                        ä¸Šåˆç°½åˆ° (Morning Check In)
                    </button>
                    <!-- ä¸‹åˆç°½åˆ°æŒ‰éˆ• -->
                    <button id="afternoonCheckInButton" type="button" disabled
                            class="w-full sm:w-1/3 bg-yellow-600 text-white py-3 rounded-lg font-semibold hover:bg-yellow-700 transition duration-200 shadow-md disabled:opacity-50">
                        ä¸‹åˆç°½åˆ° (Afternoon Check In)
                    </button>
                    <!-- ä¸‹åˆç°½é€€æŒ‰éˆ• -->
                    <button id="afternoonCheckOutButton" type="button" disabled
                            class="w-full sm:w-1/3 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md disabled:opacity-50">
                        ä¸‹åˆç°½é€€ (Afternoon Check Out)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ç³»çµ±è¨­å®šå€å¡Š (æ›´æ–°ç‚ºå¯†ç¢¼æ§ç®¡é¡¯ç¤º) -->
        <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-8">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-700">ç³»çµ±è¨­å®š</h2>

                <!-- 1. é¡¯ç¤º/éš±è— æŒ‰éˆ• (æ¨£å¼å·²èª¿æ•´ç‚ºèˆ‡åŒ¯å‡ºæŒ‰éˆ•ç›¸è¿‘) -->
                <button id="toggleSettingsButton" type="button" disabled
                        class="px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                    è¨­å®šæ™‚é–“
                </button>
            </div>
            
            <p class="mt-4 text-gray-500 text-sm">
                é»æ“ŠæŒ‰éˆ•å¾Œè¼¸å…¥å¯†ç¢¼ï¼Œå³å¯è¨­å®šç°½åˆ°/ç°½é€€çš„é–‹æ”¾æ™‚é–“å€é–“ã€‚
            </p>

            <!-- 2. å¯†ç¢¼é©—è­‰å€å¡Š (é è¨­éš±è—) -->
            <div id="settingsAccessSection" class="hidden p-4 mt-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner">
                <label for="settingsAccessPassword" class="block text-sm font-medium text-yellow-700 mb-2">
                    <span class="font-bold">ğŸ”’ å¯†ç¢¼é©—è­‰ï¼š</span> è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–è¨­å®šã€‚
                </label>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <input type="password" id="settingsAccessPassword" placeholder="è¼¸å…¥å¯†ç¢¼..."
                           class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
                    <button id="confirmSettingsAccessButton" type="button"
                            class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                        ç¢ºèªå­˜å–
                    </button>
                </div>
                <p id="accessError" class="text-red-600 text-xs mt-2 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚</p>
            </div>
            
            <!-- 3. æ™‚é–“è¨­å®šè¼¸å…¥å€å¡Š (é è¨­éš±è—ï¼Œé©—è­‰æˆåŠŸå¾Œé¡¯ç¤º) -->
            <div class="space-y-4 hidden mt-4" id="settingsInputsContainer">
                
                <!-- ä¸Šåˆç°½åˆ°æ™‚é–“å€é–“è¨­å®š -->
                <div class="space-y-2 border-b pb-4 border-amber-100">
                    <label class="block text-sm font-bold text-gray-700">ä¸Šåˆç°½åˆ°é–‹æ”¾å€é–“ (Morning Check-in Time Range)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="setting_morning_ci_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                            <input type="datetime-local" id="setting_morning_ci_start" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                        </div>
                        <div>
                            <label for="setting_morning_ci_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                            <input type="datetime-local" id="setting_morning_ci_end" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                        </div>
                    </div>
                </div>

                <!-- ä¸‹åˆç°½åˆ°æ™‚é–“å€é–“è¨­å®š -->
                <div class="space-y-2 border-b pb-4 border-amber-100">
                    <label class="block text-sm font-bold text-gray-700">ä¸‹åˆç°½åˆ°é–‹æ”¾å€é–“ (Afternoon Check-in Time Range)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="setting_afternoon_ci_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                            <input type="datetime-local" id="setting_afternoon_ci_start" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                        </div>
                        <div>
                            <label for="setting_afternoon_ci_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                            <input type="datetime-local" id="setting_afternoon_ci_end" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                        </div>
                    </div>
                </div>
                
                <!-- ä¸‹åˆç°½é€€æ™‚é–“å€é–“è¨­å®š -->
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-700">ä¸‹åˆç°½é€€é–‹æ”¾å€é–“ (Afternoon Check-out Time Range)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="setting_afternoon_co_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                            <input type="datetime-local" id="setting_afternoon_co_start" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                        </div>
                        <div>
                            <label for="setting_afternoon_co_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                            <input type="datetime-local" id="setting_afternoon_co_end" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                        </div>
                    </div>
                </div>

                <!-- å„²å­˜æŒ‰éˆ•å€å¡Š -->
                <div id="settingsSaveSection" class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner">
                    <label class="block text-sm font-medium text-yellow-700 mb-2">
                        <span class="font-bold">ğŸ’¾ å„²å­˜è¨­å®šï¼š</span> è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å„²å­˜æ™‚é–“å€é–“ã€‚
                    </label>
                    <button id="saveSettingsButton" type="button" disabled
                            class="w-full px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                        å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>

        <!-- å¾Œå°è³‡æ–™æ“ä½œå€å¡Š -->
        <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700 whitespace-nowrap">å¾Œå°è³‡æ–™æ“ä½œ</h2>
                
                <!-- é€²å…¥ç³»çµ±æŒ‰éˆ• (é è¨­é¡¯ç¤º) -->
                <button id="accessBackendButton" type="button" disabled
                        class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50">
                    é€²å…¥ç³»çµ±
                </button>
            </div>
            
            <!-- å¯†ç¢¼è¼¸å…¥å€å¡Š (é€šç”¨) -->
            <div id="passwordSection" class="hidden p-4 mt-4 bg-gray-50 border border-red-300 rounded-lg shadow-inner">
                <label for="backendPassword" class="block text-sm font-medium text-red-700 mb-2">
                    <span class="font-bold">ğŸ”’ å¯†ç¢¼é©—è­‰ï¼š</span> è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°ã€‚
                </label>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <input type="password" id="backendPassword" placeholder="è¼¸å…¥å¯†ç¢¼ (661113)..."
                           class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    <button id="confirmBackendAccessButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        ç¢ºèªé€²å…¥
                    </button>
                </div>
                <p id="backendAccessError" class="text-red-600 text-xs mt-2 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚</p>
            </div>

            <!-- å¾Œå°åŠŸèƒ½å’Œæ¸…å–®å€å¡Š (é è¨­éš±è—) -->
            <div id="backendContent" class="hidden space-y-6 mt-6 pt-4 border-t border-gray-200">
                
                <h3 class="text-xl font-semibold text-gray-700">æ“ä½œæŒ‰éˆ•</h3>
                <div class="flex space-x-2 w-full justify-start mb-6">
                    <!-- åŒ¯å‡º CSV æŒ‰éˆ• -->
                    <button id="exportCsvButton" type="button"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        åŒ¯å‡º CSV
                    </button>
                    <!-- æ¸…ç©ºå ±åè³‡æ–™æŒ‰éˆ• -->
                    <button id="clearDataButton" type="button"
                            class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        æ¸…ç©ºå ±åè³‡æ–™
                    </button>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 pt-4 border-t border-gray-200">å ±åè€…æ¸…å–® (å³æ™‚æ›´æ–°)</h3>
                <!-- å ±åæ¸…å–®å°‡æ¸²æŸ“åˆ°æ­¤è™• -->
                <div id="registrationsListContainer" class="overflow-x-auto shadow-inner rounded-lg border">
                    <p class="p-4 text-sm text-gray-500 font-bold animate-pulse">ğŸ”” æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
                </div>
            </div>

            <p id="backendInfoText" class="mt-4 text-gray-500 text-sm">
                é»æ“Šã€Œé€²å…¥ç³»çµ±ã€ä¸¦è¼¸å…¥å¯†ç¢¼ä»¥æŸ¥çœ‹å ±åè€…æ¸…å–®åŠç®¡ç†è³‡æ–™ã€‚
            </p>
        </div>

        <!-- é¡¯ç¤º User ID ä¾›å”ä½œç”¨é€” -->
        <p class="mt-4 text-xs text-gray-400">
            <span class="font-semibold">ç•¶å‰ä½¿ç”¨è€… ID:</span> <span id="currentUserId">N/A</span>
        </p>

    </div>

    <!-- éæœƒå“¡å ±åéŒ¯èª¤å½ˆçª— (Modal) -->
    <div id="errorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-500">
            
            <!-- éŒ¯èª¤åœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.302 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="errorTitle">å ±åå¤±æ•—</h3>
            <p class="text-gray-600 mb-6" id="errorMessage">æ‚¨éæœƒå“¡ç„¡æ³•å ±åï¼Œè«‹æ´½æœƒå“¡çµ„</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeErrorModalButton" type="button"
                    class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>

    <!-- ç°½åˆ°/ç°½é€€æˆåŠŸå½ˆçª— (Modal) -->
    <div id="signSuccessModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- æˆåŠŸåœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-sky-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="signSuccessTitle">æ“ä½œæˆåŠŸï¼</h3>
            <p class="text-gray-600 mb-6" id="signSuccessMessage">æ‚¨å·²æˆåŠŸå®Œæˆç°½åˆ°/ç°½é€€ã€‚</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeSignModalButton" type="button"
                    class="w-full bg-sky-500 text-white py-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>
    
    <!-- å ±åæˆåŠŸå½ˆçª— (Modal) -->
    <div id="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- æˆåŠŸåœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2">å ±åæˆåŠŸï¼</h3>
            <p class="text-gray-600 mb-6">æ‚¨å·²æˆåŠŸå®Œæˆç ”ç¿’å ±åï¼Œè¬è¬æ‚¨çš„åƒèˆ‡ã€‚</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeModalButton" type="button"
                    class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>
    
    <!-- ç¢ºèªæ“ä½œå½ˆçª— (ç”¨æ–¼æ¸…ç©ºè³‡æ–™å‰çš„äºŒæ¬¡ç¢ºèª) -->
    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-lg p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-600">
            
            <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>

            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="confirmTitle">ç¢ºèªæ“ä½œ</h3>
            <p class="text-gray-600 mb-6" id="confirmMessage">æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±åç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼</p>

            <!-- æŒ‰éˆ•å€å¡Š -->
            <div class="flex justify-center space-x-4">
                <button id="cancelConfirmButton" type="button"
                        class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 shadow-md">
                    å–æ¶ˆ
                </button>
                <button id="executeConfirmButton" type="button"
                        class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md">
                    ç¢ºå®šæ¸…ç©º
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, orderBy, setDoc, getDoc, getDocs, where, updateDoc, doc, deleteDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Log ç´šåˆ¥ç‚º Debug
        setLogLevel('debug');

        // --- è¨­å®šå¯†ç¢¼èˆ‡æœƒå“¡åå–® ---
        const EXPORT_PASSWORD = '661113'; // ç®¡ç†å“¡å¯†ç¢¼
        
        // ** NEW: ä¾ç…§æ‚¨æä¾›çš„å§“åæ–°å¢çš„æœƒå“¡ç™½åå–® **
        const MEMBER_NAME_WHITELIST = [
            'æ¥Šé›¯çœŸ', 'æ—ä¾ç¦', 'è¨±å¤š', 'é‚±æƒ æ¬£', 'è¬ä½³å®¹', 'ç¾…å®›è©©', 'å‘¨ä½³è•™', 'è©¹ç†é›¯', 'è—æ¶”ç‘œ', 'é»ƒç¥¥é›²', 
            'é˜å·§é›¯', 'å³ç¾å¬‹', 'è‘‰é›…æƒ ', 'é™³ä¾æ±', 'å‘¨å¨Ÿå¦‚', 'å½­è¯æ€¡', 'é¾å®œç', 'é™³æ€¡å©·', 'é™³å©‰é’', 'æ¥Šæ™¶æ™¶', 
            'æå­Ÿæ½”', 'æ—äºå±', 'éƒ­å­ŸæŸ”', 'ç‹é‡‹æ•', 'é„­å­å¨', 'é™³ç¢§æ¥“', 'ä½•éº—å›', 'ç°¡ä½©çª', 'æ—æƒ ç²', 'èŠéœè¯', 
            'æ›¾éŸ»ç¶º', 'é„­è¡£å®¸', 'åš´æ•ç¦', 'ç¿éœèŠ', 'é»ƒéµ¬ç’†', 'æ­æ²›è“®', 'æ—å¿—éŸ³', 'å³å“²å®‡', 'æ—é¦™å®œ', 'é»ƒé³³è¯', 
            'æ—æ…§å¨Ÿ', 'é™³ç§‹ç¾', 'åŠ‰ç§€é³³', 'é™³ç´€å‹³', 'ç‹å˜‰çª', 'å€ªåº­å‰', 'æ´ªç‘‹è”†', 'æ¸¸è‰å¨Ÿ', 'æ¥Šèˆ’å©·', 'ç¾…æ˜ç ', 
            'æ¢ç‰æ¢…', 'é™³è‹“ç‰', 'é»ƒæ€¡è“‰', 'ä¾¯æ·‘ç¾', 'é™³é©ç´', 'è•­æ¢…åŸ', 'é™³ç®ç²', 'é»ƒé›…èŠ³', 'è¬è™¹å¨˜', 'æä½³é™µ', 
            'æœ±å“¡ä»™', 'è‘‰ç«æ±Ÿ', 'æ—é‡‘ç’°', 'é€£æ•ä¼¶', 'é™³ç“ä¹‹', 'é¥’é€Ÿè‹“', 'æ—å»‰ç®', 'åŠ‰ç‘è˜­', 'æ—ä¾ç‘©', 'é»ƒéº—è', 
            'å³èŠæ½”', 'å¼µé³³çº“', 'ç°¡æ¯“è', 'éƒ­å£å¦‚', 'éŒ¢æ¬£', 'ç‹ä¸­æ…§', 'æ—ä½©ç’‡', 'è¬ç´ ç‰', 'æ¥Šç¸ˆå©·', 'é™³å“è« ', 
            'å³æ·‘éˆ´', 'é»ƒå­åº­', 'é»ƒç«ç‘›', 'å‘¨æ€¡å›', 'è¬æ·‘è', 'é»ƒè‹¥å¬‹', 'æ¹¯ç§€æƒ ', 'å»–å½©éˆ´', 'å­«é³³å²‘', 'æ²ˆå¿é›²', 
            'é™³å®¶ç¾š', 'å®‹å…‹ç', 'è”¡éº—æœˆ', 'è¨±éº—æƒ ', 'æ—ç‰é›²', 'ä¾¯å®£ç¾½', 'é«˜ç‰ç', 'ç¾…ç“Šæ', 'å»–ä¹…æ…§', 'é˜®å¹³è‹±', 
            'å¼µå¨Ÿç¢§', 'è”¡ä½©å¨Ÿ', 'æŸ¯ç“Šè“®', 'æäºèŠ³', 'æç²ç²', 'é‚±å›ä½©', 'æ—å˜‰è‹±', 'æ–¹é›…æ…§', 'æŸ¯æ˜­åŸ', 'æ—ç§€è“‰', 
            'é™³æ€¡å„’', 'é™³äº­å¦‚', 'å¼µæ†¶èŒ¹', 'å¼µæƒ å›', 'æŸ¯ä»é³³', 'æ—é´»ç‡•', 'å³æŸèŠ', 'æ›¾ç´«å©•', 'æœ±æ˜ç‘©', 'å¼µæ·‘è²', 
            'é„­é›…ç’¿', 'æ´ªæ•»ç¦§', 'è•­ç™¾åˆ©', 'é™³ç¾éœ', 'ç‹å§¿çµœ', 'æä½³éœ–', 'ç›§å¥•éœ–', 'é™¸ç§€èŒœ', 'å§šæ½”èˆ²', 'é«˜æ•èŠ³', 
            'å‚…éƒè', 'èŠéº—ç‰', 'é¡èŠ³æ…§', 'ä½™é›ªå¦‚', 'é™³æ€ç¾½', 'é«˜ç¢§å¼˜', 'æ–¹ç¾å–„', 'å­«ç¿å½£', 'ç‹æ²›å¸†', 'å»–å‡±å›', 
            'é™³ç¾éŒ¦', 'éƒ­å¯¶å¯Œ', 'æ—çœŸç‘œ', 'é»ƒæ·‘å¨Ÿ', 'ç‹ç¶­å„€', 'è”¡ç§€ç²', 'è”¡ç‰è˜­', 'åŠ‰å¦™èŠ¬', 'æ—ç¢§èŠ¬', 'è¨±å‘å¦¤', 
            'é™³é›…è', 'é»ƒç®ç¶º', 'é„­éº—é›¯', 'é»ƒç§‹èŠ¬', 'è¨±è±é †', 'ç°¡å›ç²', 'é™³ä½©éˆ´', 'æŸ³å¬¬å©·', 'è˜‡éƒå©·', 'å³è•äº˜', 
            'æ±ªå˜‰ç²', 'è”¡å§å®¥', 'é™³æ…ˆæƒ ', 'è”¡æ·‘è', 'å³æ˜­ç‘©', 'åŠ‰æ¡‚é¦™', 'æ—ä¾‘ç¦', 'ç‹é–æƒ ', 'æ—å¯Œç´', 'ç‹æ¡‚è‹±', 
            'é„­é›…è', 'é»ƒè˜­é›…', 'ææƒ ç²', 'è”¡å­æ…§', 'å²æ½”å€«', 'é»ƒæ„æ·‘', 'é»ƒé›…éˆ´', 'æ—å®¹åŸ', 'ä½™éœé›¯', 'ææƒ å›', 
            'å³ç§€éº—', 'ç‹éˆºéŒ¡', 'è”¡æ¬£æ½”', 'å­«äºå©·', 'é„­ç§€å¦‚', 'å”è‹±æƒ ', 'ç‹ç§‹æœˆ', 'é™³ä½©å›', 'å»–é›ªèŠ¬', 'é»ƒæƒ è˜­', 
            'å³é›ªæ¦•', 'ç›§å©‰å©·', 'æ´ªæ¦•è“®', 'é‚±äºç', 'æ´ªé›…èŠ¬', 'è¨±èŠ·ç¿', 'é™³æ˜ å¦‚', 'æ´ªæ…§å¨Ÿ', 'éƒ­ç¾å¨Ÿ', 'æ—å‰é›…', 
            'ç°¡ç®æ€¡', 'å®‹å“ç­‘', 'é™³æŸæ±', 'é™³ç“Šè“‰', 'ç‹é³³å„€', 'æ­å®›è«­', 'å¼µæ¡‚èŠ', 'æˆ´éº—å¿', 'é™³ç¾åŸ', 'æ—å¦é›¯', 
            'æ¢æƒ èŠ³', 'éŸ“ç’å‹¤', 'å‚…ç§‹ç²', 'æ—é‡‘è‹±', 'è”¡é›…è‰', 'æ—æ€¡ä¼¶', 'è²·æ…§ç´‹', 'é™³æ·‘èŠ¬', 'ç‹åƒç¶º', 'é„­ç´ å¿', 
            'æ—ç‘è¯', 'é­å©‰è', 'æˆ´ç‰é›ª', 'å³ä½³ç’ƒ', 'æ—æ·‘è˜­', 'é‚±é˜¿åˆ†', 'é™³ç‰ç²', 'é™³æ¢¨ç‰', 'æ´ªè±å‡', 'ç›§æ¸…é¦™', 
            'é»ƒé³³ç¥', 'é¾ç’¿å¦‚', 'ææ¯“å©·', 'é™³ä¾è', 'å½­æƒ å©·', 'é»ƒå›è', 'é»ƒéº—æ•', 'é»ƒç³å©·', 'è‘‰æ™ºæƒ ', 'é„­å©·äº‘', 
            'é»ƒæ…§ç²', 'æ›¾é †ç©—', 'æ—ç´€ç‘©', 'æº«ç§‹éº—', 'é»ƒå©‰å©·', 'é„­æ€¡å›', 'ç‹æ¸èŒœ', 'é„­ä½³æƒ ', 'è”£å­å›', 'å³ä½³å„Ÿ', 
            'ç†Šç§‹ç´…', 'è–›å®‡æ™´', 'æˆ´æ„·ç³', 'æå°è', 'æœ±è²´é¦™', 'å³æ€¡å©·', 'ç‹ç§‹æ–‡', 'åŠ‰æ€¡å›', 'èŠä½³é ¤', 'ç°¡èç‡•', 
            'è¢ç·£', 'æ›¾è–°å„€', 'å³å®›å„’', 'æç¾é›²', 'é™³é›…è±', 'è˜‡å®‡ç¨œ', 'æ›¾å©‰å©·', 'æç§‹æ»¿', 'æœ±å˜‰æƒ ', 'æœ±æ–ç¦', 
            'é™³æ€¡éœ', 'æ—ç«‹è', 'è–›æ€¡èŠ¬', 'è”¡å©‰ç', 'ç‹ç´ è¯', 'æ›¾ç§€ç‡•', 'ç¾…ç§€æ˜¥', 'æ¥Šå¯¶è‹±', 'è˜‡é‘«æ·‘', 'æç‰ç´', 
            'ç‹ç›çŠ', 'å¼µæ·‘é›²', 'é™³å“å‡', 'å¼µç¿ èŠ¬', 'é„§ç‰ç³', 'é™³ç¾å¦‚', 'è–©æ–‡æƒ ', 'æˆ´éº—èŠ', 'æœ±è™¹çŸ', 'æ—æ†¶å©·', 
            'ä½•ç³æ†¶', 'è”¡æ¶µå¦®', 'ä½™éº—çœŸ', 'æ—å°è', 'è”¡ç å', 'æ²ˆèŠ³å¦‚', 'æœ±ç§€é³³', 'å¼µç¶­è²', 'å‘‚æ…§å¨Ÿ', 'é™³ç®è“‰', 
            'éƒ­ç¾å¼˜', 'ä½™ç§€èŠ', 'å­«ç¿Šè¯', 'è¬æ›‰å©·', 'é»ƒé›…ç­ ', 'è˜‡å€–ç‘¾', 'é™³ç§‹ç‡•', 'ç¨‹éº—é›ª', 'ç‹æ€¡éœ', 'ç‹æ…§æ•', 
            'æ›¾ç”œç´…', 'å»–æ·‘ä½‘', 'æä½©çŠ', 'å³ç´«ç‘€', 'é™³éº—è“‰', 'æ¢æ…§è“‰', 'å¤ä½©æ', 'æä½³èŠ¬', 'å³ç®å˜‰', 'æ—ç§€å®¸', 
            'åŠ‰æƒ å®¹', 'è¬å®›è«­', 'æ›¾æ¡‚ç ', 'æ¶‚æ˜¥ç¥', 'æ—è‰·å¦‚', 'è˜‡ç¾èŠ³', 'é™³ç‘›æ•', 'æ¢æ…§å¿', 'æ´ªæ·‘èŠ¬', 'æœ±ç§€å©·', 
            'æ—ç¿ è¯', 'é™³è‚²ç‘„', 'åŠ‰åƒç¶º', 'æ›¾å©‰å«•', 'å¼µæ˜­æƒ ', 'éŸ“ç§€æ•', 'æ´ªå«¦å¦™', 'æéŒ¦å¬Œ', 'é™³æ€æ¬£', 'ç‹éˆºå©·', 
            'å³æ·‘å¨Ÿ', 'é™³éœèŠ¬', 'é¾éº—è', 'é‚±èŠ³ç²', 'èƒ¡å»‰ç­ ', 'é»ƒæ·‘èŠ¬', 'è¬ç¾ç²', 'è‘‰æ·‘å„€', 'é–‰ç‰ç', 'é¡æ–‡èŒ¹', 
            'é„­é€²èˆˆ', 'ç‹æ·‘æ»¿', 'å³ç®å›', 'é»ƒç¡æ™¶', 'è³´çŸè‹‘', 'ç‹å‹‰æƒ ', 'è”¡ç“Šç¦', 'ä½•ç¾æƒ ', 'è¨±ç§€é¦™', 'æ½˜ç¾è˜­', 
            'å®‹ç§€æ¢…', 'è‘‰æ·‘å¦‚', 'å»–é‡‘è', 'æ¢é›…è', 'æ—æ€¡ä¼¶', 'å¼µéˆè²´', 'ç‹ç†ç‰', 'é»ƒå·§æ–‡', 'æ›¹å­Ÿè˜­', 'è”¡å“è²', 
            'é€£éº—çœŸ', 'æ´ªäºç¨€', 'èƒ¡æœˆåµ', 'è©¹ç®ç³', 'æé›¯é›¯', 'è¨±ç­‘ç§', 'è•­ç§‹è‹±', 'é»ƒæ™ºç‘‹', 'é¡è¯ç‘¢', 'è•­ç§€èŠ¬', 
            'åŠ‰å´‡çŠ', 'å®œç¾ç²', 'æç¶­å±', 'ç‹æ½”ç‘©', 'èƒ¡ä½©è˜­', 'éƒ­è©©æ•', 'åŠ‰å­Ÿè²', 'æ—ç§‹é¦™', 'é™³ç´ æƒ ', 'é»ƒæ¢…è¯', 
            'å¼µé¦™è˜­', 'åŠ‰ç¾ç²', 'é™³ç‘ªè‰', 'é™³æ™´', 'é­ç¾ç', 'ç›§ç´ éŸ¶', 'é™³æƒ çŸ', 'é™³ä¾è', 'æ½˜ä¸–è“‰', 'ææ¬å¿ƒ', 
            'è•­ç¾å¨£', 'å½­è²´å¦¤', 'é™³æ€¡å©·', 'é„­ç´ å®¹', 'éƒ­å‡¡çˆ¾', 'èŠæ•æ…§', 'æ´ªéŸ»ç¾', 'æŸ¯æ˜¥æƒ ', 'æ¥Šæ™ºæ…§', 'è¬æƒ èŒ¹', 
            'é™³ç§‹èŠ±', 'æ—ä½©å„€', 'é¾”èŠ¸ç‘±', 'æå®œéŒš', 'ç°¡éƒèŠ¬', 'å¼µç°¡é‡‡ç²', 'åŠ‰æ¡‚ç´', 'å®‹ç§‹æ', 'é«˜æ¹˜æƒ ', 'é™³æ…§é›¯', 
            'é»ƒä¼Šæ±', 'é„­ç¶­é›…', 'æ—å®¶å¦‚', 'æ—ç®å®‡', 'é„­è‚²æ–¹', 'è³´ä½³ä¼¶', 'è•­ç‰ç', 'åŠ‰ç¾ç²', 'è‘‰å† ä¼¶', 'é»ƒæ·‘è‰', 
            'åˆ©ä½³ç²', 'ä½™é»ƒå§¿è', 'æ—ç§€è²', 'å¼µå®œç›ˆ', 'åŠ‰éˆºè¯', 'æ²ˆéƒçˆ', 'æ¥Šå©‰æ…ˆ', 'ä½™å®›åº­', 'æ–½èˆ’æ¢…', 'é¾ä½©ç«¹', 
            'å‘¨å¦‚æ¢…'
        ];
        // **********************************
        
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        let db;
        let auth;
        let userId = 'anonymous';
        let isAuthReady = false;
        let isBackendAccessed = false; // NEW: è¿½è¹¤å¾Œå°æ˜¯å¦å·²ç™»å…¥
        
        // å…¨åŸŸç°½åˆ°/ç°½é€€æ™‚é–“å€é–“è¨­å®š (Date Object) - æ›´æ–°ç‚ºä¸‰å€‹å€é–“
        let morningCheckInStartTime = null; 
        let morningCheckInEndTime = null; 
        let afternoonCheckInStartTime = null; 
        let afternoonCheckInEndTime = null; 
        let afternoonCheckOutStartTime = null; 
        let afternoonCheckOutEndTime = null; 
        
        
        // *******************************************************************
        // â— é‡å°ã€ŒFirebase é…ç½®éºå¤±ã€çš„éŒ¯èª¤ä¿®å¾©èˆ‡èªªæ˜ â—
        // 
        // 1. å¦‚æœæ‚¨åœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼šè«‹ä¿æŒä»¥ä¸‹ç¨‹å¼ç¢¼ä¸è®Šã€‚
        // 2. å¦‚æœæ‚¨åœ¨æœ¬åœ° HTML æª”æ¡ˆä¸­é‹è¡Œï¼šè«‹å‹™å¿…å°‡æ‚¨åœ¨ Firebase Console å–å¾—çš„å°ˆæ¡ˆé…ç½®ç‰©ä»¶
        //    å¡«å…¥ä¸‹æ–¹çš„ `YOUR_LOCAL_FIREBASE_CONFIG` ä¸­ã€‚
        
        // å¦‚æœæ‚¨åœ¨æœ¬åœ°åŸ·è¡Œï¼Œè«‹åœ¨ä¸‹æ–¹çš„ { } å…§è²¼ä¸Šæ‚¨çš„ Firebase é…ç½®ç‰©ä»¶ã€‚
        const YOUR_LOCAL_FIREBASE_CONFIG = {
  apiKey: "AIzaSyBlqR82MrYJB_SCIrlSxdcUdDrW6K96TrE",
  authDomain: "csvs-8b55d.firebaseapp.com",
  projectId: "csvs-8b55d",
  storageBucket: "csvs-8b55d.firebasestorage.app",
  messagingSenderId: "93064933978",
  appId: "1:93064933978:web:226fc3a8a271b2a4975e63",
  measurementId: "G-W2ZJKEMPV4"
}; 
        
        // *******************************************************************
        
        // å–å¾—ç’°å¢ƒè®Šæ•¸ï¼Œé€™æ˜¯ Firebase å¿…è¦çš„é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // å¦‚æœ Canvas ç’°å¢ƒè®Šæ•¸ä¸å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨ YOUR_LOCAL_FIREBASE_CONFIG
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) 
            : YOUR_LOCAL_FIREBASE_CONFIG;
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        

        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        
        // ç°½åˆ°/ç°½é€€ç›¸é—œå…ƒç´  - æ›´æ–°ç‚ºä¸‰éšæ®µæŒ‰éˆ•
        const signIdNumberInput = document.getElementById('sign_id_number');
        const morningCheckInButton = document.getElementById('morningCheckInButton');
        const afternoonCheckInButton = document.getElementById('afternoonCheckInButton');
        const afternoonCheckOutButton = document.getElementById('afternoonCheckOutButton');
        
        // ç³»çµ±è¨­å®šç›¸é—œå…ƒç´ 
        const morningCheckInStartTimeInput = document.getElementById('setting_morning_ci_start');
        const morningCheckInEndTimeInput = document.getElementById('setting_morning_ci_end');
        const afternoonCheckInStartTimeInput = document.getElementById('setting_afternoon_ci_start');
        const afternoonCheckInEndTimeInput = document.getElementById('setting_afternoon_ci_end');
        const afternoonCheckOutStartTimeInput = document.getElementById('setting_afternoon_co_start');
        const afternoonCheckOutEndTimeInput = document.getElementById('setting_afternoon_co_end');
        const saveSettingsButton = document.getElementById('saveSettingsButton');

        // æ–°å¢çš„è¨­å®šå­˜å–å…ƒç´ 
        const toggleSettingsButton = document.getElementById('toggleSettingsButton');
        const settingsAccessSection = document.getElementById('settingsAccessSection');
        const settingsAccessPasswordInput = document.getElementById('settingsAccessPassword');
        const confirmSettingsAccessButton = document.getElementById('confirmSettingsAccessButton');
        const settingsInputsContainer = document.getElementById('settingsInputsContainer');
        const accessError = document.getElementById('accessError');

        // å¾Œå°æ“ä½œç›¸é—œå…ƒç´  (NEW/REPLACED)
        const accessBackendButton = document.getElementById('accessBackendButton');
        const backendContent = document.getElementById('backendContent');
        const backendPasswordInput = document.getElementById('backendPassword'); // é‡æ–°å®šç¾© ID
        const confirmBackendAccessButton = document.getElementById('confirmBackendAccessButton'); // é‡æ–°å®šç¾© ID
        const backendAccessError = document.getElementById('backendAccessError'); // é‡æ–°å®šç¾© ID
        const registrationsListContainer = document.getElementById('registrationsListContainer');
        const backendInfoText = document.getElementById('backendInfoText');

        const exportCsvButton = document.getElementById('exportCsvButton');
        const clearDataButton = document.getElementById('clearDataButton'); 

        // å½ˆçª—
        const successModal = document.getElementById('successModal'); // å ±åæˆåŠŸ
        const closeModalButton = document.getElementById('closeModalButton');
        const signSuccessModal = document.getElementById('signSuccessModal'); // ç°½åˆ°/ç°½é€€æˆåŠŸ
        const closeSignModalButton = document.getElementById('closeSignModalButton');
        const signSuccessTitle = document.getElementById('signSuccessTitle');
        const signSuccessMessage = document.getElementById('signSuccessMessage');
        const errorModal = document.getElementById('errorModal'); // å ±åéŒ¯èª¤
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const confirmModal = document.getElementById('confirmModal'); // æ¸…ç©ºè³‡æ–™äºŒæ¬¡ç¢ºèª
        const cancelConfirmButton = document.getElementById('cancelConfirmButton');
        const executeConfirmButton = document.getElementById('executeConfirmButton');


        let areSettingsVisible = false; // è¿½è¹¤è¨­å®šå€å¡Šæ˜¯å¦å·²æˆåŠŸé©—è­‰ä¸¦é¡¯ç¤º

        // --- å½ˆçª—ç›¸é—œå‡½æ•¸ ---

        function showSuccessModal() {
            successModal.classList.remove('hidden');
            setTimeout(() => { successModal.classList.add('modal-open'); }, 10);
        }

        function hideSuccessModal() {
            successModal.classList.remove('modal-open');
            setTimeout(() => { successModal.classList.add('hidden'); }, 300);
        }
        
        function showSignSuccessModal(title, message) {
            signSuccessTitle.textContent = title;
            signSuccessMessage.textContent = message;
            signSuccessModal.classList.remove('hidden');
            setTimeout(() => { signSuccessModal.classList.add('modal-open'); }, 10);
        }
        
        function hideSignSuccessModal() {
            signSuccessModal.classList.remove('modal-open');
            setTimeout(() => { signSuccessModal.classList.add('hidden'); }, 300);
        }

        function showErrorModal(title, message) {
            errorTitle.textContent = title;
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            setTimeout(() => { errorModal.classList.add('modal-open'); }, 10);
        }
        
        function hideErrorModal() {
            errorModal.classList.remove('modal-open');
            setTimeout(() => { errorModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * é¡¯ç¤ºäºŒæ¬¡ç¢ºèªå½ˆçª—
         * @param {string} title æ¨™é¡Œ
         * @param {string} message è¨Šæ¯
         */
        function showConfirmModal(title, message) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmModal.classList.remove('hidden');
            setTimeout(() => { confirmModal.classList.add('modal-open'); }, 10);
        }

        /**
         * éš±è—äºŒæ¬¡ç¢ºèªå½ˆçª—
         */
        function hideConfirmModal() {
            confirmModal.classList.remove('modal-open');
            setTimeout(() => { confirmModal.classList.add('hidden'); }, 300);
        }

        /**
         * é¡¯ç¤ºè¨Šæ¯çµ¦ä½¿ç”¨è€…ï¼Œä¸¦è¨­å®šæ¨£å¼
         * @param {string} message è¨Šæ¯å…§å®¹
         * @param {string} type è¨Šæ¯é¡å‹: 'info', 'success', 'error'
         * @param {number} duration è¨Šæ¯é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’), é è¨­ 5000ms
         */
        function displayMessage(message, type = 'info', duration = 5000) {
            let bgColor = '';
            let textColor = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-sky-100';
                    textColor = 'text-sky-800';
                    break;
            }
            
            // ç«‹å³é¡¯ç¤ºè¨Šæ¯
            statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300 ${bgColor} ${textColor}`;
            statusMessage.textContent = message;

            // è¨­ç½®è¨ˆæ™‚å™¨ï¼Œåœ¨ä¸€æ®µæ™‚é–“å¾Œæ¸…é™¤è¨Šæ¯
            clearTimeout(window.statusMessageTimeout);
            if (duration > 0) {
                window.statusMessageTimeout = setTimeout(() => {
                    // æ¸…é™¤æ¨£å¼å’Œå…§å®¹
                    statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300`;
                    statusMessage.textContent = 'ç³»çµ±æº–å‚™å°±ç·’ã€‚';
                }, duration);
            }
        }
        
        /**
         * æ ¼å¼åŒ– Date ç‰©ä»¶ç‚º datetime-local è¼¸å…¥æ ¼å¼ (YYYY-MM-DDTHH:MM)
         * @param {Date} dateObj 
         */
        function formatToLocalDatetime(dateObj) {
            // ç¢ºä¿è¼¸å…¥æ˜¯ Date ç‰©ä»¶
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            
            // èª¿æ•´æ™‚å€åç§»ï¼Œä»¥é¡¯ç¤ºæ­£ç¢ºçš„æœ¬åœ°æ™‚é–“åœ¨ datetime-local è¼¸å…¥æ¡†
            const tempDate = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000));
            return tempDate.toISOString().slice(0, 16);
        }

        /**
         * æ ¼å¼åŒ–æ™‚é–“æˆ³ helper
         */
        const formatTimestamp = (ts) => {
            if (ts instanceof Date) {
                 return ts.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            } else if (ts && ts.toDate) {
                return ts.toDate().toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
            return 'N/A';
        }

        /**
         * ç²å–å…¬ç”¨è³‡æ–™é›†çš„ Firestore é›†åˆåƒè€ƒ
         */
        function getRegistrationsCollectionRef() {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘: /artifacts/{appId}/public/data/registrations
            return collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
        }
        
        /**
         * ç²å–ç³»çµ±è¨­å®šæ–‡ä»¶çš„ Firestore æ–‡ä»¶åƒè€ƒ
         */
        function getSettingsDocRef() {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘: /artifacts/{appId}/public/data/app_settings/config
            return doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config');
        }

        /**
         * åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œèº«ä»½é©—è­‰
         */
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                // å¦‚æœ firebaseConfig ç‚ºç©ºç‰©ä»¶ï¼Œè¡¨ç¤ºæœ¬åœ°é…ç½®éºå¤±
                displayMessage('éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åƒè€ƒç¨‹å¼ç¢¼ä¸­çš„è¨»é‡‹ï¼Œåœ¨ `YOUR_LOCAL_FIREBASE_CONFIG` è™•å¡«å…¥æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®ã€‚', 'error', 0);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                displayMessage('æ­£åœ¨é€²è¡Œèº«ä»½é©—è­‰...', 'info', 0);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        displayMessage('ç³»çµ±åˆå§‹åŒ–æˆåŠŸï¼Œæ­¡è¿ä½¿ç”¨ï¼', 'success');
                        submitButton.disabled = false;
                        morningCheckInButton.disabled = false;
                        afternoonCheckInButton.disabled = false;
                        afternoonCheckOutButton.disabled = false;
                        toggleSettingsButton.disabled = false; // å•Ÿç”¨è¨­å®šæŒ‰éˆ•
                        accessBackendButton.disabled = false; // å•Ÿç”¨å¾Œå°é€²å…¥æŒ‰éˆ• // NEW
                        isAuthReady = true;
                        await fetchSettings(); // è¼‰å…¥ç³»çµ±è¨­å®š
                    } else {
                        // å¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œå˜—è©¦åŒ¿åç™»å…¥
                        if (initialAuthToken) {
                            // ä½¿ç”¨æä¾›çš„å®¢è£½åŒ– token ç™»å…¥
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // å¦å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                displayMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message} (è«‹æª¢æŸ¥é…ç½®)`, 'error', 0);
            }
        }
        
        // --- å ±åæ¸…å–®é¡¯ç¤ºèˆ‡æ›´æ–° (NEW) ---

        /**
         * æ¸²æŸ“å ±åè€…æ¸…å–®åˆ°ç•«é¢ä¸Š
         * @param {Array<Object>} registrations å ±åè³‡æ–™é™£åˆ—
         */
        function renderRegistrationsList(registrations) {
            if (registrations.length === 0) {
                registrationsListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">ç›®å‰æ²’æœ‰ä»»ä½•å ±åç´€éŒ„ã€‚</p>';
                return;
            }

            // **NEW: å®¢æˆ¶ç«¯æ’åºï¼Œä»¥ç¢ºä¿åˆ—è¡¨æ˜¯æŒ‰æœ€æ–°å ±åæ™‚é–“æ’åº (é™åº)**
            registrations.sort((a, b) => {
                // è™•ç† Firestore Timestamp æˆ– Date ç‰©ä»¶
                const timeA = a.timestamp && (a.timestamp.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp).getTime());
                const timeB = b.timestamp && (b.timestamp.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp).getTime());
                
                // è™•ç†ç„¡æ•ˆæ™‚é–“ï¼Œç¢ºä¿ç©©å®šæ’åº
                if (!timeA && !timeB) return 0;
                if (!timeA) return 1;
                if (!timeB) return -1;
                
                return timeB - timeA; // é™åº (B - A)
            });


            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 backend-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>å­¸æ ¡</th>
                            <th>å§“å</th>
                            <th>èº«ä»½è­‰å­—è™Ÿ</th>
                            <th>å ±åæ™‚é–“</th>
                            <th>ä¸Šåˆç°½åˆ°</th>
                            <th>ä¸‹åˆç°½åˆ°</th>
                            <th>ä¸‹åˆç°½é€€</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            registrations.forEach((reg, index) => {
                const idMasked = reg.id_number ? reg.id_number.substring(0, 4) + '******' : 'N/A';
                
                const getSignStatus = (time) => {
                    if (time) {
                        return `<span class="text-green-600 font-medium">âœ… ${formatTimestamp(time)}</span>`;
                    }
                    return '<span class="text-red-500">âŒ æœªç°½åˆ°/é€€</span>';
                };

                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reg.school}</td>
                        <td>${reg.name}</td>
                        <td>${idMasked}</td>
                        <td>${formatTimestamp(reg.timestamp)}</td>
                        <td>${getSignStatus(reg.morningCheckInTime)}</td>
                        <td>${getSignStatus(reg.afternoonCheckInTime)}</td>
                        <td>${getSignStatus(reg.afternoonCheckOutTime)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            registrationsListContainer.innerHTML = tableHTML;
        }

        /**
         * å¾ Firestore ç²å–è³‡æ–™ä¸¦é–‹å§‹å³æ™‚ç›£è½ (åƒ…åœ¨å¾Œå°é€²å…¥æ™‚èª¿ç”¨ä¸€æ¬¡)
         */
        function setupBackendListener() {
            if (!db || isBackendAccessed) return;

            // è¨­ç½®è¼‰å…¥ä¸­ç‹€æ…‹ (æ–°å¢å‹•ç•«å’Œå¼·èª¿)
            registrationsListContainer.innerHTML = '<p class="p-4 text-center text-sky-500 font-bold animate-pulse">ğŸ”” æ­£åœ¨å•Ÿå‹•å³æ™‚ç›£è½ä¸¦è¼‰å…¥è³‡æ–™...</p>';

            // **MODIFIED: ç§»é™¤ orderByï¼Œæ”¹ç‚ºç°¡å–®æŸ¥è©¢**
            const q = query(getRegistrationsCollectionRef()); 
            
            console.log("Firestore Listener: Setting up onSnapshot listener for registrations...");
            
            // è¨­ç½®å³æ™‚ç›£è½å™¨
            const unsubscribe = onSnapshot(q, (snapshot) => {
                console.log(`Firestore Listener: Snapshot received. Documents found: ${snapshot.size}`);
                const registrations = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // ç²å–æ‰€æœ‰æ¬„ä½
                    registrations.push(data);
                });
                renderRegistrationsList(registrations); 
            }, (error) => {
                // æ•ç²éŒ¯èª¤ä¸¦é¡¯ç¤º (æ›´æ˜ç¢ºçš„éŒ¯èª¤æç¤º)
                console.error("Firestore Listener Error: å³æ™‚ç›£è½å ±åè³‡æ–™å¤±æ•—:", error);
                registrationsListContainer.innerHTML = '<p class="p-4 text-center text-red-600 font-bold">âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨æ§åˆ¶å° (Console) ä¸­çš„éŒ¯èª¤è¨Šæ¯ï¼Œç‰¹åˆ¥æ˜¯ "Permission Denied" éŒ¯èª¤ã€‚</p>';
            });

            // æ¨™è¨˜ç‚ºå·²å­˜å–ï¼Œé¿å…é‡è¤‡è¨­ç½®ç›£è½å™¨
            isBackendAccessed = true;
            console.log("Firestore Listener: onSnapshot setup complete.");
        }


        // --- ç³»çµ±è¨­å®šæ“ä½œ ---

        /**
         * å¾ Firestore ç²å–ç³»çµ±è¨­å®š
         */
        async function fetchSettings() {
            if (!db) return;

            try {
                const settingsRef = getSettingsDocRef();
                const docSnap = await getDoc(settingsRef);

                const nowDatetime = formatToLocalDatetime(new Date());

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // è½‰æ› Firestore Timestamp/Date ç‚º JavaScript Date object - æ›´æ–°ç‚ºå…­å€‹æ™‚é–“
                    morningCheckInStartTime = data.morningCheckInStartTime && data.morningCheckInStartTime.toDate ? data.morningCheckInStartTime.toDate() : null;
                    morningCheckInEndTime = data.morningCheckInEndTime && data.morningCheckInEndTime.toDate ? data.morningCheckInEndTime.toDate() : null;
                    afternoonCheckInStartTime = data.afternoonCheckInStartTime && data.afternoonCheckInStartTime.toDate ? data.afternoonCheckInStartTime.toDate() : null;
                    afternoonCheckInEndTime = data.afternoonCheckInEndTime && data.afternoonCheckInEndTime.toDate ? data.afternoonCheckInEndTime.toDate() : null;
                    afternoonCheckOutStartTime = data.afternoonCheckOutStartTime && data.afternoonCheckOutStartTime.toDate ? data.afternoonCheckOutStartTime.toDate() : null;
                    afternoonCheckOutEndTime = data.afternoonCheckOutEndTime && data.afternoonCheckOutEndTime.toDate ? data.afternoonCheckOutEndTime.toDate() : null;

                    // æ›´æ–° UI è¼¸å…¥æ¡†çš„å€¼ï¼Œå¦‚æœç‚º null å‰‡ä½¿ç”¨ç•¶å‰æ™‚é–“
                    morningCheckInStartTimeInput.value = morningCheckInStartTime ? formatToLocalDatetime(morningCheckInStartTime) : nowDatetime;
                    morningCheckInEndTimeInput.value = morningCheckInEndTime ? formatToLocalDatetime(morningCheckInEndTime) : nowDatetime;
                    afternoonCheckInStartTimeInput.value = afternoonCheckInStartTime ? formatToLocalDatetime(afternoonCheckInStartTime) : nowDatetime;
                    afternoonCheckInEndTimeInput.value = afternoonCheckInEndTime ? formatToLocalDatetime(afternoonCheckInEndTime) : nowDatetime;
                    afternoonCheckOutStartTimeInput.value = afternoonCheckOutStartTime ? formatToLocalDatetime(afternoonCheckOutStartTime) : nowDatetime;
                    afternoonCheckOutEndTimeInput.value = afternoonCheckOutEndTime ? formatToLocalDatetime(afternoonCheckOutEndTime) : nowDatetime;

                    displayMessage('ç³»çµ±è¨­å®šå·²è¼‰å…¥ã€‚', 'info', 3000);
                } else {
                    // å¦‚æœæ²’æœ‰è¨­å®šæª”ï¼Œåˆå§‹åŒ–è¼¸å…¥æ¡†ç‚ºç•¶å‰æ™‚é–“
                    morningCheckInStartTimeInput.value = nowDatetime;
                    morningCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckInStartTimeInput.value = nowDatetime;
                    afternoonCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckOutStartTimeInput.value = nowDatetime;
                    afternoonCheckOutEndTimeInput.value = nowDatetime;
                    displayMessage('ç³»çµ±è¨­å®šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè«‹é€²è¡Œåˆå§‹åŒ–è¨­å®šã€‚', 'info', 5000);
                }
                
                saveSettingsButton.disabled = false; // è¼‰å…¥å®Œæˆå¾Œå•Ÿç”¨å„²å­˜æŒ‰éˆ•

            } catch (error) {
                console.error("ç²å–ç³»çµ±è¨­å®šå¤±æ•—:", error);
                displayMessage('ç²å–ç³»çµ±è¨­å®šå¤±æ•—ã€‚', 'error', 5000);
            }
        }

        /**
         * è™•ç†é¡¯ç¤º/éš±è—è¨­å®šå€å¡Š
         */
        function handleToggleSettings() {
            if (!isAuthReady) return;
            
            // æ¯æ¬¡é»æ“Šéƒ½é‡è¨­å¯†ç¢¼é©—è­‰ç‹€æ…‹
            settingsAccessSection.classList.add('hidden');
            settingsInputsContainer.classList.add('hidden');
            settingsAccessPasswordInput.value = '';
            accessError.classList.add('hidden');

            if (areSettingsVisible) {
                // å¦‚æœç›®å‰æ˜¯é¡¯ç¤ºç‹€æ…‹ï¼Œé»æ“Šå‰‡éš±è—
                areSettingsVisible = false;
                displayMessage('ç³»çµ±è¨­å®šå·²éš±è—ã€‚', 'info', 2000);
            } else {
                // å¦‚æœç›®å‰æ˜¯éš±è—ç‹€æ…‹ï¼Œå‰‡é¡¯ç¤ºå¯†ç¢¼å€å¡Šé€²è¡Œå­˜å–é©—è­‰
                settingsAccessSection.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–è¨­å®šã€‚', 'info', 5000);
            }
        }

        /**
         * è™•ç†ç¢ºèªå­˜å–è¨­å®šå€å¡Šçš„å¯†ç¢¼
         */
        function handleConfirmSettingsAccess() {
            const enteredPassword = settingsAccessPasswordInput.value;
            
            if (enteredPassword === EXPORT_PASSWORD) {
                // å¯†ç¢¼æ­£ç¢º: é¡¯ç¤ºè¨­å®šè¼¸å…¥å€å¡Šï¼Œéš±è—é©—è­‰å€å¡Š
                settingsAccessSection.classList.add('hidden');
                settingsInputsContainer.classList.remove('hidden');
                areSettingsVisible = true;
                settingsAccessPasswordInput.value = ''; // æ¸…ç©ºå¯†ç¢¼
                accessError.classList.add('hidden');
                displayMessage('å¯†ç¢¼æ­£ç¢ºï¼Œè¨­å®šå€å¡Šå·²é–‹å•Ÿã€‚', 'success', 3000);

            } else {
                // å¯†ç¢¼éŒ¯èª¤: é¡¯ç¤ºéŒ¯èª¤ï¼Œæ¸…ç©ºè¼¸å…¥æ¡†
                settingsAccessPasswordInput.value = '';
                accessError.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•å­˜å–è¨­å®šã€‚', 'error', 5000);
            }
        }

        /**
         * å„²å­˜ç³»çµ±è¨­å®š (æ›´æ–°ç‚ºå…­å€‹æ™‚é–“å€é–“)
         */
        async function handleSaveSettings() {
            if (!isAuthReady || !areSettingsVisible) {
                displayMessage('è«‹å…ˆå­˜å–è¨­å®šå€å¡Šä¸¦ç¢ºä¿ç³»çµ±å·²æº–å‚™å¥½ã€‚', 'error');
                return;
            }

            saveSettingsButton.disabled = true;
            saveSettingsButton.textContent = 'å„²å­˜ä¸­...';
            
            // ç²å–å…­å€‹æ™‚é–“å­—ä¸²
            const miStartStr = morningCheckInStartTimeInput.value;
            const miEndStr = morningCheckInEndTimeInput.value;
            const aiStartStr = afternoonCheckInStartTimeInput.value;
            const aiEndStr = afternoonCheckInEndTimeInput.value;
            const aoStartStr = afternoonCheckOutStartTimeInput.value;
            const aoEndStr = afternoonCheckOutEndTimeInput.value;

            // æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦å¡«å¯«
            if (!miStartStr || !miEndStr || !aiStartStr || !aiEndStr || !aoStartStr || !aoEndStr) {
                displayMessage('æ‰€æœ‰ç°½åˆ°/ç°½é€€æ™‚é–“å€é–“éƒ½å¿…é ˆè¨­å®šã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            // è½‰æ›ç‚º Date ç‰©ä»¶
            const miStartDate = new Date(miStartStr);
            const miEndDate = new Date(miEndStr);
            const aiStartDate = new Date(aiStartStr);
            const aiEndDate = new Date(aiEndStr);
            const aoStartDate = new Date(aoStartStr);
            const aoEndDate = new Date(aoEndStr);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç„¡æ•ˆæ—¥æœŸ
            if (isNaN(miStartDate.getTime()) || isNaN(miEndDate.getTime()) || 
                isNaN(aiStartDate.getTime()) || isNaN(aiEndDate.getTime()) || 
                isNaN(aoStartDate.getTime()) || isNaN(aoEndDate.getTime())) {
                displayMessage('ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼ï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            // é©—è­‰å€é–“é‚è¼¯
            if (miStartDate.getTime() >= miEndDate.getTime()) {
                 displayMessage('ä¸Šåˆç°½åˆ°é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aiStartDate.getTime() >= aiEndDate.getTime()) {
                 displayMessage('ä¸‹åˆç°½åˆ°é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aoStartDate.getTime() >= aoEndDate.getTime()) {
                 displayMessage('ä¸‹åˆç°½é€€é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            // æª¢æŸ¥æ™‚é–“é€£è²«æ€§ (ä¸ŠåˆçµæŸ < ä¸‹åˆé–‹å§‹, ä¸‹åˆçµæŸ < ç°½é€€é–‹å§‹)
            if (miEndDate.getTime() >= aiStartDate.getTime()) {
                displayMessage('ä¸Šåˆç°½åˆ°çµæŸæ™‚é–“å¿…é ˆæ—©æ–¼ä¸‹åˆç°½åˆ°é–‹å§‹æ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aiEndDate.getTime() >= aoStartDate.getTime()) {
                displayMessage('ä¸‹åˆç°½åˆ°çµæŸæ™‚é–“å¿…é ˆæ—©æ–¼ä¸‹åˆç°½é€€é–‹å§‹æ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            const newSettings = {
                morningCheckInStartTime: miStartDate,
                morningCheckInEndTime: miEndDate,
                afternoonCheckInStartTime: aiStartDate,
                afternoonCheckInEndTime: aiEndDate,
                afternoonCheckOutStartTime: aoStartDate,
                afternoonCheckOutEndTime: aoEndDate
            };

            try {
                // ä½¿ç”¨ setDoc è¦†è“‹æˆ–å‰µå»ºå–®ä¸€è¨­å®šæ–‡ä»¶
                await setDoc(getSettingsDocRef(), newSettings, { merge: true });
                
                // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                morningCheckInStartTime = miStartDate;
                morningCheckInEndTime = miEndDate;
                afternoonCheckInStartTime = aiStartDate;
                afternoonCheckInEndTime = aiEndDate;
                afternoonCheckOutStartTime = aoStartDate;
                afternoonCheckOutEndTime = aoEndDate;
                
                displayMessage('ç³»çµ±è¨­å®šå„²å­˜æˆåŠŸï¼', 'success');

                // å„²å­˜æˆåŠŸå¾Œæ”¶èµ·è¨­å®šè¦–çª—
                settingsInputsContainer.classList.add('hidden');
                areSettingsVisible = false;

            } catch (error) {
                console.error("å„²å­˜ç³»çµ±è¨­å®šå¤±æ•—:", error);
                displayMessage(`å„²å­˜è¨­å®šå¤±æ•—: ${error.message}`, 'error');
            } finally {
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
            }
        }


        /**
         * æäº¤å ±åè¡¨å–®
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡æäº¤
            submitButton.disabled = true;
            submitButton.textContent = 'å ±åä¸­...';

            const school = document.getElementById('school').value.trim();
            const name = document.getElementById('name').value.trim();
            const id_number = document.getElementById('id_number').value.trim().toUpperCase(); // é›–ç„¶ç”¨ä¸åˆ°ï¼Œä½†ä»éœ€æ ¼å¼åŒ–

            // åŸºæœ¬é©—è­‰
            if (!school || !name || !id_number) {
                displayMessage('æ‰€æœ‰æ¬„ä½éƒ½å¿…é ˆå¡«å¯«ï¼', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            
            // èº«ä»½è­‰å­—è™Ÿæ ¼å¼é©—è­‰ (ç°¡æ˜“ç‰ˆ: 10ç¢¼ï¼Œé¦–å­—è‹±æ–‡ï¼Œå¾Œ9ç¢¼æ•¸å­—)
            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(id_number)) {
                displayMessage('å ±åèº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            
            // *** NEW: æª¢æŸ¥æ˜¯å¦åœ¨æœƒå“¡åå–®å…§ (ä»¥å§“åç‚ºä¾æ“š) ***
            if (!MEMBER_NAME_WHITELIST.includes(name)) {
                // ä½¿ç”¨æ–°å¢çš„éŒ¯èª¤å½ˆçª— (NEW)
                showErrorModal('å ±åå¤±æ•—', 'æ‚¨éæœƒå“¡ç„¡æ³•å ±åï¼Œè«‹æ´½æœƒå“¡çµ„');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            // **********************************

            // æª¢æŸ¥æ˜¯å¦å·²å ±å (ä»ä»¥èº«ä»½è­‰å­—è™Ÿç‚ºå”¯ä¸€éµ)
            const qCheck = query(getRegistrationsCollectionRef(), where('id_number', '==', id_number));
            const existingDocs = await getDocs(qCheck);
            if (!existingDocs.empty) {
                displayMessage('æ‚¨å·²ä½¿ç”¨æ­¤èº«ä»½è­‰å­—è™Ÿå ±åéï¼Œè«‹å‹¿é‡è¤‡å ±åã€‚', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }


            const newRegistration = {
                school,
                name,
                id_number,
                timestamp: new Date(), // ä½¿ç”¨ç•¶å‰æ™‚é–“è¨˜éŒ„å ±å
                registeredBy: userId,
                morningCheckInTime: null, // æ–°å¢æ¬„ä½
                afternoonCheckInTime: null, // æ–°å¢æ¬„ä½
                afternoonCheckOutTime: null // æ–°å¢æ¬„ä½
            };

            try {
                await addDoc(getRegistrationsCollectionRef(), newRegistration);
                
                // *** å ±åæˆåŠŸå¾Œé¡¯ç¤ºå½ˆçª— ***
                showSuccessModal(); 

                form.reset(); 

            } catch (error) {
                console.error("æ–°å¢å ±åè³‡æ–™å¤±æ•—:", error);
                displayMessage(`å ±åå¤±æ•—: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
            }
        }

        /**
         * è™•ç†ä¸Šåˆç°½åˆ°
         */
        async function handleMorningCheckIn() {
            await processSignAction('morningCheckIn');
        }

        /**
         * è™•ç†ä¸‹åˆç°½åˆ°
         */
        async function handleAfternoonCheckIn() {
            await processSignAction('afternoonCheckIn');
        }

        /**
         * è™•ç†ä¸‹åˆç°½é€€
         */
        async function handleAfternoonCheckOut() {
            await processSignAction('afternoonCheckOut');
        }

        /**
         * è™•ç†ç°½åˆ°/ç°½é€€çš„é€šç”¨é‚è¼¯ (æ›´æ–°ç‚ºä¸‰éšæ®µ)
         * @param {string} actionType 'morningCheckIn', 'afternoonCheckIn', or 'afternoonCheckOut'
         */
        async function processSignAction(actionType) {
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            const idNumber = signIdNumberInput.value.trim().toUpperCase();
            
            if (!idNumber) {
                displayMessage('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥é€²è¡Œæ“ä½œã€‚', 'error');
                return;
            }

            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                displayMessage('èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚', 'error');
                return;
            }
            
            // *** ä½¿ç”¨ç³»çµ±ç•¶å‰æ™‚é–“ ***
            const signDate = new Date();
            // ************************


            // å‹•æ…‹ç²å–æŒ‰éˆ•
            const button = document.getElementById(actionType + 'Button'); 
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'è™•ç†ä¸­...';
            
            try {
                // --- æ­¥é©Ÿ 1: æ ¹æ“šæ“ä½œé¡å‹è¨­å®šé©—è­‰åƒæ•¸ ---
                let startTime = null;
                let endTime = null;
                let actionName = '';
                let updateField = '';

                switch (actionType) {
                    case 'morningCheckIn':
                        startTime = morningCheckInStartTime;
                        endTime = morningCheckInEndTime;
                        actionName = 'ä¸Šåˆç°½åˆ°';
                        updateField = 'morningCheckInTime';
                        break;
                    case 'afternoonCheckIn':
                        startTime = afternoonCheckInStartTime;
                        endTime = afternoonCheckInEndTime;
                        actionName = 'ä¸‹åˆç°½åˆ°';
                        updateField = 'afternoonCheckInTime';
                        break;
                    case 'afternoonCheckOut':
                        startTime = afternoonCheckOutStartTime;
                        endTime = afternoonCheckOutEndTime;
                        actionName = 'ä¸‹åˆç°½é€€';
                        updateField = 'afternoonCheckOutTime';
                        break;
                    default:
                        displayMessage('ç„¡æ•ˆçš„æ“ä½œé¡å‹ã€‚', 'error');
                        return;
                }
                
                // æª¢æŸ¥é–‹æ”¾å€é–“
                if (startTime && endTime) {
                    if (signDate.getTime() < startTime.getTime() || signDate.getTime() > endTime.getTime()) {
                        const rangeStr = `${startTime.toLocaleString('zh-TW')} åˆ° ${endTime.toLocaleString('zh-TW')}`;
                        displayMessage(`${actionName}æœå‹™æœªåœ¨é–‹æ”¾å€é–“ï¼é–‹æ”¾æ™‚é–“ç‚º ${rangeStr}ã€‚`, 'error');
                        return;
                    }
                } else {
                    displayMessage(`è­¦å‘Šï¼šæœªè¨­å®š${actionName}é–‹æ”¾å€é–“ï¼Œå°‡å…è¨±æ“ä½œã€‚`, 'info');
                }

                // --- æ­¥é©Ÿ 2: æŸ¥æ‰¾å ±åç´€éŒ„ (ç¢ºèªæ­¤äººæ˜¯å¦å·²å ±åæˆåŠŸ) ---
                const q = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // åªæœ‰æˆåŠŸå ±åçš„äººæ‰èƒ½ç°½åˆ°/é€€
                    displayMessage('æŸ¥ç„¡æ­¤å ±åç´€éŒ„ï¼Œè«‹ç¢ºèªèº«ä»½è­‰å­—è™Ÿæ˜¯å¦æ­£ç¢ºã€‚', 'error');
                    return;
                }

                // æ‰¾åˆ°æ–‡ä»¶ (æ‡‰è©²åªæœ‰ä¸€å€‹)
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'registrations', snapshot.docs[0].id);
                const data = snapshot.docs[0].data();
                const updateData = {};
                
                // æª¢æŸ¥æ˜¯å¦é‡è¤‡æ“ä½œ
                if (data[updateField]) {
                    displayMessage(`æ‚¨å·²æ–¼ ${formatTimestamp(data[updateField])} å®Œæˆ${actionName}ï¼Œè«‹å‹¿é‡è¤‡æ“ä½œã€‚`, 'info');
                    return;
                }

                // --- æ­¥é©Ÿ 3: åŸ·è¡Œç°½åˆ°/ç°½é€€é‚è¼¯èˆ‡äº¤å‰é©—è­‰ ---

                if (actionType === 'morningCheckIn') {
                    // åƒ…æª¢æŸ¥é‡è¤‡ç°½åˆ° (å·²åœ¨ä¸Šé¢è™•ç†)
                    updateData[updateField] = signDate; 

                } else if (actionType === 'afternoonCheckIn') {
                    // é‚è¼¯: å¿…é ˆå…ˆå®Œæˆä¸Šåˆç°½åˆ°
                    if (!data.morningCheckInTime) {
                        displayMessage('æ‚¨å°šæœªå®Œæˆä¸Šåˆç°½åˆ°ï¼Œç„¡æ³•é€²è¡Œä¸‹åˆç°½åˆ°ã€‚', 'error');
                        return;
                    }
                    // é‚è¼¯: ä¸‹åˆç°½åˆ°æ™‚é–“å¿…é ˆæ™šæ–¼ä¸Šåˆç°½åˆ°æ™‚é–“
                    if (signDate.getTime() < data.morningCheckInTime.toDate().getTime()) {
                         displayMessage('ä¸‹åˆç°½åˆ°æ™‚é–“ä¸èƒ½æ—©æ–¼ä¸Šåˆç°½åˆ°æ™‚é–“ï¼', 'error');
                        return;
                    }

                    updateData[updateField] = signDate; 

                } else if (actionType === 'afternoonCheckOut') {
                    // é‚è¼¯: å¿…é ˆå…ˆå®Œæˆä¸‹åˆç°½åˆ°
                    if (!data.afternoonCheckInTime) {
                        displayMessage('æ‚¨å°šæœªå®Œæˆä¸‹åˆç°½åˆ°ï¼Œç„¡æ³•é€²è¡Œä¸‹åˆç°½é€€ã€‚', 'error');
                        return;
                    }
                    // é‚è¼¯: ä¸‹åˆç°½é€€æ™‚é–“å¿…é ˆæ™šæ–¼ä¸‹åˆç°½åˆ°æ™‚é–“
                    if (signDate.getTime() < data.afternoonCheckInTime.toDate().getTime()) {
                         displayMessage('ä¸‹åˆç°½é€€æ™‚é–“ä¸èƒ½æ—©æ–¼ä¸‹åˆç°½åˆ°æ™‚é–“ï¼', 'error');
                        return;
                    }

                    updateData[updateField] = signDate;
                }

                await updateDoc(docRef, updateData);
                signIdNumberInput.value = ''; // æ¸…ç©ºèº«ä»½è­‰å­—è™Ÿè¼¸å…¥æ¡†
                
                // *** ç°½åˆ°/ç°½é€€æˆåŠŸå¾Œé¡¯ç¤ºå½ˆçª— ***
                showSignSuccessModal('æ“ä½œæˆåŠŸ', `${actionName}æˆåŠŸï¼æ‚¨å·²å®Œæˆæœ¬æ¬¡æ“ä½œã€‚`);
                
            } catch (error) {
                console.error(`è™•ç† ${actionType} å¤±æ•—:`, error);
                displayMessage(`è™•ç†å¤±æ•—: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // --- å¾Œå°ç®¡ç†æ“ä½œ (NEW) ---

        /**
         * è™•ç†é»æ“Šã€Œé€²å…¥ç³»çµ±ã€æŒ‰éˆ•
         */
        function handleAccessBackend() {
            if (!isAuthReady) return;
            
            // æ¯æ¬¡é»æ“Šéƒ½é‡è¨­å¯†ç¢¼é©—è­‰ç‹€æ…‹
            backendContent.classList.add('hidden');
            backendPasswordInput.value = '';
            backendAccessError.classList.add('hidden');
            
            // é¡¯ç¤ºå¯†ç¢¼é©—è­‰å€å¡Š
            passwordSection.classList.remove('hidden');
            accessBackendButton.disabled = true;
            backendInfoText.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°ç®¡ç†ä»‹é¢ã€‚';
            backendPasswordInput.focus();
        }

        /**
         * è™•ç†ç¢ºèªå¾Œå°å­˜å–å¯†ç¢¼
         */
        function handleConfirmBackendAccess() {
            const enteredPassword = backendPasswordInput.value;

            if (enteredPassword !== EXPORT_PASSWORD) {
                // å¯†ç¢¼éŒ¯èª¤
                backendPasswordInput.value = '';
                backendAccessError.classList.remove('hidden');
                backendPasswordInput.focus();
                displayMessage('å¾Œå°å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
                return;
            }

            // å¯†ç¢¼æ­£ç¢º
            passwordSection.classList.add('hidden'); // éš±è—å¯†ç¢¼å€å¡Š
            accessBackendButton.classList.add('hidden'); // éš±è—é€²å…¥ç³»çµ±æŒ‰éˆ•
            backendContent.classList.remove('hidden'); // é¡¯ç¤ºå¾Œå°å…§å®¹
            backendInfoText.textContent = 'æ‚¨å·²é€²å…¥å¾Œå°ç®¡ç†æ¨¡å¼ã€‚';
            
            // ç”±æ–¼ onSnapshot æ˜¯ç•°æ­¥çš„ï¼Œé€™è£¡å…ˆè¨­ç½®è¼‰å…¥ç‹€æ…‹
            registrationsListContainer.innerHTML = '<p class="p-4 text-center text-sky-500 font-bold animate-pulse">ğŸ”” æ­£åœ¨å•Ÿå‹•å³æ™‚ç›£è½ä¸¦è¼‰å…¥è³‡æ–™...</p>';

            isBackendAccessed = true;
            setupBackendListener(); // å•Ÿå‹•å³æ™‚ç›£è½æ¸…å–®
            
            displayMessage('å¾Œå°å­˜å–æˆåŠŸï¼æ­£åœ¨è¼‰å…¥è³‡æ–™æ¸…å–®ã€‚', 'success');
        }


        /**
         * è™•ç†æ¸…ç©ºå ±åè³‡æ–™ (äºŒæ¬¡ç¢ºèªå¾ŒåŸ·è¡Œ)
         */
        async function deleteAllRegistrations() {
            if (!isAuthReady || !db) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œç„¡æ³•åŸ·è¡Œæ¸…ç©ºæ“ä½œã€‚', 'error');
                return;
            }
            
            hideConfirmModal(); // éš±è—ç¢ºèªå½ˆçª—
            displayMessage('æ­£åœ¨æ¸…ç©ºæ‰€æœ‰å ±åè³‡æ–™... è«‹å‹¿é—œé–‰è¦–çª—ã€‚', 'error', 0);

            try {
                const q = query(getRegistrationsCollectionRef());
                const snapshot = await getDocs(q);
                let deleteCount = 0;
                
                // é€ä¸€åˆªé™¤æ–‡ä»¶
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                    deleteCount++;
                });
                
                await Promise.all(deletePromises);
                
                displayMessage(`å·²æˆåŠŸæ¸…ç©º ${deleteCount} ç­†å ±åç´€éŒ„ï¼`, 'success');

            } catch (error) {
                console.error("æ¸…ç©ºè³‡æ–™å¤±æ•—:", error);
                displayMessage(`æ¸…ç©ºè³‡æ–™å¤±æ•—: ${error.message}`, 'error');
            }
        }


        /**
         * å¾ Firestore æŠ“å–æ‰€æœ‰å ±åè³‡æ–™ä¸¦åŒ¯å‡ºç‚º CSVã€‚
         */
        async function fetchDataAndExportToCsv() {
            if (!isAuthReady || !db || !isBackendAccessed) {
                displayMessage('è«‹å…ˆé€²å…¥å¾Œå°ç³»çµ±ã€‚', 'error');
                return;
            }
            
            exportCsvButton.disabled = true;
            exportCsvButton.textContent = 'ç²å–è³‡æ–™ä¸­...';
            displayMessage('æ­£åœ¨å¾è³‡æ–™åº«ç²å–è³‡æ–™...', 'info');

            try {
                // **MODIFIED: ç§»é™¤ orderBy**
                const q = query(getRegistrationsCollectionRef()); 

                const snapshot = await getDocs(q);
                const registrations = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // ç²å–åŸå§‹è³‡æ–™ï¼ŒåŒ…å«ç°½åˆ°ç°½é€€æ™‚é–“
                    registrations.push({ 
                        school: data.school,
                        name: data.name,
                        id_number: data.id_number, 
                        timestamp: data.timestamp,
                        morningCheckInTime: data.morningCheckInTime || null, // NEW
                        afternoonCheckInTime: data.afternoonCheckInTime || null, // NEW
                        afternoonCheckOutTime: data.afternoonCheckOutTime || null, // NEW
                        registeredBy: data.registeredBy
                    });
                });
                
                // åŸ·è¡Œä¸‹è¼‰
                performCsvDownload(registrations);

            } catch (error) {
                console.error("ç²å–è³‡æ–™å¤±æ•—:", error);
                displayMessage(`åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            } finally {
                 exportCsvButton.disabled = false;
                 exportCsvButton.textContent = 'åŒ¯å‡º CSV';
            }
        }
        
        /**
         * å°‡è³‡æ–™è½‰æ›ç‚º CSV ä¸¦è§¸ç™¼ä¸‹è¼‰
         * @param {Array<object>} registrations å ±åè³‡æ–™é™£åˆ—
         */
        function performCsvDownload(registrations) {
            if (registrations.length === 0) {
                displayMessage('è³‡æ–™åº«ä¸­æ²’æœ‰å ±åç´€éŒ„å¯ä¾›åŒ¯å‡ºã€‚', 'error');
                return;
            }

            // æ›´æ–° CSV æ¨™é ­
            const headers = [
                "å ±åæ™‚é–“", "å­¸æ ¡", "å§“å", "èº«ä»½è­‰å­—è™Ÿ", 
                "æ˜¯å¦ä¸Šåˆç°½åˆ°", "ä¸Šåˆç°½åˆ°æ™‚é–“", 
                "æ˜¯å¦ä¸‹åˆç°½åˆ°", "ä¸‹åˆç°½åˆ°æ™‚é–“", 
                "æ˜¯å¦ä¸‹åˆç°½é€€", "ä¸‹åˆç°½é€€æ™‚é–“", 
                "è¨»å†Šè€…ID"
            ];
            
            // ç²å–ä¸¦æ ¼å¼åŒ–è¡Œæ•¸æ“š
            const rows = registrations.map(reg => {
                const registrationTime = formatTimestamp(reg.timestamp);
                
                const morningCheckInTimeStr = formatTimestamp(reg.morningCheckInTime);
                const afternoonCheckInTimeStr = formatTimestamp(reg.afternoonCheckInTime);
                const afternoonCheckOutTimeStr = formatTimestamp(reg.afternoonCheckOutTime);
                
                // æ–°å¢ï¼šæ˜¯å¦ç°½åˆ°/ç°½é€€çš„è¨»è¨˜
                const isMorningCheckedIn = reg.morningCheckInTime ? 'æ˜¯' : 'å¦';
                const isAfternoonCheckedIn = reg.afternoonCheckInTime ? 'æ˜¯' : 'å¦';
                const isAfternoonCheckedOut = reg.afternoonCheckOutTime ? 'æ˜¯' : 'å¦';


                // ä½¿ç”¨ JSON.stringify ä¸¦æ›¿æ›æ‰å¼•è™Ÿï¼Œä»¥æ­£ç¢ºè™•ç†åŒ…å«é€—è™Ÿçš„å­—ä¸²
                const cleanAndQuote = (str) => `"${String(str).replace(/"/g, '""')}"`;
                
                return [
                    cleanAndQuote(registrationTime),
                    cleanAndQuote(reg.school || ''),
                    cleanAndQuote(reg.name || ''),
                    cleanAndQuote(reg.id_number || ''),
                    
                    cleanAndQuote(isMorningCheckedIn),      
                    cleanAndQuote(morningCheckInTimeStr),   
                    
                    cleanAndQuote(isAfternoonCheckedIn),    
                    cleanAndQuote(afternoonCheckInTimeStr), 

                    cleanAndQuote(isAfternoonCheckedOut),   
                    cleanAndQuote(afternoonCheckOutTimeStr),

                    cleanAndQuote(reg.registeredBy || '')
                ];
            });

            // çµåˆæ¨™é ­å’Œè¡Œæ•¸æ“š
            const csvContent = [
                headers.join(','), // æ¨™é ­
                ...rows.map(e => e.join(',')) // è¡Œæ•¸æ“š
            ].join('\n');

            // è§¸ç™¼ä¸‹è¼‰
            // "\ufeff" æ˜¯ BOMï¼Œç¢ºä¿ä¸­æ–‡åœ¨ Excel ä¸­æ­£ç¢ºé¡¯ç¤º
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            const now = new Date();
            const fileName = `ç ”ç¿’å ±åæ¸…å–®_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.csv`;
            
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            displayMessage('å ±åæ¸…å–®å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆï¼', 'success');
        }


        // --- äº‹ä»¶ç›£è½å™¨å’Œå•Ÿå‹• ---
        
        form.addEventListener('submit', handleFormSubmit);
        
        // å¾Œå°é€²å…¥èˆ‡æ“ä½œ
        accessBackendButton.addEventListener('click', handleAccessBackend); // é»æ“Šé€²å…¥ç³»çµ±
        confirmBackendAccessButton.addEventListener('click', handleConfirmBackendAccess); // ç¢ºèªå¯†ç¢¼
        exportCsvButton.addEventListener('click', fetchDataAndExportToCsv); // åŒ¯å‡º CSV (å·²é€²å…¥å¾Œå°ï¼Œç„¡éœ€å†æ¬¡å¯†ç¢¼)
        
        // æ¸…ç©ºè³‡æ–™ (éœ€è¦äºŒæ¬¡ç¢ºèªï¼Œæ‰€ä»¥åªè§¸ç™¼å½ˆçª—)
        clearDataButton.addEventListener('click', () => {
             showConfirmModal('æ¸…ç©ºç¢ºèª', 'æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±åç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼');
        }); 
        
        // äºŒæ¬¡ç¢ºèªå½ˆçª—æŒ‰éˆ•
        cancelConfirmButton.addEventListener('click', hideConfirmModal); // å–æ¶ˆæ¸…ç©º
        executeConfirmButton.addEventListener('click', deleteAllRegistrations); // ç¢ºå®šæ¸…ç©º 

        // ç°½åˆ°/ç°½é€€åŠŸèƒ½
        morningCheckInButton.addEventListener('click', handleMorningCheckIn);
        afternoonCheckInButton.addEventListener('click', handleAfternoonCheckIn);
        afternoonCheckOutButton.addEventListener('click', handleAfternoonCheckOut);
        
        // ç³»çµ±è¨­å®šåŠŸèƒ½
        toggleSettingsButton.addEventListener('click', handleToggleSettings); // é»æ“Šé¡¯ç¤º/éš±è—è¨­å®šå€å¡Š
        confirmSettingsAccessButton.addEventListener('click', handleConfirmSettingsAccess); // å¯†ç¢¼é©—è­‰å­˜å–
        saveSettingsButton.addEventListener('click', handleSaveSettings); // å„²å­˜è¨­å®šäº‹ä»¶

        // å½ˆçª—é—œé–‰
        closeModalButton.addEventListener('click', hideSuccessModal);
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideSuccessModal(); // é»æ“ŠèƒŒæ™¯å€åŸŸä¹Ÿé—œé–‰
            }
        });
        
        // ç°½åˆ°/ç°½é€€å½ˆçª—é—œé–‰
        closeSignModalButton.addEventListener('click', hideSignSuccessModal);
        signSuccessModal.addEventListener('click', (e) => {
            if (e.target === signSuccessModal) {
                hideSignSuccessModal();
            }
        });

        // å ±åéŒ¯èª¤å½ˆçª—é—œé–‰
        closeErrorModalButton.addEventListener('click', hideErrorModal);
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                hideErrorModal();
            }
        });
        
        // æ¸…ç©ºç¢ºèªå½ˆçª—é—œé–‰
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                hideConfirmModal();
            }
        });


        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeFirebase();

    </script>
</body>
</html>