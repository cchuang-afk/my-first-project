<!DOCTYPE html>
<!-- saved from url=(0047)https://cchuang-afk.github.io/my-first-project/ -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜é›„å¸‚å­¸æ ¡è­·ç†äººå“¡ç¹¼çºŒæ•™è‚²ç ”ç¿’èª²ç¨‹å ±åç¶²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä½œç‚ºä¸»è¦å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* ä¸»æ¨™é¡Œæ¨£å¼ */
        .main-header {
            background-color: #0ea5e9; /* Sky 500 */
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* å½ˆçª—èƒŒæ™¯å±¤çš„å‹•ç•«æ•ˆæœ */
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        /* å½ˆçª—å…§å®¹çš„å‹•ç•«æ•ˆæœ */
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-50px);
            opacity: 0;
        }
        .modal-open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* å¾Œå°æ¸…å–®è¡¨æ ¼æ¨£å¼ (é›–ç„¶å·²ç§»é™¤æ¸…å–®åŠŸèƒ½ï¼Œä½†ä¿ç•™æ¨£å¼å®šç¾©) */
        .backend-table th, .backend-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            text-align: left;
        }
        .backend-table th {
            background-color: #e5e7eb; /* Gray 200 */
            font-weight: 600;
            color: #374151; /* Gray 700 */
            text-transform: none;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ -->
    <div class="min-h-screen flex flex-col items-center">
        <!-- å›ºå®šé ‚éƒ¨æ¨™é¡Œæ¬„ -->
        <header class="main-header w-full">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">é«˜é›„å¸‚å­¸æ ¡è­·ç†äººå“¡ç¹¼çºŒæ•™è‚²ç ”ç¿’èª²ç¨‹å ±åç¶²</h1>
                <p class="text-sky-100 mt-1 text-lg">è«‹å¡«å¯«æ‚¨çš„å ±åè³‡è¨Š</p>
            </div>
        </header>

        <main class="w-full max-w-4xl p-4 sm:p-8">
            
            <!-- Firebase ç‹€æ…‹/éŒ¯èª¤è¨Šæ¯ -->
            <div id="statusMessage" class="w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300">ç³»çµ±æº–å‚™å°±ç·’ã€‚</div>

            <!-- å ±åè¡¨å–®å€å¡Š -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">å ±åè¡¨å–®</h2>

                <form id="registrationForm" class="space-y-4">
                    
                    <!-- å­¸æ ¡æ¬„ä½ -->
                    <div>
                        <label for="school" class="block text-sm font-medium text-gray-700 mb-1">å­¸æ ¡ (School)</label>
                        <input type="text" id="school" name="school" placeholder="è«‹è¼¸å…¥å­¸æ ¡åç¨±" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- å§“åæ¬„ä½ -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">å§“å (Name)</label>
                        <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ -->
                    <div>
                        <label for="id_number" class="block text-sm font-medium text-gray-700 mb-1">èº«ä»½è­‰å­—è™Ÿ (ID Number)</label>
                        <input type="text" id="id_number" name="id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿ (ä¾‹å¦‚: A123456789)" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 uppercase">
                        <p class="mt-1 text-xs text-gray-500">æ ¼å¼: 1ä½å¤§å¯«è‹±æ–‡å­—æ¯ + 9ä½æ•¸å­—</p>
                    </div>

                    <!-- æ‰‹æ©Ÿè™Ÿç¢¼æ¬„ä½ -->
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æ©Ÿ (Phone Number)</label>
                        <input type="tel" id="phone" name="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (ä¾‹å¦‚: 0912345678)" required="" maxlength="10" pattern="[0-9]{10}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                        <p class="mt-1 text-xs text-gray-500">æ ¼å¼: 10ä½æ•¸å­— (ä¾‹å¦‚ 09xxxxxxxx)</p>
                    </div>
                    
                    <!-- ä¸­åˆé¤é» -->
                    <div>
                        <label for="meal" class="block text-sm font-medium text-gray-700 mb-1">ä¸­åˆé¤é» (Meal)</label>
                        <select id="meal" name="meal" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                            <option value="è‘·é£Ÿ">è‘·é£Ÿ</option>
                            <option value="ç´ é£Ÿ">ç´ é£Ÿ</option>
                        </select>
                    </div>

                    <!-- æƒ³è«‹æ•™è¬›å¸«å•é¡Œ (é¸å¡«) -->
                    <div>
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1">æƒ³è«‹æ•™è¬›å¸«å•é¡Œ (Question) (é¸å¡«)</label>
                        <textarea id="question" name="question" placeholder="è«‹è©³ç´°å…·é«”èªªæ˜æ‚¨æƒ³è«‹æ•™è¬›å¸«çš„å•é¡Œ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 h-24"></textarea>
                    </div>
                    
                    <!-- æäº¤æŒ‰éˆ• -->
                    <button type="submit" id="submitButton" class="w-full bg-sky-600 text-white py-3 mt-6 rounded-xl font-semibold hover:bg-sky-700 transition duration-200 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50">
                        ç«‹å³å ±å
                    </button>
                </form>
            </div>

            <!-- ç ”ç¿’æ´»å‹•ç°½åˆ°å€å¡Š -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">ç ”ç¿’æ´»å‹•ç°½åˆ°</h2>

                <div class="space-y-4">
                    <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ for Sign-In/Out -->
                    <div>
                        <label for="sign_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            ç°½åˆ°/ç°½é€€èº«ä»½è­‰å­—è™Ÿ (ID Number)
                        </label>
                        <input type="text" id="sign_id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿé€²è¡Œç°½åˆ°æˆ–ç°½é€€" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 uppercase">
                    </div>
                    
                    <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 pt-2">
                        <!-- ä¸Šåˆç°½åˆ°æŒ‰éˆ• (å·²ç§»é™¤: (ç ”ç¿’å…©å¤©)) -->
                        <button id="morningCheckInButton" type="button" class="w-full sm:w-1/3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50">
                            ä¸Šåˆç°½åˆ°
                        </button>
                        <!-- ä¸‹åˆç°½åˆ°æŒ‰éˆ• (å·²ç§»é™¤: (ç ”ç¿’å…©å¤©)) -->
                        <button id="afternoonCheckInButton" type="button" class="w-full sm:w-1/3 bg-yellow-600 text-white py-3 rounded-xl font-semibold hover:bg-yellow-700 transition duration-200 shadow-md disabled:opacity-50">
                            ä¸‹åˆç°½åˆ°
                        </button>
                        <!-- ä¸‹åˆç°½é€€æŒ‰éˆ• (å·²ç§»é™¤: (ç ”ç¿’å…©å¤©)) -->
                        <button id="afternoonCheckOutButton" type="button" class="w-full sm:w-1/3 bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition duration-200 shadow-md disabled:opacity-50">
                            ä¸‹åˆç°½é€€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ»¿æ„åº¦èª¿æŸ¥ç¨‹å¼å€å¡Š (NEW) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">æ»¿æ„åº¦èª¿æŸ¥ç¨‹å¼å€å¡Š</h2>

                <div class="space-y-4">
                    <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ for Survey Access -->
                    <div>
                        <label for="survey_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            èº«ä»½è­‰å­—è™Ÿ (ID Number)
                        </label>
                        <input type="text" id="survey_id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥å¡«å¯«å•å·" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 uppercase">
                    </div>

                    <!-- é€²å…¥å¡«å¯«æŒ‰éˆ• -->
                    <button id="enterSurveyButton" type="button" class="w-full bg-green-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-green-600 transition duration-200 shadow-lg disabled:opacity-50">
                        é€²å…¥å¡«å¯«æ»¿æ„åº¦èª¿æŸ¥è¡¨
                    </button>
                </div>
            </div>
            
            <!-- å–æ¶ˆå ±åå€å¡Š -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">å–æ¶ˆå ±å</h2>

                <div class="space-y-4">
                    <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ for å–æ¶ˆ -->
                    <div>
                        <label for="cancel_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            æ¬²å–æ¶ˆå ±åè€…çš„èº«ä»½è­‰å­—è™Ÿ (ID Number)
                        </label>
                        <input type="text" id="cancel_id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥å–æ¶ˆå ±å" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150 uppercase">
                    </div>

                    <!-- å–æ¶ˆæŒ‰éˆ• -->
                    <button id="cancelRegistrationButton" type="button" class="w-full bg-red-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-red-600 transition duration-200 shadow-lg disabled:opacity-50">
                        ç¢ºå®šå–æ¶ˆå ±å
                    </button>
                </div>
            </div>

            <!-- å­¸åˆ†æŸ¥è©¢å€å¡Š (NEW) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">å­¸åˆ†æŸ¥è©¢ <span class="text-sm font-normal text-gray-500">(æŸ¥è©¢é–‹æ”¾æ™‚é–“å°‡å¦è¡Œå…¬å¸ƒ)</span></h2>

                <div class="space-y-4">
                    <!-- èº«ä»½è­‰å­—è™Ÿæ¬„ä½ for æŸ¥è©¢ -->
                    <div>
                        <label for="query_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            èº«ä»½è­‰å­—è™Ÿ (ID Number)
                        </label>
                        <input type="text" id="query_id_number" placeholder="è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥æŸ¥è©¢å­¸åˆ†ç‹€æ…‹" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 uppercase">
                    </div>

                    <!-- æŸ¥è©¢æŒ‰éˆ• -->
                    <button id="creditQueryButton" type="button" class="w-full bg-purple-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-purple-600 transition duration-200 shadow-lg disabled:opacity-50">
                        æŸ¥è©¢å­¸åˆ†ç”³è«‹ç‹€æ…‹
                    </button>
                </div>
            </div>
            
            <!-- ç³»çµ±è¨­å®šå€å¡Š (æ›´æ–°ç‚ºå¯†ç¢¼æ§ç®¡é¡¯ç¤º) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-700">æ™‚é–“ç°½åˆ°è¨­å®š</h2>

                    <!-- 1. é¡¯ç¤º/éš±è— æŒ‰éˆ• (æ¨£å¼å·²èª¿æ•´ç‚ºèˆ‡åŒ¯å‡ºæŒ‰éˆ•ç›¸è¿‘) -->
                    <button id="toggleSettingsButton" type="button" class="px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                        è¨­å®šæ™‚é–“
                    </button>
                </div>
                
                <p class="mt-4 text-gray-500 text-sm">
                    é»æ“ŠæŒ‰éˆ•å¾Œè¼¸å…¥å¯†ç¢¼ï¼Œå³å¯è¨­å®šç°½åˆ°/ç°½é€€çš„é–‹æ”¾æ™‚é–“å€é–“ã€‚
                </p>

                <!-- 2. å¯†ç¢¼é©—è­‰å€å¡Š (é è¨­éš±è—) -->
                <div id="settingsAccessSection" class="hidden p-4 mt-4 bg-yellow-50 border border-yellow-300 rounded-xl shadow-inner">
                    <label for="settingsAccessPassword" class="block text-sm font-medium text-yellow-700 mb-2">
                        <span class="font-bold">ğŸ”’ å¯†ç¢¼é©—è­‰ï¼š</span> è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–è¨­å®šã€‚
                    </label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="settingsAccessPassword" placeholder="è¼¸å…¥å¯†ç¢¼..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
                        <button id="confirmSettingsAccessButton" type="button" class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                            ç¢ºèªå­˜å–
                        </button>
                    </div>
                    <p id="accessError" class="text-red-600 text-xs mt-2 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚</p>
                </div>
                
                <!-- 3. æ™‚é–“è¨­å®šè¼¸å…¥å€å¡Š (é è¨­éš±è—ï¼Œé©—è­‰æˆåŠŸå¾Œé¡¯ç¤º) -->
                <div class="space-y-4 hidden mt-4" id="settingsInputsContainer">
                    
                    <!-- ä¸Šåˆç°½åˆ°æ™‚é–“å€é–“è¨­å®š -->
                    <div class="space-y-2 border-b pb-4 border-amber-100">
                        <label class="block text-sm font-bold text-gray-700">ä¸Šåˆç°½åˆ°é–‹æ”¾å€é–“ (Morning Check-in Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_morning_ci_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                <input type="datetime-local" id="setting_morning_ci_start" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_morning_ci_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                                <input type="datetime-local" id="setting_morning_ci_end" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‹åˆç°½åˆ°æ™‚é–“å€é–“è¨­å®š -->
                    <div class="space-y-2 border-b pb-4 border-amber-100">
                        <label class="block text-sm font-bold text-gray-700">ä¸‹åˆç°½åˆ°é–‹æ”¾å€é–“ (Afternoon Check-in Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_afternoon_ci_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                <input type="datetime-local" id="setting_afternoon_ci_start" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_afternoon_ci_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                                <input type="datetime-local" id="setting_afternoon_ci_end" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸‹åˆç°½é€€æ™‚é–“å€é–“è¨­å®š -->
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">ä¸‹åˆç°½é€€é–‹æ”¾å€é–“ (Afternoon Check-out Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_afternoon_co_start" class="block text-xs font-medium text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                <input type="datetime-local" id="setting_afternoon_co_start" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_afternoon_co_end" class="block text-xs font-medium text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                                <input type="datetime-local" id="setting_afternoon_co_end" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>

                    <!-- å„²å­˜/é‚„åŸæŒ‰éˆ•å€å¡Š -->
                    <div id="settingsSaveSection" class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner space-y-2">
                        <label class="block text-sm font-medium text-yellow-700 mb-2">
                            <span class="font-bold">ğŸ’¾ è¨­å®šæ“ä½œï¼š</span> å„²å­˜æˆ–é‚„åŸæ™‚é–“å€é–“ã€‚
                        </label>
                        <button id="saveSettingsButton" type="button" class="w-full px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                            å„²å­˜è¨­å®š
                        </button>
                        <button id="resetTimeSettingsButton" type="button" class="w-full px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-lg hover:bg-gray-600 transition duration-150 shadow-md disabled:opacity-50">
                            é‚„åŸæ™‚é–“è¨­å®š (è‡³é è¨­å€¼)
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¾Œå°è³‡æ–™æ“ä½œå€å¡Š -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700 whitespace-nowrap">å¾Œå°è³‡æ–™æ“ä½œ</h2>
                    
                    <!-- é€²å…¥ç³»çµ±æŒ‰éˆ• (é è¨­é¡¯ç¤º) -->
                    <button id="accessBackendButton" type="button" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50">
                        é€²å…¥ç³»çµ±
                    </button>
                </div>
                
                <!-- å¯†ç¢¼è¼¸å…¥å€å¡Š (é€šç”¨) -->
                <div id="passwordSection" class="hidden p-4 mt-4 bg-gray-50 border border-red-300 rounded-lg shadow-inner">
                    <label for="backendPassword" class="block text-sm font-medium text-red-700 mb-2">
                        <span class="font-bold">ğŸ”’ å¯†ç¢¼é©—è­‰ï¼š</span> è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°ã€‚
                    </label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="backendPassword" placeholder="è¼¸å…¥å¯†ç¢¼..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                        <button id="confirmBackendAccessButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                            ç¢ºèªé€²å…¥
                        </button>
                    </div>
                    <p id="backendAccessError" class="text-red-600 text-xs mt-2 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚</p>
                </div>

                <!-- å¾Œå°åŠŸèƒ½å’Œæ¸…å–®å€å¡Š (é è¨­éš±è—) -->
                <div id="backendContent" class="hidden space-y-6 mt-6 pt-4 border-t border-gray-200">
                    
                    <h3 class="text-xl font-semibold text-gray-700">æ“ä½œæŒ‰éˆ•</h3>
                    <div class="flex flex-wrap space-x-2 w-full justify-start mb-6">
                        <!-- åŒ¯å‡º CSV æŒ‰éˆ• -->
                        <button id="exportCsvButton" type="button" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            åŒ¯å‡º CSV
                        </button>
                        <!-- æ¸…ç©ºå ±åè³‡æ–™æŒ‰éˆ• -->
                        <button id="clearDataButton" type="button" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            æ¸…ç©ºå ±åè³‡æ–™
                        </button>
                         <!-- æ¸…é™¤ç°½åˆ°/ç°½é€€æŒ‰éˆ• (NEW) -->
                        <button id="clearSignaturesButton" type="button" class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            æ¸…é™¤ç°½åˆ°/ç°½é€€
                        </button>
                        <!-- æ–°å¢æœƒå“¡æŒ‰éˆ• (NEW) -->
                        <button id="addMemberButton" type="button" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            æ–°å¢æœƒå“¡
                        </button>
                    </div>

                    
                    <!-- å ±åæ¸…å–®å€å¡Š (å·²ç§»é™¤) -->
                    <div id="registrationsListContainer" class="overflow-x-auto shadow-inner rounded-lg border">
                        <p class="p-4 text-center text-gray-500">æ¸…å–®åŠŸèƒ½å·²ç§»é™¤ã€‚è«‹ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•åŒ¯å‡ºè³‡æ–™ã€‚</p>
                    </div>
                </div>

                <p id="backendInfoText" class="mt-4 text-gray-500 text-sm">
                    é»æ“Šã€Œé€²å…¥ç³»çµ±ã€ä¸¦è¼¸å…¥å¯†ç¢¼ä»¥æŸ¥çœ‹å ±åè€…æ¸…å–®åŠç®¡ç†è³‡æ–™ã€‚
                </p>
            </div>
        </main>

        <!-- é¡¯ç¤º User ID ä¾›å”ä½œç”¨é€” -->
        <p class="mt-4 text-xs text-gray-400">
            <span class="font-semibold">ç•¶å‰ä½¿ç”¨è€… ID:</span> <span id="currentUserId">xBTc5FIiWfWsbpCRNKEe0cphQbS2</span>
        </p>

    </div>

    <!-- æ»¿æ„åº¦èª¿æŸ¥å½ˆçª— (Modal) -->
    <div id="surveyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-2xl p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-green-500">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ç ”ç¿’æ»¿æ„åº¦èª¿æŸ¥è¡¨</h3>
            <p id="surveyUserDisplay" class="text-lg font-semibold text-green-700 mb-6">å¡«å¯«äºº: N/A</p>

            <form id="surveyForm" class="space-y-6 text-left">
                <input type="hidden" id="surveyHiddenIdNumber" name="surveyHiddenIdNumber">
                
                <!-- é¡Œç›® 1-5 (Radio Buttons) -->
                <div id="surveyQuestionsContainer" class="space-y-4">
                    <!-- Q1 -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-800 mb-2">1. å°æ–¼æœ¬èª²ç¨‹å…§å®¹æ‡‰ç”¨æ–¼å¯¦éš›å·¥ä½œæ„Ÿåˆ°æ»¿æ„åº¦</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600" data-question="q1">
                            <label class="flex items-center space-x-1"><input type="radio" name="q1" value="éå¸¸æ»¿æ„" required="" class="text-green-600"><span>éå¸¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q1" value="æ»¿æ„" class="text-green-600"><span>æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q1" value="æ™®é€š" class="text-green-600"><span>æ™®é€š</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q1" value="ä¸æ»¿æ„" class="text-green-600"><span>ä¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q1" value="éå¸¸ä¸æ»¿æ„" class="text-green-600"><span>éå¸¸ä¸æ»¿æ„</span></label>
                        </div>
                    </div>
                    <!-- Q2 -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-800 mb-2">2. æœ¬æ¬¡èª²ç¨‹è¬›å¸«å°èª²ç¨‹ä¸»é¡Œä¹‹å°ˆæ¥­èƒ½åŠ›</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600" data-question="q2">
                            <label class="flex items-center space-x-1"><input type="radio" name="q2" value="éå¸¸æ»¿æ„" required="" class="text-green-600"><span>éå¸¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q2" value="æ»¿æ„" class="text-green-600"><span>æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q2" value="æ™®é€š" class="text-green-600"><span>æ™®é€š</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q2" value="ä¸æ»¿æ„" class="text-green-600"><span>ä¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q2" value="éå¸¸ä¸æ»¿æ„" class="text-green-600"><span>éå¸¸ä¸æ»¿æ„</span></label>
                        </div>
                    </div>
                    <!-- Q3 -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-800 mb-2">3. æœ¬æ¬¡èª²ç¨‹èƒ½æä¾›é©ç•¶ç¯„ä¾‹èˆ‡å¯¦å‹™èªªæ˜</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600" data-question="q3">
                            <label class="flex items-center space-x-1"><input type="radio" name="q3" value="éå¸¸æ»¿æ„" required="" class="text-green-600"><span>éå¸¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q3" value="æ»¿æ„" class="text-green-600"><span>æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q3" value="æ™®é€š" class="text-green-600"><span>æ™®é€š</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q3" value="ä¸æ»¿æ„" class="text-green-600"><span>ä¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q3" value="éå¸¸ä¸æ»¿æ„" class="text-green-600"><span>éå¸¸ä¸æ»¿æ„</span></label>
                        </div>
                    </div>
                    <!-- Q4 -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-800 mb-2">4. æœ¬æ¬¡èª²ç¨‹å®Œæ•´ä¸”å®¹æ˜“å¸æ”¶</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600" data-question="q4">
                            <label class="flex items-center space-x-1"><input type="radio" name="q4" value="éå¸¸æ»¿æ„" required="" class="text-green-600"><span>éå¸¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q4" value="æ»¿æ„" class="text-green-600"><span>æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q4" value="æ™®é€š" class="text-green-600"><span>æ™®é€š</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q4" value="ä¸æ»¿æ„" class="text-green-600"><span>ä¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q4" value="éå¸¸ä¸æ»¿æ„" class="text-green-600"><span>éå¸¸ä¸æ»¿æ„</span></label>
                        </div>
                    </div>
                    <!-- Q5 -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-800 mb-2">5. æœ¬æ¬¡èª²ç¨‹ç¸½è©•åƒ¹</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600" data-question="q5">
                            <label class="flex items-center space-x-1"><input type="radio" name="q5" value="éå¸¸æ»¿æ„" required="" class="text-green-600"><span>éå¸¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q5" value="æ»¿æ„" class="text-green-600"><span>æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q5" value="æ™®é€š" class="text-green-600"><span>æ™®é€š</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q5" value="ä¸æ»¿æ„" class="text-green-600"><span>ä¸æ»¿æ„</span></label>
                            <label class="flex items-center space-x-1"><input type="radio" name="q5" value="éå¸¸ä¸æ»¿æ„" class="text-green-600"><span>éå¸¸ä¸æ»¿æ„</span></label>
                        </div>
                    </div>
                </div>

                <!-- é¡Œç›® 6 (Textarea) -->
                <div>
                    <label for="q6" class="block text-sm font-medium text-gray-700 mb-1">6. å…¶ä»–å»ºè­°äº‹é … (é¸å¡«)</label>
                    <textarea id="q6" name="q6" placeholder="è«‹è¼¸å…¥ä»»ä½•å»ºè­°æˆ–æ„è¦‹" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 h-28"></textarea>
                </div>
                
                <!-- æäº¤æŒ‰éˆ• -->
                <button type="submit" id="submitSurveyButton" class="w-full bg-green-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-green-600 transition duration-200 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50">
                    é€å‡ºå•å·
                </button>
                <button type="button" id="closeSurveyFormButton" class="w-full bg-gray-300 text-gray-700 py-3 mt-2 rounded-xl font-semibold hover:bg-gray-400 transition duration-200">
                    å–æ¶ˆå¡«å¯«
                </button>
            </form>
        </div>
    </div>

    <!-- éæœƒå“¡å ±åéŒ¯èª¤å½ˆçª— (Modal) -->
    <div id="errorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-500">
            
            <!-- éŒ¯èª¤åœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.302 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="errorTitle">å ±åå¤±æ•—</h3>
            <p class="text-gray-600 mb-6" id="errorMessage">æ‚¨éæœƒå“¡ç„¡æ³•å ±åï¼Œè«‹æ´½æœƒå“¡çµ„</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeErrorModalButton" type="button" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>

    <!-- ç°½åˆ°/ç°½é€€æˆåŠŸå½ˆçª— (Modal) -->
    <div id="signSuccessModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- æˆåŠŸåœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-sky-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="signSuccessTitle">æ“ä½œæˆåŠŸï¼</h3>
            <p class="text-gray-600 mb-6" id="signSuccessMessage">æ‚¨å·²æˆåŠŸå®Œæˆç°½åˆ°/ç°½é€€ã€‚</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeSignModalButton" type="button" class="w-full bg-sky-500 text-white py-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>
    
    <!-- å ±åæˆåŠŸå½ˆçª— (Modal) -->
    <div id="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- æˆåŠŸåœ–æ¨™ (ä½¿ç”¨ SVG) -->
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2">å ±åæˆåŠŸï¼</h3>
            <p class="text-gray-600 mb-6">æ‚¨å·²æˆåŠŸå®Œæˆç ”ç¿’å ±åï¼Œè¬è¬æ‚¨çš„åƒèˆ‡ã€‚</p>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="closeModalButton" type="button" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-200 shadow-md">
                ç¢ºå®š
            </button>
        </div>
    </div>
    
    <!-- ç¢ºèªæ“ä½œå½ˆçª— (ç”¨æ–¼æ¸…ç©ºè³‡æ–™å‰çš„äºŒæ¬¡ç¢ºèª) -->
    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-lg p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-600">
            
            <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>

            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="confirmTitle">ç¢ºèªæ“ä½œ</h3>
            <p class="text-gray-600 mb-6" id="confirmMessage">æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±åç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼</p>

            <!-- æŒ‰éˆ•å€å¡Š -->
            <div class="flex justify-center space-x-4">
                <button id="cancelConfirmButton" type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 shadow-md">
                    å–æ¶ˆ
                </button>
                <button id="executeConfirmButton" type="button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md">
                    ç¢ºå®šæ¸…ç©º
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æœƒå“¡å½ˆçª— (NEW) -->
    <div id="addMemberModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-green-500">
            
            <h3 class="text-2xl font-bold text-gray-800 mb-2">æ–°å¢å ±åæœƒå“¡</h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥æ–°çš„æœƒå“¡èº«ä»½è­‰å­—è™Ÿï¼Œå°‡å…¶åŠ å…¥å ±åç™½åå–®ã€‚</p>

            <div class="space-y-3 text-left">
                <label for="newMemberIdInput" class="block text-sm font-medium text-gray-700">èº«ä»½è­‰å­—è™Ÿ (ID Number)</label>
                <input type="text" id="newMemberIdInput" placeholder="ä¾‹å¦‚: A123456789" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 uppercase">
                <p id="memberAddMessage" class="text-xs text-red-500 hidden mt-1"></p>
            </div>

            <!-- æŒ‰éˆ•å€å¡Š -->
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancelAddMemberButton" type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 shadow-md">
                    å–æ¶ˆ
                </button>
                <button id="confirmAddMemberButton" type="button" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md">
                    ç¢ºèªæ–°å¢
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, orderBy, setDoc, getDoc, getDocs, where, updateDoc, doc, deleteDoc, onSnapshot, FieldValue, deleteField
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Log ç´šåˆ¥ç‚º Debug
        setLogLevel('debug');

        // --- è¨­å®šå¯†ç¢¼èˆ‡æœƒå“¡åå–® ---
        const EXPORT_PASSWORD = '661113'; // ç®¡ç†å“¡å¯†ç¢¼
        
        // ** å ±åæœƒå“¡ç™½åå–® (åŸºæ–¼èº«ä»½è­‰å­—è™Ÿ) **
        // é€™æ˜¯æœ€æ–°çš„èº«ä»½è­‰å­—è™Ÿç™½åå–®ï¼Œç”¨æ–¼å ±åé©—è­‰
        const REGISTRATION_ID_WHITELIST = [
            'A220444341', 'A220710340', 'A221690507', 'A223395916', 'A223752966', 'A224117621',
            'B220564616', 'B220716558', 'B221770734', 'B221875305', 'B222409118', 'C220033144',
            'C220273728', 'C221177925', 'D221280353', 'D221353191', 'D221368665', 'D221792812',
            'D221823723', 'D221848444', 'D222011281', 'D222243694', 'D222371031', 'D222987959',
            'E122740419', 'E124843842', 'E220079704', 'E220195418', 'E220210483', 'E220297962',
            'E220308460', 'E220341689', 'E220342293', 'E220388084', 'E220393996', 'E220524099',
            'E220616789', 'E220666234', 'E220689602', 'E220741983', 'E220779674', 'E220843580',
            'E220877353', 'E220913836', 'E220961056', 'E221050972', 'E221059948', 'E221070992',
            'E221136539', 'E221163769', 'E221221784', 'E221263095', 'E221304644', 'E221355543',
            'E221368586', 'E221385792', 'E221408398', 'E221577969', 'E221613399', 'E221672861',
            'E221680327', 'E221778500', 'E221803053', 'E221836052', 'E222059559', 'E222066303',
            'E222072534', 'E222084463', 'E222104791', 'E222112015', 'E222139623', 'E222150962',
            'E222155949', 'E222177025', 'E222177570', 'E222232843', 'E222235022', 'E222258963',
            'E222277342', 'E222327570', 'E222407411', 'E222435237', 'E222448681', 'E222452434',
            'E222536677', 'E222566675', 'E222566782', 'E222570295', 'E222635102', 'E222670432',
            'E222704219', 'E222796093', 'E222805917', 'E222841084', 'E222873899', 'E222884525',
            'E222891164', 'E222959581', 'E222988108', 'E223009017', 'E223016254', 'E223091024',
            'E223130393', 'E223175409', 'E223198671', 'E223236452', 'E223272403', 'E223277588',
            'E223326871', 'E223327092', 'E223335889', 'E223477300', 'E223478450', 'E223526791',
            'E223669737', 'E223691435', 'E223830058', 'E223882347', 'E224015135', 'E224300540',
            'E224422630', 'E224518604', 'E224586111', 'E224700960', 'E224800616', 'E226866087',
            'F223485974', 'F224168089', 'F224229658', 'F224623012', 'F224680982', 'F225807610',
            'F226263872', 'F227465496', 'G220794119', 'G221261379', 'G221383236', 'H221334878',
            'H221939300', 'H222198063', 'I200051735', 'J220066489', 'K220138632', 'L220395735',
            'L221013063', 'L221450039', 'L222150396', 'L222419863', 'L222905382', 'L223725235',
            'L225440226', 'M221390351', 'M221598437', 'M221599596', 'M221636843', 'M221660465',
            'M221800852', 'M222018107', 'M222116706', 'N220244548', 'N222547846', 'N222642051',
            'N222752856', 'N222923122', 'N222975591', 'N224125759', 'N224134623', 'N224781506',
            'N225495223', 'P220185590', 'P220716675', 'P220795603', 'P220940304', 'P221674032',
            'P221697848', 'P222200385', 'P222391103', 'P222924200', 'P223101916', 'Q220793280',
            'Q221048248', 'Q221349795', 'Q221352970', 'Q221421854', 'Q222027841', 'Q222573080',
            'Q222623389', 'Q222649374', 'Q222681998', 'Q222955911', 'Q222965355', 'Q223147922',
            'R220035435', 'R220067231', 'R220277835', 'R220443428', 'R220503858', 'R220841362',
            'R220924893', 'R221035386', 'R221313581', 'R221516895', 'R221566288', 'R221644143',
            'R221804907', 'R221887022', 'R222149183', 'R222279828', 'R222456914', 'R222526617',
            'R222599727', 'R222639495', 'R222723812', 'R222945578', 'R223039382', 'R223244730',
            'R223366428', 'R223489784', 'R224258676', 'R224394971', 'S120099116', 'S220147726',
            'S220171722', 'S220186590', 'S220200577', 'S220200817', 'S220209632', 'S220218588',
            'S220224808', 'S220227238', 'S220228422', 'S220228520', 'S220235285', 'S220247589',
            'S220261632', 'S220303920', 'S220323075', 'S220375444', 'S220408288', 'S220424808',
            'S220456542', 'S220489514', 'S220501588', 'S220508452', 'S220516981', 'S220573404',
            'S220692753', 'S220694766', 'S220773502', 'S220796023', 'S220797502', 'S220901177',
            'S220940085', 'S220951668', 'S220951677', 'S220983179', 'S221023798', 'S221069098',
            'S221088137', 'S221134796', 'S221195262', 'S221222424', 'S221279432', 'S221280328',
            'S221283356', 'S221334429', 'S221337626', 'S221363260', 'S221396929', 'S221428560',
            'S221436419', 'S221493816', 'S221512389', 'S221528510', 'S221553853', 'S221578485',
            'S221584812', 'S221613023', 'S221614879', 'S221625514', 'S221676093', 'S221687612',
            'S221691625', 'S221715988', 'S221794032', 'S221809270', 'S221829334', 'S221847903',
            'S221914909', 'S221920452', 'S221958296', 'S221981777', 'S221989719', 'S222007770',
            'S222069850', 'S222097158', 'S222097783', 'S222108325', 'S222132616', 'S222140172',
            'S222140350', 'S222142498', 'S222167753', 'S222171239', 'S222213312', 'S222222820',
            'S222248164', 'S222255927', 'S222256291', 'S222285309', 'S222285907', 'S222292206',
            'S222294139', 'S222300598', 'S222305119', 'S222313773', 'S222324918', 'S222327188',
            'S222376396', 'S222380407', 'S222380425', 'S222385279', 'S222386221', 'S222389053',
            'S222426006', 'S222428662', 'S222451509', 'S222451803', 'S222530756', 'S222547457',
            'S222557873', 'S222561091', 'S222571471', 'S222658357', 'S222670317', 'S222701282',
            'S222712641', 'S222724016', 'S222760754', 'S222765679', 'S222798776', 'S222830448',
            'S222841718', 'S222894791', 'S222894933', 'S222899492', 'S222899652', 'S223031047',
            'S223039927', 'S223044455', 'S223124912', 'S223173004', 'S223313188', 'S223345484',
            'S223356147', 'S223392581', 'S223404095', 'S223445943', 'S223458262', 'S223472897',
            'S223473661', 'S223498373', 'S223503039', 'S223513517', 'S223517337', 'S223577664',
            'S223647661', 'S223738952', 'S223811885', 'S223823876', 'S223904287', 'S223918905',
            'S223940425', 'S224055096', 'S224081149', 'S224279407', 'S224339355', 'S224644459',
            'S224714625', 'S224725842', 'S225056088', 'T220124877', 'T220149623', 'T220184079',
            'T220257424', 'T220577949', 'T220606785', 'T220619308', 'T220643493', 'T220742151',
            'T220754633', 'T220910579', 'T221102213', 'T221185696', 'T221459708', 'T221520775',
            'T221718426', 'T221733889', 'T221761365', 'T222175998', 'T222230449', 'T222280912',
            'T222322853', 'T222325229', 'T222334335', 'T222334415', 'T222347538', 'T222350946',
            'T222361010', 'T222542444', 'T222592042', 'T222634198', 'T222641371', 'T222661006',
            'T222833100', 'T222835364', 'T223014636', 'T223121994', 'T223143874', 'T223208227',
            'T223230489', 'T223268741', 'T223321789', 'T223340113', 'T223363456', 'T223435028',
            'T223450329', 'T223476403', 'T223501349', 'T223506960', 'T223562619', 'T223601746',
            'T223686445', 'T223819748', 'U220722810', 'U220728536', 'U220822253', 'V220445720',
            'V220877482', 'W200265559', 'X220049013', 'X220083908', 'S225795339', 'S225615872',
            'S225901935', 'T221761365', 'S225642066', 'S225641989', 'S225568878' // å¾åœ–åƒä¸­è£œå……çš„èº«ä»½è­‰å­—è™Ÿ
        ];
        
        // ** å­¸åˆ†æŸ¥è©¢èº«ä»½è­‰å­—è™Ÿç™½åå–® (ä½¿ç”¨æ‚¨æä¾›çš„åœ–æª”è³‡è¨Š) **
        const CREDIT_ID_WHITELIST = [
            'S222327188',
            'S225795339',
            'S225615872',
            'S225901935',
            'T221761365',
            'S225642066',
            'S225641989',
            'S225568878'
        ];
        
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        let db;
        let auth;
        let userId = 'anonymous';
        let isAuthReady = false;
        let isBackendAccessed = false; // NEW: è¿½è¹¤å¾Œå°æ˜¯å¦å·²ç™»å…¥
        let currentSurveyName = ''; // ç”¨æ–¼æ»¿æ„åº¦èª¿æŸ¥å½ˆçª—é¡¯ç¤ºå¡«å¯«äºº
        
        // å…¨åŸŸç°½åˆ°/ç°½é€€æ™‚é–“å€é–“è¨­å®š (Date Object) - æ›´æ–°ç‚ºä¸‰å€‹å€é–“
        let morningCheckInStartTime = null; 
        let morningCheckInEndTime = null; 
        let afternoonCheckInStartTime = null; 
        let afternoonCheckInEndTime = null; 
        let afternoonCheckOutStartTime = null; 
        let afternoonCheckOutEndTime = null; 
        
        
        // *******************************************************************
        // â— é‡å°ã€ŒFirebase é…ç½®éºå¤±ã€çš„éŒ¯èª¤ä¿®å¾©èˆ‡èªªæ˜ â—
        // 
        // 1. å¦‚æœæ‚¨åœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼šè«‹ä¿æŒä»¥ä¸‹ç¨‹å¼ç¢¼ä¸è®Šã€‚
        // 2. å¦‚æœæ‚¨åœ¨æœ¬åœ° HTML æª”æ¡ˆä¸­é‹è¡Œï¼šè«‹å‹™å¿…å°‡æ‚¨åœ¨ Firebase Console å–å¾—çš„å°ˆæ¡ˆé…ç½®ç‰©ä»¶
        //    å¡«å…¥ä¸‹æ–¹çš„ `YOUR_LOCAL_FIREBASE_CONFIG` ä¸­ã€‚
        
        // å¦‚æœæ‚¨åœ¨æœ¬åœ°åŸ·è¡Œï¼Œè«‹åœ¨ä¸‹æ–¹çš„ { } å…§è²¼ä¸Šæ‚¨çš„ Firebase é…ç½®ç‰©ä»¶ã€‚
        const YOUR_LOCAL_FIREBASE_CONFIG = {
  apiKey: "AIzaSyBlqR82MrYJB_SCIrlSxdcUdDrW6K96TrE",
  authDomain: "csvs-8b55d.firebaseapp.com",
  projectId: "csvs-8b55d",
  storageBucket: "csvs-8b55d.firebasestorage.app",
  messagingSenderId: "93064933978",
  appId: "1:93064933978:web:226fc3a8a271b2a4975e63",
  measurementId: "G-W2ZJKEMPV4"
}; 
        
        // *******************************************************************
        
        // å–å¾—ç’°å¢ƒè®Šæ•¸ï¼Œé€™æ˜¯ Firebase å¿…è¦çš„é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // å¦‚æœ Canvas ç’°å¢ƒè®Šæ•¸ä¸å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨ YOUR_LOCAL_FIREBASE_CONFIG
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) 
            : YOUR_LOCAL_FIREBASE_CONFIG;
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        

        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        
        // NEW: æ‰‹æ©Ÿæ¬„ä½
        const phoneInput = document.getElementById('phone'); 
        
        // ç°½åˆ°/ç°½é€€ç›¸é—œå…ƒç´  - æ›´æ–°ç‚ºä¸‰éšæ®µæŒ‰éˆ•
        const signIdNumberInput = document.getElementById('sign_id_number');
        const morningCheckInButton = document.getElementById('morningCheckInButton');
        const afternoonCheckInButton = document.getElementById('afternoonCheckInButton');
        const afternoonCheckOutButton = document.getElementById('afternoonCheckOutButton');
        
        // æ»¿æ„åº¦èª¿æŸ¥ç›¸é—œå…ƒç´  (NEW)
        const enterSurveyButton = document.getElementById('enterSurveyButton');
        const surveyIdNumberInput = document.getElementById('survey_id_number');
        const surveyModal = document.getElementById('surveyModal');
        const closeSurveyFormButton = document.getElementById('closeSurveyFormButton');
        const surveyForm = document.getElementById('surveyForm');
        const surveyUserDisplay = document.getElementById('surveyUserDisplay');
        const surveyHiddenIdNumber = document.getElementById('surveyHiddenIdNumber');
        const submitSurveyButton = document.getElementById('submitSurveyButton');

        
        // ç³»çµ±è¨­å®šç›¸é—œå…ƒç´ 
        const morningCheckInStartTimeInput = document.getElementById('setting_morning_ci_start');
        const morningCheckInEndTimeInput = document.getElementById('setting_morning_ci_end');
        const afternoonCheckInStartTimeInput = document.getElementById('setting_afternoon_ci_start');
        const afternoonCheckInEndTimeInput = document.getElementById('setting_afternoon_ci_end');
        const afternoonCheckOutStartTimeInput = document.getElementById('setting_afternoon_co_start');
        const afternoonCheckOutEndTimeInput = document.getElementById('setting_afternoon_co_end');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const resetTimeSettingsButton = document.getElementById('resetTimeSettingsButton'); // NEW

        // å–æ¶ˆå ±åå…ƒç´ 
        const cancelRegistrationButton = document.getElementById('cancelRegistrationButton'); // NEW

        // å­¸åˆ†æŸ¥è©¢å…ƒç´ 
        const creditQueryButton = document.getElementById('creditQueryButton'); // NEW
        
        // æ–°å¢çš„è¨­å®šå­˜å–å…ƒç´ 
        const toggleSettingsButton = document.getElementById('toggleSettingsButton');
        const settingsAccessSection = document.getElementById('settingsAccessSection');
        const settingsAccessPasswordInput = document.getElementById('settingsAccessPassword');
        const confirmSettingsAccessButton = document.getElementById('confirmSettingsAccessButton');
        const settingsInputsContainer = document.getElementById('settingsInputsContainer');
        const accessError = document.getElementById('accessError');

        // å¾Œå°æ“ä½œç›¸é—œå…ƒç´  (NEW/REPLACED)
        const accessBackendButton = document.getElementById('accessBackendButton');
        const backendContent = document.getElementById('backendContent');
        const backendPasswordInput = document.getElementById('backendPassword'); // é‡æ–°å®šç¾© ID
        const confirmBackendAccessButton = document.getElementById('confirmBackendAccessButton'); // é‡æ–°å®šç¾© ID
        const backendAccessError = document.getElementById('backendAccessError'); // é‡æ–°å®šç¾© ID
        const registrationsListContainer = document.getElementById('registrationsListContainer');
        const backendInfoText = document.getElementById('backendInfoText');

        const exportCsvButton = document.getElementById('exportCsvButton');
        const clearDataButton = document.getElementById('clearDataButton'); 
        const clearSignaturesButton = document.getElementById('clearSignaturesButton'); // NEW

        // æ–°å¢æœƒå“¡ç›¸é—œå…ƒç´ 
        const addMemberButton = document.getElementById('addMemberButton');
        const addMemberModal = document.getElementById('addMemberModal');
        const cancelAddMemberButton = document.getElementById('cancelAddMemberButton');
        const confirmAddMemberButton = document.getElementById('confirmAddMemberButton');
        const newMemberIdInput = document.getElementById('newMemberIdInput');
        const memberAddMessage = document.getElementById('memberAddMessage');

        // å½ˆçª—
        const successModal = document.getElementById('successModal'); // å ±åæˆåŠŸ
        const closeModalButton = document.getElementById('closeModalButton');
        const signSuccessModal = document.getElementById('signSuccessModal'); // ç°½åˆ°/ç°½é€€æˆåŠŸ & å–æ¶ˆå ±åæˆåŠŸ & å•å·å¡«å¯«æˆåŠŸ
        const closeSignModalButton = document.getElementById('closeSignModalButton');
        const signSuccessTitle = document.getElementById('signSuccessTitle');
        const signSuccessMessage = document.getElementById('signSuccessMessage');
        const errorModal = document.getElementById('errorModal'); // å ±åéŒ¯èª¤ & æŸ¥è©¢å¤±æ•— & å•å·éŒ¯èª¤
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const confirmModal = document.getElementById('confirmModal'); // æ¸…ç©ºè³‡æ–™äºŒæ¬¡ç¢ºèª
        const cancelConfirmButton = document.getElementById('cancelConfirmButton');
        const executeConfirmButton = document.getElementById('executeConfirmButton');


        let areSettingsVisible = false; // è¿½è¹¤è¨­å®šå€å¡Šæ˜¯å¦å·²æˆåŠŸé©—è­‰ä¸¦é¡¯ç¤º

        // --- å½ˆçª—ç›¸é—œå‡½æ•¸ ---

        function showSuccessModal() {
            successModal.classList.remove('hidden');
            setTimeout(() => { successModal.classList.add('modal-open'); }, 10);
        }

        function hideSuccessModal() {
            successModal.classList.remove('modal-open');
            setTimeout(() => { successModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * é¡¯ç¤ºç°½åˆ°/ç°½é€€/å–æ¶ˆå ±å/å­¸åˆ†æŸ¥è©¢æˆåŠŸå½ˆçª—ã€‚
         * @param {string} title æ¨™é¡Œ
         * @param {string} message è¨Šæ¯å…§å®¹
         */
        function showSignSuccessModal(title, message) {
            signSuccessTitle.textContent = title;
            signSuccessMessage.textContent = message;
            signSuccessModal.classList.remove('hidden');
            setTimeout(() => { signSuccessModal.classList.add('modal-open'); }, 10);
        }
        
        function hideSignSuccessModal() {
            signSuccessModal.classList.remove('modal-open');
            setTimeout(() => { signSuccessModal.classList.add('hidden'); }, 300);
        }

        /**
         * é¡¯ç¤ºå ±å/æŸ¥è©¢éŒ¯èª¤å½ˆçª—ã€‚
         * @param {string} title æ¨™é¡Œ
         * @param {string} message è¨Šæ¯å…§å®¹
         */
        function showErrorModal(title, message) {
            errorTitle.textContent = title;
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            setTimeout(() => { errorModal.classList.add('modal-open'); }, 10);
        }
        
        function hideErrorModal() {
            errorModal.classList.remove('modal-open');
            setTimeout(() => { errorModal.classList.add('hidden'); }, 300);
        }

        /**
         * é¡¯ç¤ºå•å·å½ˆçª—
         * @param {string} name å¡«å¯«è€…å§“å
         */
        function showSurveyModal(name) {
            surveyUserDisplay.textContent = `å¡«å¯«äºº: ${name}`;
            surveyModal.classList.remove('hidden');
            setTimeout(() => { surveyModal.classList.add('modal-open'); }, 10);
        }
        
        /**
         * éš±è—å•å·å½ˆçª—
         */
        function hideSurveyModal() {
            surveyModal.classList.remove('modal-open');
            surveyForm.reset(); // æ¸…ç©ºè¡¨å–®
            setTimeout(() => { surveyModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * é¡¯ç¤ºäºŒæ¬¡ç¢ºèªå½ˆçª—
         * @param {string} title æ¨™é¡Œ
         * @param {string} message è¨Šæ¯
         * @param {string} actionType 'clearData' or 'clearSignatures' or 'resetTime'
         */
        function showConfirmModal(title, message, actionType) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            // è¨­ç½®æŒ‰éˆ•çš„åŸ·è¡Œæ“ä½œ
            executeConfirmButton.setAttribute('data-action', actionType);
            if (actionType === 'clearData') {
                executeConfirmButton.textContent = 'ç¢ºå®šæ¸…ç©º';
            } else if (actionType === 'clearSignatures') {
                executeConfirmButton.textContent = 'ç¢ºå®šé‚„åŸ';
            } else if (actionType === 'resetTime') {
                 executeConfirmButton.textContent = 'ç¢ºå®šé‡è¨­';
            }

            confirmModal.classList.remove('hidden');
            setTimeout(() => { confirmModal.classList.add('modal-open'); }, 10);
        }

        /**
         * éš±è—äºŒæ¬¡ç¢ºèªå½ˆçª—
         */
        function hideConfirmModal() {
            confirmModal.classList.remove('modal-open');
            executeConfirmButton.removeAttribute('data-action');
            setTimeout(() => { confirmModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * é¡¯ç¤ºæ–°å¢æœƒå“¡å½ˆçª—
         */
        function showAddMemberModal() {
            addMemberModal.classList.remove('hidden');
            memberAddMessage.classList.add('hidden');
            newMemberIdInput.value = '';
            setTimeout(() => { addMemberModal.classList.add('modal-open'); }, 10);
        }
        
        /**
         * éš±è—æ–°å¢æœƒå“¡å½ˆçª—
         */
        function hideAddMemberModal() {
            addMemberModal.classList.remove('modal-open');
            setTimeout(() => { addMemberModal.classList.add('hidden'); }, 300);
        }


        /**
         * é¡¯ç¤ºè¨Šæ¯çµ¦ä½¿ç”¨è€…ï¼Œä¸¦è¨­å®šæ¨£å¼
         * @param {string} message è¨Šæ¯å…§å®¹
         * @param {string} type æ¶²é¡å‹: 'info', 'success', 'error'
         * @param {number} duration è¨Šæ¯é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’), é è¨­ 5000ms
         */
        function displayMessage(message, type = 'info', duration = 5000) {
            let bgColor = '';
            let textColor = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-sky-100';
                    textColor = 'text-sky-800';
                    break;
            }
            
            // ç«‹å³é¡¯ç¤ºè¨Šæ¯
            statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300 ${bgColor} ${textColor}`;
            statusMessage.textContent = message;

            // è¨­ç½®è¨ˆæ™‚å™¨ï¼Œåœ¨ä¸€æ®µæ™‚é–“å¾Œæ¸…é™¤è¨Šæ¯
            clearTimeout(window.statusMessageTimeout);
            if (duration > 0) {
                window.statusMessageTimeout = setTimeout(() => {
                    // æ¸…é™¤æ¨£å¼å’Œå…§å®¹
                    statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300`;
                    statusMessage.textContent = 'ç³»çµ±æº–å‚™å°±ç·’ã€‚';
                }, duration);
            }
        }
        
        /**
         * æ ¼å¼åŒ– Date ç‰©ä»¶ç‚º datetime-local è¼¸å…¥æ ¼å¼ (YYYY-MM-DDTHH:MM)
         * @param {Date} dateObj 
         */
        function formatToLocalDatetime(dateObj) {
            // ç¢ºä¿è¼¸å…¥æ˜¯ Date ç‰©ä»¶
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            
            // èª¿æ•´æ™‚å€åç§»ï¼Œä»¥é¡¯ç¤ºæ­£ç¢ºçš„æœ¬åœ°æ™‚é–“åœ¨ datetime-local è¼¸å…¥æ¡†
            const tempDate = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000));
            return tempDate.toISOString().slice(0, 16);
        }

        /**
         * æ ¼å¼åŒ–æ™‚é–“æˆ³ helper
         */
        const formatTimestamp = (ts) => {
            if (ts instanceof Date) {
                 return ts.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            } else if (ts && ts.toDate) {
                return ts.toDate().toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
            return 'N/A';
        }

        /**
         * ç²å–å…¬ç”¨è³‡æ–™é›†çš„ Firestore é›†åˆåƒè€ƒ
         */
        function getRegistrationsCollectionRef() {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘: /artifacts/{appId}/public/data/registrations
            return collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
        }

        /**
         * ç²å–å•å·è³‡æ–™é›†çš„ Firestore é›†åˆåƒè€ƒ (NEW)
         */
        function getSurveysCollectionRef() {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘: /artifacts/{appId}/public/data/surveys
            return collection(db, 'artifacts', appId, 'public', 'data', 'surveys');
        }
        
        /**
         * ç²å–ç³»çµ±è¨­å®šæ–‡ä»¶çš„ Firestore æ–‡ä»¶åƒè€ƒ
         */
        function getSettingsDocRef() {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘: /artifacts/{appId}/public/data/app_settings/config
            return doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config');
        }

        /**
         * åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œèº«ä»½é©—è­‰
         */
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                // å¦‚æœ firebaseConfig ç‚ºç©ºç‰©ä»¶ï¼Œè¡¨ç¤ºæœ¬åœ°é…ç½®éºå¤±
                displayMessage('éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åƒè€ƒç¨‹å¼ç¢¼ä¸­çš„è¨»é‡‹ï¼Œåœ¨ `YOUR_LOCAL_FIREBASE_CONFIG` è™•å¡«å…¥æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½®ã€‚', 'error', 0);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                displayMessage('æ­£åœ¨é€²è¡Œèº«ä»½é©—è­‰...', 'info', 0);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        displayMessage('ç³»çµ±åˆå§‹åŒ–æˆåŠŸï¼Œæ­¡è¿ä½¿ç”¨ï¼', 'success');
                        submitButton.disabled = false;
                        morningCheckInButton.disabled = false;
                        afternoonCheckInButton.disabled = false;
                        afternoonCheckOutButton.disabled = false;
                        toggleSettingsButton.disabled = false; // å•Ÿç”¨è¨­å®šæŒ‰éˆ•
                        accessBackendButton.disabled = false; // å•Ÿç”¨å¾Œå°é€²å…¥æŒ‰éˆ•
                        cancelRegistrationButton.disabled = false; // å•Ÿç”¨å–æ¶ˆå ±åæŒ‰éˆ•
                        creditQueryButton.disabled = false; // å•Ÿç”¨å­¸åˆ†æŸ¥è©¢æŒ‰éˆ•
                        enterSurveyButton.disabled = false; // å•Ÿç”¨å•å·æŒ‰éˆ• (NEW)
                        isAuthReady = true;
                        await fetchSettings(); // è¼‰å…¥ç³»çµ±è¨­å®š
                    } else {
                        // å¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œå˜—è©¦åŒ¿åç™»å…¥
                        if (initialAuthToken) {
                            // ä½¿ç”¨æä¾›çš„å®¢è£½åŒ– token ç™»å…¥
                            await signInWithCustomToken(auth, initialAuthToken); 
                        } else {
                            // å¦å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                displayMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message} (è«‹æª¢æŸ¥é…ç½®)`, 'error', 0);
            }
        }
        
        /**
         * å¾ Firestore ç²å–è³‡æ–™ä¸¦é–‹å§‹å³æ™‚ç›£è½ (æ­¤è™•æ”¹ç‚ºåƒ…ç²å–è³‡æ–™ï¼Œä¸é€²è¡Œç›£è½)
         */
        function setupBackendListener() {
            console.log("Backend: Listing feature removed. Ready for export/clear operations.");
        }


        // --- ç³»çµ±è¨­å®šæ“ä½œ ---

        /**
         * å¾ Firestore ç²å–ç³»çµ±è¨­å®š
         */
        async function fetchSettings() {
            if (!db) return;

            try {
                const settingsRef = getSettingsDocRef();
                const docSnap = await getDoc(settingsRef);

                const nowDatetime = formatToLocalDatetime(new Date());

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // è½‰æ› Firestore Timestamp/Date ç‚º JavaScript Date object - æ›´æ–°ç‚ºå…­å€‹æ™‚é–“
                    morningCheckInStartTime = data.morningCheckInStartTime && data.morningCheckInStartTime.toDate ? data.morningCheckInStartTime.toDate() : null;
                    morningCheckInEndTime = data.morningCheckInEndTime && data.morningCheckInEndTime.toDate ? data.morningCheckInEndTime.toDate() : null;
                    afternoonCheckInStartTime = data.afternoonCheckInStartTime && data.afternoonCheckInStartTime.toDate ? data.afternoonCheckInStartTime.toDate() : null;
                    afternoonCheckInEndTime = data.afternoonCheckInEndTime && data.afternoonCheckInEndTime.toDate ? data.afternoonCheckInEndTime.toDate() : null;
                    afternoonCheckOutStartTime = data.afternoonCheckOutStartTime && data.afternoonCheckOutStartTime.toDate ? data.afternoonCheckOutStartTime.toDate() : null;
                    afternoonCheckOutEndTime = data.afternoonCheckOutEndTime && data.afternoonCheckOutEndTime.toDate ? data.afternoonCheckOutEndTime.toDate() : null;

                    // æ›´æ–° UI è¼¸å…¥æ¡†çš„å€¼ï¼Œå¦‚æœç‚º null å‰‡ä½¿ç”¨ç•¶å‰æ™‚é–“
                    morningCheckInStartTimeInput.value = morningCheckInStartTime ? formatToLocalDatetime(morningCheckInStartTime) : nowDatetime;
                    morningCheckInEndTimeInput.value = morningCheckInEndTime ? formatToLocalDatetime(morningCheckInEndTime) : nowDatetime;
                    afternoonCheckInStartTimeInput.value = afternoonCheckInStartTime ? formatToLocalDatetime(afternoonCheckInStartTime) : nowDatetime;
                    afternoonCheckInEndTimeInput.value = afternoonCheckInEndTime ? formatToLocalDatetime(afternoonCheckInEndTime) : nowDatetime;
                    afternoonCheckOutStartTimeInput.value = afternoonCheckOutStartTime ? formatToLocalDatetime(afternoonCheckOutStartTime) : nowDatetime;
                    afternoonCheckOutEndTimeInput.value = afternoonCheckOutEndTime ? formatToLocalDatetime(afternoonCheckOutEndTime) : nowDatetime;

                    displayMessage('ç³»çµ±è¨­å®šå·²è¼‰å…¥ã€‚', 'info', 3000);
                } else {
                    // å¦‚æœæ²’æœ‰è¨­å®šæª”ï¼Œåˆå§‹åŒ–è¼¸å…¥æ¡†ç‚ºç•¶å‰æ™‚é–“
                    morningCheckInStartTimeInput.value = nowDatetime;
                    morningCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckInStartTimeInput.value = nowDatetime;
                    afternoonCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckOutStartTimeInput.value = nowDatetime;
                    afternoonCheckOutEndTimeInput.value = nowDatetime;
                    displayMessage('ç³»çµ±è¨­å®šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè«‹é€²è¡Œåˆå§‹åŒ–è¨­å®šã€‚', 'info', 5000);
                }
                
                saveSettingsButton.disabled = false; // è¼‰å…¥å®Œæˆå¾Œå•Ÿç”¨å„²å­˜æŒ‰éˆ•
                resetTimeSettingsButton.disabled = false; // è¼‰å…¥å®Œæˆå¾Œå•Ÿç”¨é‚„åŸæŒ‰éˆ•

            } catch (error) {
                console.error("ç²å–ç³»çµ±è¨­å®šå¤±æ•—:", error);
                displayMessage('ç²å–ç³»çµ±è¨­å®šå¤±æ•—ã€‚', 'error', 5000);
            }
        }

        /**
         * è™•ç†é¡¯ç¤º/éš±è—è¨­å®šå€å¡Š
         */
        function handleToggleSettings() {
            if (!isAuthReady) return;
            
            // æ¯æ¬¡é»æ“Šéƒ½é‡è¨­å¯†ç¢¼é©—è­‰ç‹€æ…‹
            settingsAccessSection.classList.add('hidden');
            settingsInputsContainer.classList.add('hidden');
            settingsAccessPasswordInput.value = '';
            accessError.classList.add('hidden');

            if (areSettingsVisible) {
                // å¦‚æœç›®å‰æ˜¯é¡¯ç¤ºç‹€æ…‹ï¼Œé»æ“Šå‰‡éš±è—
                areSettingsVisible = false;
                displayMessage('ç³»çµ±è¨­å®šå·²éš±è—ã€‚', 'info', 2000);
            } else {
                // å¦‚æœç›®å‰æ˜¯éš±è—ç‹€æ…‹ï¼Œå‰‡é¡¯ç¤ºå¯†ç¢¼å€å¡Šé€²è¡Œå­˜å–é©—è­‰
                settingsAccessSection.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–è¨­å®šã€‚', 'info', 5000);
            }
        }

        /**
         * è™•ç†ç¢ºèªå­˜å–è¨­å®šå€å¡Šçš„å¯†ç¢¼
         */
        function handleConfirmSettingsAccess() {
            const enteredPassword = settingsAccessPasswordInput.value;
            
            if (enteredPassword === EXPORT_PASSWORD) {
                // å¯†ç¢¼æ­£ç¢º: é¡¯ç¤ºè¨­å®šè¼¸å…¥å€å¡Šï¼Œéš±è—é©—è­‰å€å¡Š
                settingsAccessSection.classList.add('hidden');
                settingsInputsContainer.classList.remove('hidden');
                areSettingsVisible = true;
                settingsAccessPasswordInput.value = ''; // æ¸…ç©ºå¯†ç¢¼
                accessError.classList.add('hidden');
                displayMessage('å¯†ç¢¼æ­£ç¢ºï¼Œè¨­å®šå€å¡Šå·²é–‹å•Ÿã€‚', 'success', 3000);

            } else {
                // å¯†ç¢¼éŒ¯èª¤: é¡¯ç¤ºéŒ¯èª¤ï¼Œæ¸…ç©ºè¼¸å…¥æ¡†
                settingsAccessPasswordInput.value = '';
                accessError.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•å­˜å–è¨­å®šã€‚', 'error', 5000);
            }
        }

        /**
         * å„²å­˜ç³»çµ±è¨­å®š (æ›´æ–°ç‚ºå…­å€‹æ™‚é–“å€é–“)
         */
        async function handleSaveSettings() {
            if (!isAuthReady || !areSettingsVisible) {
                displayMessage('è«‹å…ˆå­˜å–è¨­å®šå€å¡Šä¸¦ç¢ºä¿ç³»çµ±å·²æº–å‚™å¥½ã€‚', 'error');
                return;
            }

            saveSettingsButton.disabled = true;
            saveSettingsButton.textContent = 'å„²å­˜ä¸­...';
            
            // ç²å–å…­å€‹æ™‚é–“å­—ä¸²
            const miStartStr = morningCheckInStartTimeInput.value;
            const miEndStr = morningCheckInEndTimeInput.value;
            const aiStartStr = afternoonCheckInStartTimeInput.value;
            const aiEndStr = afternoonCheckInEndTimeInput.value;
            const aoStartStr = afternoonCheckOutStartTimeInput.value;
            const aoEndStr = afternoonCheckOutEndTimeInput.value;

            // æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦å¡«å¯«
            if (!miStartStr || !miEndStr || !aiStartStr || !aiEndStr || !aoStartStr || !aoEndStr) {
                displayMessage('æ‰€æœ‰ç°½åˆ°/ç°½é€€æ™‚é–“å€é–“éƒ½å¿…é ˆè¨­å®šã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            // è½‰æ›ç‚º Date ç‰©ä»¶
            const miStartDate = new Date(miStartStr);
            const miEndDate = new Date(miEndStr);
            const aiStartDate = new Date(aiStartStr);
            const aiEndDate = new Date(aiEndStr);
            const aoStartDate = new Date(aoStartStr);
            const aoEndDate = new Date(aoEndStr);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç„¡æ•ˆæ—¥æœŸ
            if (isNaN(miStartDate.getTime()) || isNaN(miEndDate.getTime()) || 
                isNaN(aiStartDate.getTime()) || isNaN(aiEndDate.getTime()) || 
                isNaN(aoStartDate.getTime()) || isNaN(aoEndDate.getTime())) {
                displayMessage('ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼ï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            // é©—è­‰å€é–“é‚è¼¯
            if (miStartDate.getTime() >= miEndDate.getTime()) {
                 displayMessage('ä¸Šåˆç°½åˆ°é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aiStartDate.getTime() >= aiEndDate.getTime()) {
                 displayMessage('ä¸‹åˆç°½åˆ°é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aoStartDate.getTime() >= aoEndDate.getTime()) {
                 displayMessage('ä¸‹åˆç°½é€€é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            // æª¢æŸ¥æ™‚é–“é€£è²«æ€§ (ä¸ŠåˆçµæŸ < ä¸‹åˆé–‹å§‹, ä¸‹åˆçµæŸ < ç°½é€€é–‹å§‹)
            if (miEndDate.getTime() >= aiStartDate.getTime()) {
                displayMessage('ä¸Šåˆç°½åˆ°çµæŸæ™‚é–“å¿…é ˆæ—©æ–¼ä¸‹åˆç°½åˆ°é–‹å§‹æ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }
            if (aiEndDate.getTime() >= aoStartDate.getTime()) {
                displayMessage('ä¸‹åˆç°½åˆ°çµæŸæ™‚é–“å¿…é ˆæ—©æ–¼ä¸‹åˆç°½é€€é–‹å§‹æ™‚é–“ã€‚', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
                return;
            }

            const newSettings = {
                morningCheckInStartTime: miStartDate,
                morningCheckInEndTime: miEndDate,
                afternoonCheckInStartTime: aiStartDate,
                afternoonCheckInEndTime: aiEndDate,
                afternoonCheckOutStartTime: aoStartDate,
                afternoonCheckOutEndTime: aoEndDate
            };

            try {
                // ä½¿ç”¨ setDoc è¦†è“‹æˆ–å‰µå»ºå–®ä¸€è¨­å®šæ–‡ä»¶
                await setDoc(getSettingsDocRef(), newSettings, { merge: true });
                
                // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                morningCheckInStartTime = miStartDate;
                morningCheckInEndTime = miEndDate;
                afternoonCheckInStartTime = aiStartDate;
                afternoonCheckInEndTime = aiEndDate;
                afternoonCheckOutStartTime = aoStartDate;
                afternoonCheckOutEndTime = aoEndDate;
                
                displayMessage('ç³»çµ±è¨­å®šå„²å­˜æˆåŠŸï¼', 'success');

                // å„²å­˜æˆåŠŸå¾Œæ”¶èµ·è¨­å®šè¦–çª—
                settingsInputsContainer.classList.add('hidden');
                areSettingsVisible = false;

            } catch (error) {
                console.error("å„²å­˜ç³»çµ±è¨­å®šå¤±æ•—:", error);
                displayMessage(`å„²å­˜è¨­å®šå¤±æ•—: ${error.message}`, 'error');
            } finally {
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è¨­å®š';
            }
        }

        /**
         * è™•ç†é‚„åŸæ™‚é–“è¨­å®šè‡³é è¨­å€¼ (NEW)
         */
        async function handleResetTimeSettings() {
             if (!isAuthReady || !areSettingsVisible) {
                displayMessage('è«‹å…ˆå­˜å–è¨­å®šå€å¡Šã€‚', 'error');
                return;
            }
            
            hideConfirmModal(); // éš±è—ç¢ºèªå½ˆçª—
            displayMessage('æ­£åœ¨é‚„åŸæ™‚é–“è¨­å®š...', 'info', 0);
            
            try {
                const settingsRef = getSettingsDocRef();
                
                // å°‡æ‰€æœ‰æ™‚é–“æ¬„ä½è¨­ç½®ç‚º deleteField() ä¾†æ¸…é™¤
                const resetData = {
                    morningCheckInStartTime: deleteField(),
                    morningCheckInEndTime: deleteField(),
                    afternoonCheckInStartTime: deleteField(),
                    afternoonCheckInEndTime: deleteField(),
                    afternoonCheckOutStartTime: deleteField(),
                    afternoonCheckOutEndTime: deleteField(),
                };
                
                await updateDoc(settingsRef, resetData);
                
                // é‡æ–°è¼‰å…¥è¨­å®šä»¥æ›´æ–°æœ¬åœ°ç‹€æ…‹å’Œ UI
                await fetchSettings();
                
                // å„²å­˜æˆåŠŸå¾Œæ”¶èµ·è¨­å®šè¦–çª—
                settingsInputsContainer.classList.add('hidden');
                areSettingsVisible = false;

                displayMessage('æ™‚é–“è¨­å®šå·²é‚„åŸç‚ºé è¨­å€¼ï¼Œè«‹é‡æ–°è¨­å®šã€‚', 'success');
                
            } catch (error) {
                console.error("é‚„åŸæ™‚é–“è¨­å®šå¤±æ•—:", error);
                displayMessage(`é‚„åŸè¨­å®šå¤±æ•—: ${error.message}`, 'error');
            }
        }


        /**
         * æäº¤å ±åè¡¨å–®
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡æäº¤
            submitButton.disabled = true;
            submitButton.textContent = 'å ±åä¸­...';

            const school = document.getElementById('school').value.trim();
            const name = document.getElementById('name').value.trim();
            const id_number = document.getElementById('id_number').value.trim().toUpperCase(); 
            const phone = document.getElementById('phone').value.trim(); // NEW: æ‰‹æ©Ÿè™Ÿç¢¼
            const meal = document.getElementById('meal').value; // NEW
            const question = document.getElementById('question').value.trim(); // NEW

            // åŸºæœ¬é©—è­‰
            if (!school || !name || !id_number || !meal || !phone) { // ADDED phone
                displayMessage('å­¸æ ¡ã€å§“åã€èº«ä»½è­‰å­—è™Ÿã€æ‰‹æ©Ÿè™Ÿç¢¼åŠé¤é»æ¬„ä½éƒ½å¿…é ˆå¡«å¯«ï¼', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            
            // èº«ä»½è­‰å­—è™Ÿæ ¼å¼é©—è­‰ (ç°¡æ˜“ç‰ˆ: 10ç¢¼ï¼Œé¦–å­—è‹±æ–‡ï¼Œå¾Œ9ç¢¼æ•¸å­—)
            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(id_number)) {
                displayMessage('å ±åèº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            
            // NEW: æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼é©—è­‰ (10ä½æ•¸å­—)
            const phoneRegex = /^[0-9]{10}$/;
            if (!phoneRegex.test(phone)) {
                displayMessage('æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥10ä½æ•¸å­—ã€‚', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            
            // *** å ±åæª¢æŸ¥: æª¢æŸ¥æ˜¯å¦åœ¨æœƒå“¡åå–®å…§ (ä»¥èº«ä»½è­‰å­—è™Ÿç‚ºä¾æ“š) ***
            if (!REGISTRATION_ID_WHITELIST.includes(id_number)) {
                // ä½¿ç”¨æ–°å¢çš„éŒ¯èª¤å½ˆçª— (NEW)
                showErrorModal('å ±åå¤±æ•—', 'æ‚¨éæœƒå“¡ç„¡æ³•å ±åï¼Œè«‹æ´½æœƒå“¡çµ„');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }
            // **********************************

            // æª¢æŸ¥æ˜¯å¦å·²å ±å (ä»ä»¥èº«ä»½è­‰å­—è™Ÿç‚ºå”¯ä¸€éµ)
            const qCheck = query(getRegistrationsCollectionRef(), where('id_number', '==', id_number));
            const existingDocs = await getDocs(qCheck);
            if (!existingDocs.empty) {
                displayMessage('æ‚¨å·²ä½¿ç”¨æ­¤èº«ä»½è­‰å­—è™Ÿå ±åéï¼Œè«‹å‹¿é‡è¤‡å ±åã€‚', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
                return;
            }


            const newRegistration = {
                school,
                name,
                id_number,
                phone,      // NEW: åŠ å…¥æ‰‹æ©Ÿè™Ÿç¢¼
                meal,       // NEW
                question,   // NEW
                timestamp: new Date(), // ä½¿ç”¨ç•¶å‰æ™‚é–“è¨˜éŒ„å ±å
                registeredBy: userId,
                morningCheckInTime: null, // æ–°å¢æ¬„ä½
                afternoonCheckInTime: null, // æ–°å¢æ¬„ä½
                afternoonCheckOutTime: null // æ–°å¢æ¬„ä½
            };

            try {
                await addDoc(getRegistrationsCollectionRef(), newRegistration);
                
                // *** å ±åæˆåŠŸå¾Œé¡¯ç¤ºå½ˆçª— ***
                showSuccessModal(); 

                form.reset(); 

            } catch (error) {
                console.error("æ–°å¢å ±åè³‡æ–™å¤±æ•—:", error);
                displayMessage(`å ±åå¤±æ•—: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ç«‹å³å ±å';
            }
        }

        /**
         * è™•ç†å–æ¶ˆå ±å (NEW)
         */
        async function handleCancelRegistration() {
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            const idNumber = document.getElementById('cancel_id_number').value.trim().toUpperCase();

            if (!idNumber) {
                displayMessage('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥å–æ¶ˆå ±åã€‚', 'error');
                return;
            }
            
            const button = document.getElementById('cancelRegistrationButton');
            button.disabled = true;
            button.textContent = 'è™•ç†å–æ¶ˆä¸­...';

            try {
                const q = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showErrorModal('å–æ¶ˆå¤±æ•—', 'æŸ¥ç„¡æ­¤èº«ä»½è­‰å­—è™Ÿçš„å ±åç´€éŒ„ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢ºã€‚');
                    return;
                }

                // æ‰¾åˆ°æ–‡ä»¶ (æ‡‰è©²åªæœ‰ä¸€å€‹)
                const docId = snapshot.docs[0].id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', docId));

                // é¡¯ç¤ºæˆåŠŸå½ˆçª—
                showSignSuccessModal('å–æ¶ˆæˆåŠŸ', 'æ‚¨å·²å–æ¶ˆç ”ç¿’å ±åæˆåŠŸã€‚');
                document.getElementById('cancel_id_number').value = '';

            } catch (error) {
                console.error("å–æ¶ˆå ±åå¤±æ•—:", error);
                displayMessage(`å–æ¶ˆå ±åå¤±æ•—: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'ç¢ºå®šå–æ¶ˆå ±å';
            }
        }


        /**
         * è™•ç†ä¸Šåˆç°½åˆ°
         */
        async function handleMorningCheckIn() {
            await processSignAction('morningCheckIn');
        }

        /**
         * è™•ç†ä¸‹åˆç°½åˆ°
         */
        async function handleAfternoonCheckIn() {
            await processSignAction('afternoonCheckIn');
        }

        /**
         * è™•ç†ä¸‹åˆç°½é€€
         */
        async function handleAfternoonCheckOut() {
            await processSignAction('afternoonCheckOut');
        }

        /**
         * è™•ç†å­¸åˆ†æŸ¥è©¢ (NEW) - **ä½¿ç”¨èº«ä»½è­‰å­—è™Ÿç™½åå–®é€²è¡Œæ ¸å°**
         */
        async function handleCreditQuery() {
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            const idNumber = document.getElementById('query_id_number').value.trim().toUpperCase();

            if (!idNumber) {
                displayMessage('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥é€²è¡ŒæŸ¥è©¢ã€‚', 'error');
                return;
            }
            
            const button = document.getElementById('creditQueryButton');
            button.disabled = true;
            button.textContent = 'æŸ¥è©¢ä¸­...';

            try {
                // 1. é©—è­‰èº«ä»½è­‰å­—è™Ÿæ ¼å¼
                const idRegex = /^[A-Z][0-9]{9}$/;
                if (!idRegex.test(idNumber)) {
                    showErrorModal('æŸ¥è©¢å¤±æ•—', 'èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚');
                    return;
                }

                // 2. **NEW: æŸ¥è©¢èº«ä»½è­‰å­—è™Ÿæ˜¯å¦åœ¨å­¸åˆ†ç™½åå–®ä¸­**
                if (CREDIT_ID_WHITELIST.includes(idNumber)) {
                    // æ‰¾åˆ°äº†ï¼Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    showSignSuccessModal('å­¸åˆ†æŸ¥è©¢çµæœ', 'å­¸æœƒå·²ç‚ºæ‚¨ç”³è«‹å­¸åˆ†');
                    
                } else {
                    // æœªæ‰¾åˆ°ï¼Œé¡¯ç¤ºå¤±æ•—è¨Šæ¯
                    showErrorModal('å­¸åˆ†æŸ¥è©¢çµæœ', 'å°šæœªç”³è«‹ï¼Œè«‹æ´½æœƒå“¡çµ„');
                }

            } catch (error) {
                console.error("å­¸åˆ†æŸ¥è©¢å¤±æ•—:", error);
                showErrorModal('æŸ¥è©¢å¤±æ•—', `ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š${error.message}`);
            } finally {
                document.getElementById('query_id_number').value = '';
                button.disabled = false;
                button.textContent = 'æŸ¥è©¢å­¸åˆ†ç”³è«‹ç‹€æ…‹';
            }
        }

        /**
         * è™•ç†é€²å…¥å¡«å¯«æ»¿æ„åº¦èª¿æŸ¥è¡¨ (NEW)
         */
        async function handleEnterSurvey() {
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            const idNumber = surveyIdNumberInput.value.trim().toUpperCase();
            
            if (!idNumber) {
                displayMessage('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥é€²å…¥å•å·ã€‚', 'error');
                return;
            }

            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                showErrorModal('å•å·éŒ¯èª¤', 'èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚');
                return;
            }
            
            enterSurveyButton.disabled = true;
            enterSurveyButton.textContent = 'é©—è­‰ä¸­...';

            try {
                // 1. æª¢æŸ¥æ˜¯å¦å·²å ±å
                const qReg = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const regSnap = await getDocs(qReg);

                if (regSnap.empty) {
                    showErrorModal('å•å·éŒ¯èª¤', 'æŸ¥ç„¡æ­¤å ±åç´€éŒ„ï¼Œç„¡æ³•å¡«å¯«å•å·ã€‚');
                    return;
                }
                
                const userData = regSnap.docs[0].data();
                currentSurveyName = userData.name; // å„²å­˜å§“åä¾›å½ˆçª—é¡¯ç¤º

                // 2. æª¢æŸ¥æ˜¯å¦å·²å¡«å¯«éå•å·
                const qSurvey = query(getSurveysCollectionRef(), where('id_number', '==', idNumber));
                const surveySnap = await getDocs(qSurvey);

                if (!surveySnap.empty) {
                    showErrorModal('å•å·éŒ¯èª¤', `æ‚¨å·²æ–¼ ${formatTimestamp(surveySnap.docs[0].data().timestamp)} å¡«å¯«éæ­¤å•å·ï¼Œè«‹å‹¿é‡è¤‡å¡«å¯«ã€‚`);
                    return;
                }
                
                // 3. é©—è­‰æˆåŠŸï¼Œé–‹å•Ÿå•å·å½ˆçª—
                surveyHiddenIdNumber.value = idNumber;
                showSurveyModal(userData.name);
                surveyIdNumberInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†

            } catch (error) {
                console.error("é€²å…¥å•å·å¤±æ•—:", error);
                showErrorModal('ç³»çµ±éŒ¯èª¤', `é€²å…¥å•å·å¤±æ•—: ${error.message}`);
            } finally {
                enterSurveyButton.disabled = false;
                enterSurveyButton.textContent = 'é€²å…¥å¡«å¯«æ»¿æ„åº¦èª¿æŸ¥è¡¨';
            }
        }
        
        /**
         * è™•ç†æäº¤æ»¿æ„åº¦èª¿æŸ¥è¡¨ (NEW)
         */
        async function handleSurveySubmit(e) {
            e.preventDefault();
            
            submitSurveyButton.disabled = true;
            submitSurveyButton.textContent = 'é€å‡ºä¸­...';
            
            const idNumber = surveyHiddenIdNumber.value;
            
            // ç”±æ–¼ HTML è¡¨å–®ä½¿ç”¨ requiredï¼Œåªéœ€æª¢æŸ¥éš±è—æ¬„ä½æ˜¯å¦å­˜åœ¨å³å¯
            if (!idNumber) {
                showErrorModal('ç³»çµ±éŒ¯èª¤', 'å•å·è³‡æ–™éºå¤±ï¼Œè«‹é‡æ–°é€²å…¥å•å·ã€‚');
                submitSurveyButton.disabled = false;
                submitSurveyButton.textContent = 'é€å‡ºå•å·';
                return;
            }
            
            const formData = new FormData(surveyForm);
            const surveyData = {
                id_number: idNumber,
                q1: formData.get('q1'),
                q2: formData.get('q2'),
                q3: formData.get('q3'),
                q4: formData.get('q4'),
                q5: formData.get('q5'),
                q6: formData.get('q6') || 'ç„¡å»ºè­°äº‹é …', // å»ºè­°äº‹é …ç‚ºé¸å¡«
                timestamp: new Date(),
                filledBy: currentSurveyName || 'N/A' // ä½¿ç”¨ä¹‹å‰ç²å–åˆ°çš„å§“å
            };

            // å†æ¬¡æª¢æŸ¥ Q1-Q5 æ˜¯å¦éƒ½å·²é¸æ“‡ (é›–ç„¶ HTML required æ‡‰å·²è™•ç†)
            for (let i = 1; i <= 5; i++) {
                if (!surveyData[`q${i}`]) {
                    showErrorModal('å•å·éŒ¯èª¤', `ç¬¬ ${i} é¡Œç‚ºå¿…å¡«é¡Œï¼Œè«‹é¸æ“‡è©•åˆ†ã€‚`);
                    submitSurveyButton.disabled = false;
                    submitSurveyButton.textContent = 'é€å‡ºå•å·';
                    return;
                }
            }

            try {
                // å°‡å•å·çµæœå„²å­˜åˆ° surveys é›†åˆ
                await addDoc(getSurveysCollectionRef(), surveyData);
                
                hideSurveyModal();
                showSignSuccessModal('å•å·é€å‡ºæˆåŠŸ', `æ„Ÿè¬ ${currentSurveyName}ï¼æ‚¨çš„æ»¿æ„åº¦èª¿æŸ¥è¡¨å·²æˆåŠŸé€å‡ºã€‚`);

            } catch (error) {
                console.error("æäº¤å•å·å¤±æ•—:", error);
                showErrorModal('ç³»çµ±éŒ¯èª¤', `æäº¤å•å·å¤±æ•—: ${error.message}`);
            } finally {
                submitSurveyButton.disabled = false;
                submitSurveyButton.textContent = 'é€å‡ºå•å·';
            }
        }


        /**
         * è™•ç†ç°½åˆ°/ç°½é€€çš„é€šç”¨é‚è¼¯ (æ›´æ–°ç‚ºä¸‰éšæ®µ)
         * @param {string} actionType 'morningCheckIn', 'afternoonCheckIn', or 'afternoonCheckOut'
         */
        async function processSignAction(actionType) {
            if (!isAuthReady) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™å†è©¦ã€‚', 'error');
                return;
            }

            const idNumber = signIdNumberInput.value.trim().toUpperCase();
            
            if (!idNumber) {
                displayMessage('è«‹è¼¸å…¥èº«ä»½è­‰å­—è™Ÿä»¥é€²è¡Œæ“ä½œã€‚', 'error');
                return;
            }

            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                displayMessage('èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚', 'error');
                return;
            }
            
            // *** ä½¿ç”¨ç³»çµ±ç•¶å‰æ™‚é–“ ***
            const signDate = new Date();
            // ************************


            // å‹•æ…‹ç²å–æŒ‰éˆ•
            const button = document.getElementById(actionType + 'Button'); 
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'è™•ç†ä¸­...';
            
            try {
                // --- æ­¥é©Ÿ 1: æ ¹æ“šæ“ä½œé¡å‹è¨­å®šé©—è­‰åƒæ•¸ ---
                let startTime = null;
                let endTime = null;
                let actionName = '';
                let updateField = '';

                switch (actionType) {
                    case 'morningCheckIn':
                        startTime = morningCheckInStartTime;
                        endTime = morningCheckInEndTime;
                        actionName = 'ä¸Šåˆç°½åˆ°';
                        updateField = 'morningCheckInTime';
                        break;
                    case 'afternoonCheckIn':
                        startTime = afternoonCheckInStartTime;
                        endTime = afternoonCheckInEndTime;
                        actionName = 'ä¸‹åˆç°½åˆ°';
                        updateField = 'afternoonCheckInTime';
                        break;
                    case 'afternoonCheckOut':
                        startTime = afternoonCheckOutStartTime;
                        endTime = afternoonCheckOutEndTime;
                        actionName = 'ä¸‹åˆç°½é€€';
                        updateField = 'afternoonCheckOutTime';
                        break;
                    default:
                        displayMessage('ç„¡æ•ˆçš„æ“ä½œé¡å‹ã€‚', 'error');
                        return;
                }
                
                // æª¢æŸ¥é–‹æ”¾å€é–“
                if (!startTime || !endTime) {
                    showErrorModal('æ“ä½œå¤±æ•—', `éŒ¯èª¤ï¼šå°šæœªè¨­å®š ${actionName} çš„é–‹æ”¾æ™‚é–“å€é–“ï¼Œè«‹æ´½ç®¡ç†å“¡è¨­å®šã€‚`);
                    return; // åš´æ ¼é˜»æ­¢æ“ä½œï¼Œç›´åˆ°è¨­å®šå®Œæˆ
                }

                // æª¢æŸ¥æ˜¯å¦åœ¨å€é–“å…§
                if (signDate.getTime() < startTime.getTime() || signDate.getTime() > endTime.getTime()) {
                    const rangeStr = `${startTime.toLocaleString('zh-TW')} åˆ° ${endTime.toLocaleString('zh-TW')}`;
                    showErrorModal('æ“ä½œå¤±æ•—', `${actionName}æœå‹™æœªåœ¨é–‹æ”¾å€é–“ï¼é–‹æ”¾æ™‚é–“ç‚º ${rangeStr}ã€‚`);
                    return; // é˜»æ­¢æ“ä½œï¼Œå› ç‚ºä¸åœ¨æ™‚é–“ç¯„åœå…§
                }

                // --- æ­¥é©Ÿ 2: æŸ¥æ‰¾å ±åç´€éŒ„ (ç¢ºèªæ­¤äººæ˜¯å¦å·²å ±åæˆåŠŸ) ---
                const q = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // åªæœ‰æˆåŠŸå ±åçš„äººæ‰èƒ½ç°½åˆ°/é€€
                    showErrorModal('ç°½åˆ°å¤±æ•—', 'æŸ¥ç„¡æ­¤å ±åç´€éŒ„ï¼Œè«‹ç¢ºèªèº«ä»½è­‰å­—è™Ÿæ˜¯å¦æ­£ç¢ºã€‚');
                    return;
                }

                // æ‰¾åˆ°æ–‡ä»¶ (æ‡‰è©²åªæœ‰ä¸€å€‹)
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'registrations', snapshot.docs[0].id);
                const data = snapshot.docs[0].data();
                const updateData = {};
                
                // æª¢æŸ¥æ˜¯å¦é‡è¤‡æ“ä½œ
                if (data[updateField]) {
                    showErrorModal('é‡è¤‡æ“ä½œ', `æ‚¨å·²æ–¼ ${formatTimestamp(data[updateField])} å®Œæˆ${actionName}ï¼Œè«‹å‹¿é‡è¤‡æ“ä½œã€‚`);
                    return;
                }

                // --- æ­¥é©Ÿ 3: åŸ·è¡Œç°½åˆ°/ç°½é€€é‚è¼¯ ---

                updateData[updateField] = signDate;

                await updateDoc(docRef, updateData);
                signIdNumberInput.value = ''; // æ¸…ç©ºèº«ä»½è­‰å­—è™Ÿè¼¸å…¥æ¡†
                
                // *** ç°½åˆ°/ç°½é€€æˆåŠŸå¾Œé¡¯ç¤ºå½ˆçª— ***
                showSignSuccessModal('æ“ä½œæˆåŠŸ', `${actionName}æˆåŠŸï¼æ‚¨å·²å®Œæˆæœ¬æ¬¡æ“ä½œã€‚`);
                
            } catch (error) {
                console.error(`è™•ç† ${actionType} å¤±æ•—:`, error);
                displayMessage(`è™•ç†å¤±æ•—: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // --- å¾Œå°ç®¡ç†æ“ä½œ ---

        /**
         * è™•ç†é»æ“Šã€Œé€²å…¥ç³»çµ±ã€æŒ‰éˆ•
         */
        function handleAccessBackend() {
            if (!isAuthReady) return;
            
            // æ¯æ¬¡é»æ“Šéƒ½é‡è¨­å¯†ç¢¼é©—è­‰ç‹€æ…‹
            backendContent.classList.add('hidden');
            backendPasswordInput.value = '';
            backendAccessError.classList.add('hidden');
            
            // é¡¯ç¤ºå¯†ç¢¼é©—è­‰å€å¡Š
            passwordSection.classList.remove('hidden');
            accessBackendButton.disabled = true;
            backendInfoText.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°ç®¡ç†ä»‹é¢ã€‚';
            backendPasswordInput.focus();
        }

        /**
         * è™•ç†ç¢ºèªå¾Œå°å­˜å–å¯†ç¢¼
         */
        function handleConfirmBackendAccess() {
            const enteredPassword = backendPasswordInput.value;

            if (enteredPassword !== EXPORT_PASSWORD) {
                // å¯†ç¢¼éŒ¯èª¤
                backendPasswordInput.value = '';
                backendAccessError.classList.remove('hidden');
                backendPasswordInput.focus();
                displayMessage('å¾Œå°å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
                return;
            }

            // å¯†ç¢¼æ­£ç¢º
            passwordSection.classList.add('hidden'); // éš±è—å¯†ç¢¼å€å¡Š
            accessBackendButton.classList.add('hidden'); // éš±è—é€²å…¥ç³»çµ±æŒ‰éˆ•
            backendContent.classList.remove('hidden'); // é¡¯ç¤ºå¾Œå°å…§å®¹
            backendInfoText.textContent = 'æ‚¨å·²é€²å…¥å¾Œå°ç®¡ç†æ¨¡å¼ã€‚';
            
            isBackendAccessed = true;
            setupBackendListener(); // ç§»é™¤å³æ™‚ç›£è½æ¸…å–®å•Ÿå‹•
            
            displayMessage('å¾Œå°å­˜å–æˆåŠŸï¼', 'success');
        }
        
        /**
         * è™•ç†æ–°å¢æœƒå“¡ (NEW)
         */
        function handleAddMember() {
            if (!isBackendAccessed) {
                displayMessage('è«‹å…ˆé€²å…¥å¾Œå°ç³»çµ±ã€‚', 'error');
                return;
            }
            showAddMemberModal();
        }

        /**
         * è™•ç†ç¢ºèªæ–°å¢æœƒå“¡èº«ä»½è­‰å­—è™Ÿ (NEW)
         */
        function handleConfirmAddMember() {
            const idNumber = newMemberIdInput.value.trim().toUpperCase();

            // 1. é©—è­‰æ ¼å¼
            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                memberAddMessage.classList.remove('text-green-500');
                memberAddMessage.classList.add('text-red-500');
                memberAddMessage.textContent = 'èº«ä»½è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º (A123456789)ã€‚';
                memberAddMessage.classList.remove('hidden');
                return;
            }

            // 2. æª¢æŸ¥æ˜¯å¦é‡è¤‡
            if (REGISTRATION_ID_WHITELIST.includes(idNumber)) {
                memberAddMessage.classList.remove('text-green-500');
                memberAddMessage.classList.add('text-red-500');
                memberAddMessage.textContent = 'è©²èº«ä»½è­‰å­—è™Ÿå·²å­˜åœ¨æ–¼å ±åç™½åå–®ä¸­ã€‚';
                memberAddMessage.classList.remove('hidden');
                return;
            }
            
            // 3. æ–°å¢è‡³ç™½åå–®
            REGISTRATION_ID_WHITELIST.push(idNumber);
            memberAddMessage.classList.remove('text-red-500');
            memberAddMessage.classList.add('text-green-500');
            memberAddMessage.textContent = `æˆåŠŸæ–°å¢ ${idNumber} è‡³å ±åç™½åå–®ï¼`;
            memberAddMessage.classList.remove('hidden');
            console.log("Updated REGISTRATION_ID_WHITELIST:", REGISTRATION_ID_WHITELIST); // Console log for verification
            
            // å»¶é²é—œé–‰è¦–çª—
            setTimeout(hideAddMemberModal, 1500);
        }

        /**
         * è™•ç†æ¸…ç©ºæ‰€æœ‰ç°½åˆ°/ç°½é€€ç´€éŒ„ (NEW)
         */
        async function clearAllSignatures() {
            if (!isAuthReady || !db || !isBackendAccessed) {
                displayMessage('è«‹å…ˆé€²å…¥å¾Œå°ç³»çµ±ã€‚', 'error');
                return;
            }
            
            hideConfirmModal(); // éš±è—ç¢ºèªå½ˆçª—
            displayMessage('æ­£åœ¨æ¸…ç©ºç°½åˆ°/ç°½é€€ç´€éŒ„...', 'info', 0);
            
            try {
                const q = query(getRegistrationsCollectionRef());
                const snapshot = await getDocs(q);
                let updateCount = 0;
                
                const updatePromises = [];
                snapshot.forEach((docSnap) => {
                    // æ‰¹é‡æ›´æ–°ï¼Œå°‡æ‰€æœ‰ç°½åˆ°/ç°½é€€æ™‚é–“è¨­ç‚º null
                    updatePromises.push(updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', docSnap.id), {
                        morningCheckInTime: null,
                        afternoonCheckInTime: null,
                        afternoonCheckOutTime: null
                    }));
                    updateCount++;
                });
                
                await Promise.all(updatePromises);
                
                displayMessage(`å·²æˆåŠŸæ¸…é™¤ ${updateCount} ç­†å ±åè³‡æ–™çš„ç°½åˆ°/ç°½é€€ç´€éŒ„ï¼`, 'success');

            } catch (error) {
                console.error("æ¸…ç©ºç°½åˆ°ç´€éŒ„å¤±æ•—:", error);
                displayMessage(`æ¸…é™¤ç°½åˆ°/ç°½é€€å¤±æ•—: ${error.message}`, 'error');
            }
        }


        /**
         * è™•ç†æ¸…ç©ºå ±åè³‡æ–™ (äºŒæ¬¡ç¢ºèªå¾ŒåŸ·è¡Œ)
         */
        async function deleteAllRegistrations() {
            if (!isAuthReady || !db) {
                displayMessage('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œç„¡æ³•åŸ·è¡Œæ¸…ç©ºæ“ä½œã€‚', 'error');
                return;
            }
            
            hideConfirmModal(); // éš±è—ç¢ºèªå½ˆçª—
            displayMessage('æ­£åœ¨æ¸…ç©ºæ‰€æœ‰å ±åè³‡æ–™... è«‹å‹¿é—œé–‰è¦–çª—ã€‚', 'error', 0);

            try {
                const q = query(getRegistrationsCollectionRef());
                const snapshot = await getDocs(q);
                let deleteCount = 0;
                
                // é€ä¸€åˆªé™¤æ–‡ä»¶
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                    deleteCount++;
                });
                
                await Promise.all(deletePromises);
                
                displayMessage(`å·²æˆåŠŸæ¸…ç©º ${deleteCount} ç­†å ±åç´€éŒ„ï¼`, 'success');

            } catch (error) {
                console.error("æ¸…ç©ºè³‡æ–™å¤±æ•—:", error);
                displayMessage(`æ¸…ç©ºè³‡æ–™å¤±æ•—: ${error.message}`, 'error');
            }
        }


        /**
         * å¾ Firestore æŠ“å–æ‰€æœ‰å ±åè³‡æ–™å’Œå•å·è³‡æ–™ä¸¦åŒ¯å‡ºç‚º CSVã€‚ (UPDATED)
         */
        async function fetchDataAndExportToCsv() {
            if (!isAuthReady || !db || !isBackendAccessed) {
                displayMessage('è«‹å…ˆé€²å…¥å¾Œå°ç³»çµ±ã€‚', 'error');
                return;
            }
            
            exportCsvButton.disabled = true;
            exportCsvButton.textContent = 'ç²å–è³‡æ–™ä¸­...';
            displayMessage('æ­£åœ¨å¾è³‡æ–™åº«ç²å–è³‡æ–™...', 'info');

            try {
                // 1. ç²å–æ‰€æœ‰å ±åè³‡æ–™ (Registrations)
                const regSnapshot = await getDocs(query(getRegistrationsCollectionRef()));
                const registrations = [];
                regSnapshot.forEach((doc) => {
                    registrations.push(doc.data());
                });

                // 2. ç²å–æ‰€æœ‰å•å·è³‡æ–™ (Surveys)
                const surveySnapshot = await getDocs(query(getSurveysCollectionRef()));
                const surveyMap = {}; // ä½¿ç”¨èº«ä»½è­‰å­—è™Ÿä½œç‚ºéµä¾†å¿«é€ŸæŸ¥æ‰¾
                surveySnapshot.forEach((doc) => {
                    const data = doc.data();
                    surveyMap[data.id_number] = data;
                });
                
                // 3. åˆä½µè³‡æ–™
                const mergedData = registrations.map(reg => {
                    const survey = surveyMap[reg.id_number] || {}; // æ‰¾ä¸åˆ°å‰‡ç‚ºç©ºç‰©ä»¶
                    return {
                        ...reg,
                        surveyQ1: survey.q1 || 'æœªå¡«å¯«',
                        surveyQ2: survey.q2 || 'æœªå¡«å¯«',
                        surveyQ3: survey.q3 || 'æœªå¡«å¯«',
                        surveyQ4: survey.q4 || 'æœªå¡«å¯«',
                        surveyQ5: survey.q5 || 'æœªå¡«å¯«',
                        surveyQ6: survey.q6 || 'æœªå¡«å¯«',
                    };
                });

                // 4. åŸ·è¡Œä¸‹è¼‰
                performCsvDownload(mergedData);

            } catch (error) {
                console.error("ç²å–è³‡æ–™å¤±æ•—:", error);
                displayMessage(`åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            } finally {
                 exportCsvButton.disabled = false;
                 exportCsvButton.textContent = 'åŒ¯å‡º CSV';
            }
        }
        
        /**
         * å°‡è³‡æ–™è½‰æ›ç‚º CSV ä¸¦è§¸ç™¼ä¸‹è¼‰
         * @param {Array<object>} data å ±åèˆ‡å•å·åˆä½µè³‡æ–™é™£åˆ—
         */
        function performCsvDownload(data) {
            if (data.length === 0) {
                displayMessage('è³‡æ–™åº«ä¸­æ²’æœ‰å ±åç´€éŒ„å¯ä¾›åŒ¯å‡ºã€‚', 'error');
                return;
            }

            // æ›´æ–° CSV æ¨™é ­ä»¥åŒ…å«å•å·å•é¡Œ
            const headers = [
                "å ±åæ™‚é–“", "å­¸æ ¡", "å§“å", "èº«ä»½è­‰å­—è™Ÿ", "æ‰‹æ©Ÿ", "é¤é»", "è¬›å¸«å•é¡Œ", 
                "æ˜¯å¦ä¸Šåˆç°½åˆ°", "ä¸Šåˆç°½åˆ°æ™‚é–“", 
                "æ˜¯å¦ä¸‹åˆç°½åˆ°", "ä¸‹åˆç°½åˆ°æ™‚é–“", 
                "æ˜¯å¦ä¸‹åˆç°½é€€", "ä¸‹åˆç°½é€€æ™‚é–“", 
                "å•å·Q1:èª²ç¨‹æ‡‰ç”¨æ–¼å¯¦éš›å·¥ä½œæ»¿æ„åº¦", // NEW
                "å•å·Q2:è¬›å¸«å°ˆæ¥­èƒ½åŠ›",             // NEW
                "å•å·Q3:é©ç•¶ç¯„ä¾‹èˆ‡å¯¦å‹™èªªæ˜",       // NEW
                "å•å·Q4:èª²ç¨‹å®Œæ•´ä¸”å®¹æ˜“å¸æ”¶",       // NEW
                "å•å·Q5:èª²ç¨‹ç¸½è©•åƒ¹",                // NEW
                "å•å·Q6:å…¶ä»–å»ºè­°äº‹é …",              // NEW
                "è¨»å†Šè€…ID"
            ];
            
            // ç²å–ä¸¦æ ¼å¼åŒ–è¡Œæ•¸æ“š
            const rows = data.map(reg => {
                const registrationTime = formatTimestamp(reg.timestamp);
                
                const morningCheckInTimeStr = formatTimestamp(reg.morningCheckInTime);
                const afternoonCheckInTimeStr = formatTimestamp(reg.afternoonCheckInTime);
                const afternoonCheckOutTimeStr = formatTimestamp(reg.afternoonCheckOutTime);
                
                // æ–°å¢ï¼šæ˜¯å¦ç°½åˆ°/ç°½é€€çš„è¨»è¨˜
                const isMorningCheckedIn = reg.morningCheckInTime ? 'æ˜¯' : 'å¦';
                const isAfternoonCheckedIn = reg.afternoonCheckInTime ? 'æ˜¯' : 'å¦';
                const isAfternoonCheckedOut = reg.afternoonCheckOutTime ? 'æ˜¯' : 'å¦';


                // ä½¿ç”¨ JSON.stringify ä¸¦æ›¿æ›æ‰å¼•è™Ÿï¼Œä»¥æ­£ç¢ºè™•ç†åŒ…å«é€—è™Ÿçš„å­—ä¸²
                const cleanAndQuote = (str) => `"${String(str).replace(/"/g, '""')}"`;
                
                return [
                    cleanAndQuote(registrationTime),
                    cleanAndQuote(reg.school || ''),
                    cleanAndQuote(reg.name || ''),
                    cleanAndQuote(reg.id_number || ''),
                    cleanAndQuote(reg.phone || ''),
                    cleanAndQuote(reg.meal || ''),
                    cleanAndQuote(reg.question || ''),
                    
                    cleanAndQuote(isMorningCheckedIn),      
                    cleanAndQuote(morningCheckInTimeStr),   
                    
                    cleanAndQuote(isAfternoonCheckedIn),    
                    cleanAndQuote(afternoonCheckInTimeStr), 

                    cleanAndQuote(isAfternoonCheckedOut),   
                    cleanAndQuote(afternoonCheckOutTimeStr),
                    
                    cleanAndQuote(reg.surveyQ1), // NEW
                    cleanAndQuote(reg.surveyQ2), // NEW
                    cleanAndQuote(reg.surveyQ3), // NEW
                    cleanAndQuote(reg.surveyQ4), // NEW
                    cleanAndQuote(reg.surveyQ5), // NEW
                    cleanAndQuote(reg.surveyQ6), // NEW

                    cleanAndQuote(reg.registeredBy || '')
                ];
            });

            // çµåˆæ¨™é ­å’Œè¡Œæ•¸æ“š
            const csvContent = [
                headers.join(','), // æ¨™é ­
                ...rows.map(e => e.join(',')) // è¡Œæ•¸æ“š
            ].join('\n');

            // è§¸ç™¼ä¸‹è¼‰
            // "\ufeff" æ˜¯ BOMï¼Œç¢ºä¿ä¸­æ–‡åœ¨ Excel ä¸­æ­£ç¢ºé¡¯ç¤º
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            const now = new Date();
            const fileName = `ç ”ç¿’å ±åèˆ‡å•å·æ¸…å–®_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.csv`;
            
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            displayMessage('å ±åèˆ‡å•å·æ¸…å–®å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆï¼', 'success');
        }


        // --- äº‹ä»¶ç›£è½å™¨å’Œå•Ÿå‹• ---
        
        form.addEventListener('submit', handleFormSubmit);
        
        // æ»¿æ„åº¦èª¿æŸ¥äº‹ä»¶ (NEW)
        enterSurveyButton.addEventListener('click', handleEnterSurvey);
        closeSurveyFormButton.addEventListener('click', hideSurveyModal);
        surveyForm.addEventListener('submit', handleSurveySubmit);
        
        // å¾Œå°é€²å…¥èˆ‡æ“ä½œ
        accessBackendButton.addEventListener('click', handleAccessBackend); // é»æ“Šé€²å…¥ç³»çµ±
        confirmBackendAccessButton.addEventListener('click', handleConfirmBackendAccess); // ç¢ºèªå¯†ç¢¼
        exportCsvButton.addEventListener('click', fetchDataAndExportToCsv); // åŒ¯å‡º CSV (å·²é€²å…¥å¾Œå°ï¼Œç„¡éœ€å†æ¬¡å¯†ç¢¼)
        
        // æ¸…ç©ºè³‡æ–™ (éœ€è¦äºŒæ¬¡ç¢ºèªï¼Œæ‰€ä»¥åªè§¸ç™¼å½ˆçª—)
        clearDataButton.addEventListener('click', () => {
             showConfirmModal('æ¸…ç©ºç¢ºèª', 'æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±åç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼', 'clearData');
        }); 
        
        // æ¸…ç©ºç°½åˆ°/ç°½é€€ (éœ€è¦äºŒæ¬¡ç¢ºèª)
        clearSignaturesButton.addEventListener('click', () => {
             showConfirmModal('æ¸…ç©ºç°½åˆ°/ç°½é€€ç¢ºèª', 'æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å ±åç´€éŒ„ä¸­çš„ç°½åˆ°å’Œç°½é€€æ™‚é–“å—ï¼Ÿæ­¤æ“ä½œæœƒå°‡æ‰€æœ‰ç°½åˆ°ç‹€æ…‹é‚„åŸç‚ºã€Œæœªç°½åˆ°ã€ã€‚', 'clearSignatures');
        }); 
        
        // **NEW: é‚„åŸæ™‚é–“è¨­å®šæŒ‰éˆ•**
        resetTimeSettingsButton.addEventListener('click', () => {
            if (!areSettingsVisible) {
                displayMessage('è«‹å…ˆé€éå¯†ç¢¼å­˜å–è¨­å®šå€å¡Šã€‚', 'error');
                return;
            }
            showConfirmModal('é‡è¨­æ™‚é–“ç¢ºèª', 'æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç°½åˆ°/ç°½é€€çš„é–‹æ”¾æ™‚é–“è¨­å®šå—ï¼Ÿæ¸…é™¤å¾Œï¼Œè«‹é‡æ–°è¨­å®šæ™‚é–“å€é–“ã€‚', 'resetTime');
        });

        // å–æ¶ˆå ±åæŒ‰éˆ•
        document.getElementById('cancelRegistrationButton').addEventListener('click', handleCancelRegistration);
        
        // å­¸åˆ†æŸ¥è©¢æŒ‰éˆ• (NEW)
        document.getElementById('creditQueryButton').addEventListener('click', handleCreditQuery);
        
        // æ–°å¢æœƒå“¡æŒ‰éˆ• (NEW)
        addMemberButton.addEventListener('click', handleAddMember);
        cancelAddMemberButton.addEventListener('click', hideAddMemberModal);
        confirmAddMemberButton.addEventListener('click', handleConfirmAddMember);


        // äºŒæ¬¡ç¢ºèªå½ˆçª—æŒ‰éˆ•
        cancelConfirmButton.addEventListener('click', hideConfirmModal); // å–æ¶ˆæ¸…ç©º
        executeConfirmButton.addEventListener('click', () => {
            const action = executeConfirmButton.getAttribute('data-action');
            if (action === 'clearData') {
                deleteAllRegistrations();
            } else if (action === 'clearSignatures') {
                clearAllSignatures();
            } else if (action === 'resetTime') {
                handleResetTimeSettings();
            }
        }); // ç¢ºå®šåŸ·è¡Œæ“ä½œ

        // ç°½åˆ°/ç°½é€€åŠŸèƒ½
        morningCheckInButton.addEventListener('click', handleMorningCheckIn);
        afternoonCheckInButton.addEventListener('click', handleAfternoonCheckIn);
        afternoonCheckOutButton.addEventListener('click', handleAfternoonCheckOut);
        
        // ç³»çµ±è¨­å®šåŠŸèƒ½
        toggleSettingsButton.addEventListener('click', handleToggleSettings); // é»æ“Šé¡¯ç¤º/éš±è—è¨­å®šå€å¡Š
        confirmSettingsAccessButton.addEventListener('click', handleConfirmSettingsAccess); // å¯†ç¢¼é©—è­‰å­˜å–
        saveSettingsButton.addEventListener('click', handleSaveSettings); // å„²å­˜è¨­å®šäº‹ä»¶

        // å½ˆçª—é—œé–‰
        closeModalButton.addEventListener('click', hideSuccessModal);
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideSuccessModal(); // é»æ“ŠèƒŒæ™¯å€åŸŸä¹Ÿé—œé–‰
            }
        });
        
        // ç°½åˆ°/ç°½é€€å½ˆçª—é—œé–‰
        closeSignModalButton.addEventListener('click', hideSignSuccessModal);
        signSuccessModal.addEventListener('click', (e) => {
            if (e.target === signSuccessModal) {
                hideSignSuccessModal();
            }
        });

        // å ±åéŒ¯èª¤å½ˆçª—é—œé–‰
        closeErrorModalButton.addEventListener('click', hideErrorModal);
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                hideErrorModal();
            }
        });
        
        // æ¸…ç©ºç¢ºèªå½ˆçª—é—œé–‰
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                hideConfirmModal();
            }
        });


        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeFirebase();

    </script>

</body></html>