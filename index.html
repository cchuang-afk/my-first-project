<!DOCTYPE html>
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄市115年度學校護理人員寒假繼續教育研習課程報名</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* 使用 Inter 字體作為主要字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* 主標題樣式 */
        .main-header {
            background-color: #0ea5e9; /* Sky 500 */
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* 彈窗背景層的動畫效果 */
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        /* 彈窗內容的動畫效果 */
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-50px);
            opacity: 0;
        }
        .modal-open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <!-- 主容器 -->
    <div class="min-h-screen flex flex-col items-center">
        <!-- 固定頂部標題欄 -->
        <header class="main-header w-full text-center">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">高雄市115年度學校護理人員寒假繼續教育研習課程報名</h1>
                <p class="text-sky-100 mt-1 text-lg">請填寫您的報名資訊</p>
            </div>
        </header>

        <main class="w-full max-w-4xl p-4 sm:p-8">
            
            <!-- 報名表單區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">報名表單</h2>

                <form id="registrationForm" class="space-y-4">
                    
                    <!-- 學校欄位 -->
                    <div>
                        <label for="school" class="block text-sm font-medium text-gray-700 mb-1">學校 (School)</label>
                        <input type="text" id="school" name="school" placeholder="請輸入學校名稱" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- 姓名欄位 -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名 (Name)</label>
                        <input type="text" id="name" name="name" placeholder="請輸入您的姓名" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- 身份證字號欄位 -->
                    <div>
                        <label for="id_number" class="block text-sm font-medium text-gray-700 mb-1">身份證字號 (ID Number)</label>
                        <input type="text" id="id_number" name="id_number" placeholder="請輸入身份證字號 (例如: A123456789)" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 uppercase">
                        <p class="mt-1 text-xs text-gray-500">格式: 1位大寫英文字母 + 9位數字</p>
                    </div>

                    <!-- 手機號碼欄位 -->
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">手機 (Phone Number)</label>
                        <input type="tel" id="phone" name="phone" placeholder="請輸入手機號碼 (例如: 0912345678)" required="" maxlength="10" pattern="[0-9]{10}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                        <p class="mt-1 text-xs text-gray-500">格式: 10位數字 (例如 09xxxxxxxx)</p>
                    </div>
                    
                    <!-- 中午餐點 -->
                    <div>
                        <label for="meal" class="block text-sm font-medium text-gray-700 mb-1">中午餐點 (Meal)</label>
                        <select id="meal" name="meal" required="" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                            <option value="葷食">葷食</option>
                            <option value="素食">素食</option>
                        </select>
                    </div>

                    <!-- 想請教講師問題 (選填) -->
                    <div>
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1">想請教講師問題 (Question) (選填)</label>
                        <textarea id="question" name="question" placeholder="請詳細具體說明您想請教講師的問題" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 h-24"></textarea>
                    </div>
                    
                    <!-- 提交按鈕 -->
                    <button type="submit" id="submitButton" class="w-full bg-sky-600 text-white py-3 mt-6 rounded-xl font-semibold hover:bg-sky-700 transition duration-200 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50">
                        立即報名
                    </button>
                </form>
            </div>

            <!-- 研習活動簽到區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">研習活動簽到</h2>

                <div class="space-y-4">
                    <div>
                        <label for="sign_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            簽到/簽退身份證字號 (ID Number)
                        </label>
                        <input type="text" id="sign_id_number" placeholder="請輸入身份證字號進行簽到或簽退" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 uppercase">
                    </div>
                    
                    <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 pt-2">
                        <button id="morningCheckInButton" type="button" class="w-full sm:w-1/3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50">
                            上午簽到
                        </button>
                        <button id="afternoonCheckInButton" type="button" class="w-full sm:w-1/3 bg-yellow-600 text-white py-3 rounded-xl font-semibold hover:bg-yellow-700 transition duration-200 shadow-md disabled:opacity-50">
                            下午簽到
                        </button>
                        <button id="afternoonCheckOutButton" type="button" class="w-full sm:w-1/3 bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition duration-200 shadow-md disabled:opacity-50">
                            下午簽退
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 滿意度調查區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">滿意度調查</h2>

                <div class="space-y-4">
                    <div>
                        <label for="survey_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            身份證字號 (ID Number)
                        </label>
                        <input type="text" id="survey_id_number" placeholder="請輸入身份證字號以填寫問卷" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 uppercase">
                    </div>

                    <button id="enterSurveyButton" type="button" class="w-full bg-green-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-green-600 transition duration-200 shadow-lg disabled:opacity-50">
                        進入填寫滿意度調查表
                    </button>
                </div>
            </div>
            
            <!-- 取消報名區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">取消報名</h2>

                <div class="space-y-4">
                    <div>
                        <label for="cancel_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            欲取消報名者的身份證字號 (ID Number)
                        </label>
                        <input type="text" id="cancel_id_number" placeholder="請輸入身份證字號以取消報名" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150 uppercase">
                    </div>

                    <button id="cancelRegistrationButton" type="button" class="w-full bg-red-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-red-600 transition duration-200 shadow-lg disabled:opacity-50">
                        確定取消報名
                    </button>
                </div>
            </div>

            <!-- 學分查詢區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">學分查詢 <span class="text-sm font-normal text-gray-500">(查詢開放時間將另行公布)</span></h2>

                <div class="space-y-4">
                    <div>
                        <label for="query_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            身份證字號 (ID Number)
                        </label>
                        <input type="text" id="query_id_number" placeholder="請輸入身份證字號以查詢學分狀態" required="" maxlength="10" pattern="[A-Z][0-9]{9}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 uppercase">
                    </div>

                    <button id="creditQueryButton" type="button" class="w-full bg-purple-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-purple-600 transition duration-200 shadow-lg disabled:opacity-50">
                        查詢學分申請狀態
                    </button>
                </div>
            </div>
            
            <!-- 時間簽到設定區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-700">時間簽到設定</h2>
                    <button id="toggleSettingsButton" type="button" class="px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                        設定時間
                    </button>
                </div>
                <!-- 密碼驗證區塊 (修正：補回 ID 以應對 script) -->
                <div id="settingsAccessSection" class="hidden p-4 mt-4 bg-yellow-50 border border-yellow-300 rounded-xl shadow-inner">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="settingsAccessPassword" placeholder="輸入管理密碼..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg">
                        <button id="confirmSettingsAccessButton" type="button" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-md">確認存取</button>
                    </div>
                    <p id="accessError" class="text-red-600 text-xs mt-2 hidden">密碼錯誤。</p>
                </div>
                <div class="space-y-4 hidden mt-4" id="settingsInputsContainer">
                    <div class="space-y-2 border-b pb-4 border-amber-100">
                        <label class="block text-sm font-bold text-gray-700">簽到/簽退開放區間設定</label>
                        <p class="text-xs text-gray-500">請前往下方「進入系統」設定具體起訖時間。</p>
                    </div>
                    <div class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner space-y-2 text-center">
                        <button id="saveSettingsButton" type="button" class="w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 shadow-md">儲存設定</button>
                        <button id="resetTimeSettingsButton" type="button" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md">還原時間設定</button>
                    </div>
                </div>
            </div>

            <!-- 後台資料操作區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">後台資料操作</h2>
                    <button id="accessBackendButton" type="button" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-md disabled:opacity-50">
                        進入系統
                    </button>
                </div>
                <!-- 密碼輸入區塊 (修正：補回 HTML 以應對 script) -->
                <div id="passwordSection" class="hidden p-4 mt-4 bg-gray-50 border border-red-300 rounded-lg shadow-inner">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="backendPassword" placeholder="輸入後台密碼..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg">
                        <button id="confirmBackendAccessButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md">確認進入</button>
                    </div>
                    <p id="backendAccessError" class="text-red-600 text-xs mt-2 hidden">密碼錯誤。</p>
                </div>
                <div id="backendContent" class="hidden space-y-6 mt-6 pt-4 border-t border-gray-200">
                    <div class="flex flex-wrap gap-2">
                        <button id="exportCsvButton" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md">匯出 CSV</button>
                        <button id="clearDataButton" type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md">清空報名資料</button>
                        <button id="clearSignaturesButton" type="button" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-md">清除簽到/簽退</button>
                        <button id="addMemberButton" type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md">新增會員</button>
                    </div>
                </div>
            </div>
        </main>

        <p class="mt-4 text-xs text-gray-400">
            <span class="font-semibold">當前使用者 ID:</span> <span id="currentUserId">N/A</span>
        </p>
    </div>

    <!-- 備註說明引導彈窗 -->
    <div id="introModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-bg bg-gray-900/70" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-2xl border-t-8 border-sky-500 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center">
                <svg class="w-8 h-8 text-sky-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                備註說明
            </h3>
            <div class="space-y-4 text-gray-700 leading-relaxed text-left">
                <div class="bg-sky-50 p-4 rounded-xl border border-sky-100">
                    <p><span class="font-bold text-sky-700">研習時間：</span>115年1月27日(週二)</p>
                    <p><span class="font-bold text-sky-700">研習地點：</span>國立鳳新高中演奏廳</p>
                </div>
                <div class="bg-amber-50 p-4 rounded-xl border border-amber-100">
                    <p class="font-bold text-amber-800 mb-1">報名時間與限制：</p>
                    <p>自 <span class="text-red-600 font-semibold">1/5 (一) 08:00</span> 開放報名</p>
                    <p>至 <span class="text-red-600 font-semibold">1/9 (五) 16:00</span> 截止報名</p>
                    <p class="mt-2 text-sm italic underline">※ 限額 350 人</p>
                </div>
                <div class="text-sm border-l-4 border-sky-500 pl-4 py-1">
                    <p>以 <span class="font-bold">"115年有效會員資格"</span> 報名錄取。</p>
                    <p class="mt-2 text-sky-600 font-medium">貼心提醒：</p>
                    <p>尚未繳交 115 年年費者，請於課程報名結束前至總務組完成繳交年費，始得參加研習報到。</p>
                </div>
            </div>
            <button id="closeIntroButton" type="button" class="w-full bg-sky-600 text-white py-4 mt-8 rounded-xl font-bold text-lg hover:bg-sky-700 transition duration-200 shadow-lg transform active:scale-95">確定並進入系統</button>
        </div>
    </div>

    <!-- 滿意度調查彈窗 -->
    <div id="surveyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-2xl p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-green-500 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">研習滿意度調查表</h3>
            <p id="surveyUserDisplay" class="text-lg font-semibold text-green-700 mb-6">填寫人: N/A</p>
            <form id="surveyForm" class="space-y-4 text-left">
                <input type="hidden" id="surveyHiddenIdNumber">
                <div id="surveyQuestionsContainer" class="space-y-3">
                    <div class="border p-3 rounded-lg bg-gray-50"><p class="font-medium text-gray-800 mb-2">1. 對於本課程內容應用於實際工作感到滿意度</p><div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600"><label><input type="radio" name="q1" value="非常滿意" required><span>非常滿意</span></label><label><input type="radio" name="q1" value="滿意"><span>滿意</span></label><label><input type="radio" name="q1" value="普通"><span>普通</span></label><label><input type="radio" name="q1" value="不滿意"><span>不滿意</span></label><label><input type="radio" name="q1" value="非常不滿意"><span>非常不滿意</span></label></div></div>
                    <div class="border p-3 rounded-lg bg-gray-50"><p class="font-medium text-gray-800 mb-2">2. 本次課程講師對課程主題之專業能力</p><div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600"><label><input type="radio" name="q2" value="非常滿意" required><span>非常滿意</span></label><label><input type="radio" name="q2" value="滿意"><span>滿意</span></label><label><input type="radio" name="q2" value="普通"><span>普通</span></label></div></div>
                    <div class="border p-3 rounded-lg bg-gray-50"><p class="font-medium text-gray-800 mb-2">5. 本次課程總評價</p><div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600"><label><input type="radio" name="q5" value="非常滿意" required><span>非常滿意</span></label><label><input type="radio" name="q5" value="滿意"><span>滿意</span></label><label><input type="radio" name="q5" value="普通"><span>普通</span></label></div></div>
                </div>
                <div><label for="survey_q6" class="block text-sm font-medium text-gray-700 mb-1">6. 其他建議事項 (選填)</label><textarea id="survey_q6" name="q6" placeholder="請輸入任何建議或意見" class="w-full px-4 py-2 border border-gray-300 rounded-lg h-28"></textarea></div>
                <button type="submit" id="submitSurveyButton" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition duration-200">送出問卷</button>
                <button type="button" id="closeSurveyFormButton" class="w-full bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold mt-2">取消填寫</button>
            </form>
        </div>
    </div>

    <!-- 各類回饋彈窗 -->
    <div id="errorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50"><div class="modal-content bg-white w-full max-w-md p-6 rounded-xl text-center border-t-4 border-red-500"><h3 class="text-3xl font-bold text-gray-800 mb-2" id="errorTitle">錯誤</h3><p id="errorMessage" class="text-gray-600 mb-6"></p><button id="closeErrorModalButton" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold shadow-md">確定</button></div></div>
    <div id="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50"><div class="modal-content bg-white w-full max-w-md p-6 rounded-xl text-center"><h3 class="text-3xl font-bold text-gray-800 mb-2">報名成功！</h3><p class="text-gray-600 mb-6">您已成功完成研習報名。</p><button id="closeModalButton" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold shadow-md">確定</button></div></div>
    <div id="signSuccessModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50"><div class="modal-content bg-white w-full max-w-md p-6 rounded-xl text-center"><h3 class="text-3xl font-bold text-gray-800 mb-2" id="signSuccessTitle">操作成功</h3><p id="signSuccessMessage" class="text-gray-600 mb-6"></p><button id="closeSignModalButton" class="w-full bg-sky-500 text-white py-2 rounded-lg font-semibold shadow-md">確定</button></div></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDoc, getDocs, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 管理密碼
        const EXPORT_PASSWORD = '661113'; 
        
        // ** 最新報名會員白名單 **
        const REGISTRATION_ID_WHITELIST = ['E220689602', 'T220124877', 'E222232843', 'Q221352970', 'S221676093', 'F224680982', 'E221355543', 'E222235022', 'S223498373', 'Q221048248', 'S222760754', 'E223009017', 'C220273728', 'T220619308', 'R221516895', 'R222526617', 'M221390351', 'E222704219', 'T220742151', 'Q221349795', 'E222139623', 'E221680327', 'P221697848', 'U220722810', 'S221512389', 'E220877353', 'B221875305', 'S221023798', 'T220606785', 'T222325229', 'T220257424', 'E221163769', 'N220244548', 'T221185696', 'G220794119', 'T222542444', 'Q221421854', 'E223198671', 'E221613399', 'E221577969', 'T220754633', 'E220913836', 'E224700960', 'S222428662', 'E221778500', 'E222072534', 'S220983179', 'S220235285', 'N222547846', 'E221672861', 'R221313581', 'E223478450', 'S222222820', 'A220710340', 'R220277835', 'E222570295', 'J220066489', 'P220940304', 'S222097158', 'E221803053', 'S220200577', 'E220297962', 'T220184079', 'R222456914', 'B220716558', 'R220035435', 'E222566782', 'E223691435', 'E221385792', 'S220209632', 'E220741983', 'R222599727', 'A220444341', 'T222322853', 'S221794032', 'S222256291', 'S221584812', 'T220149623', 'R221804907', 'L222419863', 'C220033144', 'E222448681', 'P222200385', 'S220228520', 'S222108325', 'R220841362', 'T221520775', 'S220224808', 'S222894791', 'V220445720', 'S225056088', 'S220261632', 'E221136539', 'S222385279', 'E220079704', 'X220049013', 'L221450039', 'E222327570', 'E220616789', 'S220940085', 'E220308460', 'R221566288', 'T221761365', 'T220643493', 'S220228422', 'S220424808', 'R223244730', 'N224134623', 'S221829334', 'E222670432', 'E221836052', 'S220186590', 'T222361010', 'L222150396', 'R222723812', 'S221613023', 'P220795603', 'S222571471', 'S222561091', 'A223395916', 'S220408288', 'R220924893', 'S220218588', 'E222066303', 'E222566675', 'S222313773', 'T222280912', 'S222248164', 'M221660465', 'Q222573080', 'E222536677', 'S220773502', 'S222132616', 'T222334335', 'H221334878', 'E223327092', 'R222149183', 'U220728536', 'S222324918', 'S220227238', 'T223014636', 'S222213312', 'S223356147', 'T220577949', 'B221770734', 'S220200817', 'S224339355', 'R222945578', 'T222347538', 'S220501588', 'S220516981', 'T223230489', 'S220573404', 'S220375444', 'S220456542', 'S220796023', 'A223752966', 'T223450329', 'E220388084', 'S220694766', 'R220067231', 'E222177025', 'E222452434', 'S222380425', 'E222258963', 'S224055096', 'S222376396', 'T221459708', 'S221069098', 'S221279432', 'S221363260', 'R221644143', 'S221280328', 'S221283356', 'S221436419', 'S221334429', 'P222391103', 'B220564616', 'E221070992', 'S220951668', 'S221625514', 'E222635102', 'S222386221', 'S221222424', 'S222389053', 'S220692753', 'T222592042', 'S221847903', 'U220822253', 'S220901177', 'S221337626', 'S222380407', 'R221035386', 'S221134796', 'S221396929', 'R220503858', 'Q220793280', 'S221493816', 'S223124912', 'E221059948', 'S223404095', 'S222426006', 'S221715988', 'S222300598', 'S221578485', 'R220443428', 'S223647661', 'S222451803', 'A221690507', 'P220716675', 'S221920452', 'S221809270', 'S221687612', 'S222798776', 'S223044455', 'S222140350', 'S222140172', 'T220910579', 'D222011281', 'S223823876', 'S224725842', 'S222067936', 'S222069850', 'S223173004', 'T222350946', 'S223472897', 'W200265559', 'D221368665', 'T222175998', 'S222712641', 'G221261379', 'S223458262', 'E221263095', 'E222059559', 'S220171722', 'S221088137', 'R224258676', 'L222905382', 'E221304644', 'S222724016', 'S221981777', 'X220083908', 'S222670317', 'E223130393', 'E222155949', 'S222255927', 'E220961056', 'T223340113', 'R221887022', 'S222140350', 'S222142498', 'S222451509', 'T221718426', 'S220303920', 'V220877482', 'P220185590', 'D221792812', 'T223562619', 'E223016254', 'Q222965355', 'T222634198', 'S221989719', 'S120099116', 'E224586111', 'E222435237', 'D221823723', 'M221636843', 'F224168089', 'E220341689', 'N224125759', 'E221050972', 'T223121994', 'F223485974', 'S221614879', 'B222409118', 'E223335889', 'S223702489', 'E223830058', 'S223031047', 'E223272403', 'R223039382', 'S222547457', 'Q222027841', 'H221939300', 'A224117621', 'E220843580', 'S223039927', 'E221221784', 'H222198063', 'S223445943', 'S223473661', 'S220323075', 'E226866087', 'T222641371', 'S223513517', 'S222899492', 'S222841718', 'F224623012', 'E222796093', 'D222243694', 'T223321789', 'R223489784', 'C221179925', 'N222642051', 'T223268741', 'E222873899', 'S223738952', 'D221280353', 'Q223147922', 'E223236452', 'E223477300', 'F225807610', 'R224394971', 'S223503039', 'E222841084', 'E220342293', 'S223904287', 'S222557873', 'L220395735', 'S222327188', 'E222407411', 'I200051735', 'D221848444', 'S222894933', 'T223143874', 'T222835364', 'T222334415', 'S222285907', 'D222987959', 'E222177570', 'E222891164', 'T223208227', 'E222884525', 'E122740419', 'P223101916', 'M222116706', 'T223363456', 'E220666234', 'E222112015', 'N222975591', 'E220210483', 'S222658357', 'T223501349', 'S223345484', 'L223725235', 'Q222955911', 'S224279407', 'M221800852', 'S223811885', 'R222639495', 'S224081149', 'T221102213', 'E222988108', 'S222701282', 'S222171239', 'T223686445', 'E222277342', 'S223577664', 'T222833100', 'Q222681998', 'S220489514', 'G221383236', 'N222752856', 'E222104791', 'E222150962', 'M222018107', 'S223918905', 'E124843842', 'E223669737', 'S224644459', 'S223517337', 'D221353191', 'E224518604', 'E224800616', 'E221368586', 'N225495223', 'E223277588', 'S224714625', 'E223175409', 'S222765679', 'N224781506', 'T223435028', 'F227465496', 'E224015135', 'L225440226', 'S222530756', 'T223476403', 'M221599596', 'Q222649374', 'E220393996', 'S222829507', 'Q223320127'];

        let db, auth, userId = 'anonymous', isAuthReady = false;
        let morningCheckInStartTime, morningCheckInEndTime, afternoonCheckInStartTime, afternoonCheckInEndTime, afternoonCheckOutStartTime, afternoonCheckOutEndTime;

        const firebaseConfig = {
            apiKey: "AIzaSyBlqR82MrYJB_SCIrlSxdcUdDrW6K96TrE",
            authDomain: "csvs-8b55d.firebaseapp.com",
            projectId: "csvs-8b55d",
            storageBucket: "csvs-8b55d.firebasestorage.app",
            messagingSenderId: "93064933978",
            appId: "1:93064933978:web:226fc3a8a271b2a4975e63",
            measurementId: "G-W2ZJKEMPV4"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function init() {
            // 顯示備註說明視窗
            const introModal = document.getElementById('introModal');
            if(introModal) {
                introModal.classList.remove('hidden');
                setTimeout(() => introModal.classList.add('modal-open'), 10);
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const display = document.getElementById('currentUserId');
                    if(display) display.textContent = userId;
                    isAuthReady = true;
                    await fetchSettings();
                } else {
                    await signInAnonymously(auth);
                }
            });
            
            // 綁定事件 (確保元素存在後綁定)
            setupEventListeners();
        }

        function setupEventListeners() {
            // 後台進入
            const accessBackendBtn = document.getElementById('accessBackendButton');
            if(accessBackendBtn) {
                accessBackendBtn.onclick = () => {
                    const section = document.getElementById('passwordSection');
                    if(section) section.classList.remove('hidden');
                };
            }

            const confirmBackendBtn = document.getElementById('confirmBackendAccessButton');
            if(confirmBackendBtn) {
                confirmBackendBtn.onclick = () => {
                    const pwInput = document.getElementById('backendPassword');
                    const err = document.getElementById('backendAccessError');
                    const content = document.getElementById('backendContent');
                    const section = document.getElementById('passwordSection');
                    if (pwInput && pwInput.value === EXPORT_PASSWORD) {
                        if(content) content.classList.remove('hidden');
                        if(section) section.classList.add('hidden');
                        if(err) err.classList.add('hidden');
                    } else {
                        if(err) err.classList.remove('hidden');
                    }
                };
            }

            // 設定存取
            const toggleSettingsBtn = document.getElementById('toggleSettingsButton');
            if(toggleSettingsBtn) {
                toggleSettingsBtn.onclick = () => {
                    const section = document.getElementById('settingsAccessSection');
                    if(section) section.classList.toggle('hidden');
                };
            }

            const confirmSettingsBtn = document.getElementById('confirmSettingsAccessButton');
            if(confirmSettingsBtn) {
                confirmSettingsBtn.onclick = () => {
                    const pwInput = document.getElementById('settingsAccessPassword');
                    const inputs = document.getElementById('settingsInputsContainer');
                    const section = document.getElementById('settingsAccessSection');
                    const err = document.getElementById('accessError');
                    if (pwInput && pwInput.value === EXPORT_PASSWORD) {
                        if(inputs) inputs.classList.remove('hidden');
                        if(section) section.classList.add('hidden');
                        if(err) err.classList.add('hidden');
                    } else {
                        if(err) err.classList.remove('hidden');
                    }
                };
            }

            // 關閉引導視窗
            const closeIntroBtn = document.getElementById('closeIntroButton');
            if(closeIntroBtn) {
                closeIntroBtn.onclick = () => {
                    const introModal = document.getElementById('introModal');
                    if(introModal) {
                        introModal.classList.remove('modal-open');
                        setTimeout(() => introModal.classList.add('hidden'), 300);
                    }
                };
            }
            
            // 彈窗關閉按鈕
            const closeSuccessBtn = document.getElementById('closeModalButton');
            if(closeSuccessBtn) closeSuccessBtn.onclick = () => document.getElementById('successModal').classList.add('hidden');
            const closeErrorBtn = document.getElementById('closeErrorModalButton');
            if(closeErrorBtn) closeErrorBtn.onclick = () => document.getElementById('errorModal').classList.add('hidden');
            const closeSignBtn = document.getElementById('closeSignModalButton');
            if(closeSignBtn) closeSignBtn.onclick = () => document.getElementById('signSuccessModal').classList.add('hidden');
            const closeSurveyBtn = document.getElementById('closeSurveyFormButton');
            if(closeSurveyBtn) closeSurveyBtn.onclick = () => {
                const modal = document.getElementById('surveyModal');
                if(modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('modal-open');
                }
            };
        }

        async function fetchSettings() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config');
            try {
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const d = snap.data();
                    morningCheckInStartTime = d.morningCheckInStartTime?.toDate();
                    morningCheckInEndTime = d.morningCheckInEndTime?.toDate();
                    afternoonCheckInStartTime = d.afternoonCheckInStartTime?.toDate();
                    afternoonCheckInEndTime = d.afternoonCheckInEndTime?.toDate();
                    afternoonCheckOutStartTime = d.afternoonCheckOutStartTime?.toDate();
                    afternoonCheckOutEndTime = d.afternoonCheckOutEndTime?.toDate();
                }
            } catch(e) { console.error("Fetch settings error:", e); }
        }

        // --- 報名邏輯 ---
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('id_number').value.trim().toUpperCase();
            if (!REGISTRATION_ID_WHITELIST.includes(id)) {
                showErrorModal('報名失敗', '您非會員無法報名，請洽會員組');
                return;
            }
            const btn = document.getElementById('submitButton');
            btn.disabled = true;
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), where('id_number', '==', id));
                const snap = await getDocs(q);
                if (!snap.empty) { showErrorModal('報名失敗', '您已報名過，請勿重複報名。'); return; }
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), {
                    school: document.getElementById('school').value,
                    name: document.getElementById('name').value,
                    id_number: id,
                    phone: document.getElementById('phone').value,
                    meal: document.getElementById('meal').value,
                    question: document.getElementById('question').value,
                    timestamp: new Date(),
                    registeredBy: userId
                });
                showSuccessModal();
                e.target.reset();
            } catch (err) { showErrorModal('錯誤', err.message); }
            finally { btn.disabled = false; }
        });

        // --- 簽到邏輯 ---
        async function sign(type, field) {
            const idInput = document.getElementById('sign_id_number');
            const id = idInput ? idInput.value.trim().toUpperCase() : '';
            if (!id) return;
            const now = new Date();
            let start, end;
            if (type === 'morningCheckIn') { start = morningCheckInStartTime; end = morningCheckInEndTime; }
            else if (type === 'afternoonCheckIn') { start = afternoonCheckInStartTime; end = afternoonCheckInEndTime; }
            else { start = afternoonCheckOutStartTime; end = afternoonCheckOutEndTime; }
            if (!start || !end || now < start || now > end) { showErrorModal('操作失敗', '目前非開放時間。'); return; }
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), where('id_number', '==', id));
            const snap = await getDocs(q);
            if (snap.empty) { showErrorModal('失敗', '查無報名紀錄。'); return; }
            const d = snap.docs[0];
            if (d.data()[field]) { showErrorModal('重複操作', '您已完成過此項操作。'); return; }
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', d.id), { [field]: now });
            showSignSuccessModal('成功', '操作已完成。');
        }

        document.getElementById('morningCheckInButton').onclick = () => sign('morningCheckIn', 'morningCheckInTime');
        document.getElementById('afternoonCheckInButton').onclick = () => sign('afternoonCheckIn', 'afternoonCheckInTime');
        document.getElementById('afternoonCheckOutButton').onclick = () => sign('afternoonCheckOut', 'afternoonCheckOutTime');

        // --- 彈窗控制功能 ---
        function showSuccessModal() { document.getElementById('successModal').classList.remove('hidden'); }
        function showErrorModal(t, m) { 
            const title = document.getElementById('errorTitle');
            const msg = document.getElementById('errorMessage');
            const modal = document.getElementById('errorModal');
            if(title) title.textContent = t;
            if(msg) msg.textContent = m;
            if(modal) modal.classList.remove('hidden'); 
        }
        function showSignSuccessModal(t, m) {
            const title = document.getElementById('signSuccessTitle');
            const msg = document.getElementById('signSuccessMessage');
            const modal = document.getElementById('signSuccessModal');
            if(title) title.textContent = t;
            if(msg) msg.textContent = m;
            if(modal) modal.classList.remove('hidden');
        }

        // --- 滿意度調查進入 ---
        document.getElementById('enterSurveyButton').onclick = async () => {
            const idInput = document.getElementById('survey_id_number');
            const id = idInput ? idInput.value.trim().toUpperCase() : '';
            if (!id) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), where('id_number', '==', id));
            const snap = await getDocs(q);
            if (snap.empty) { showErrorModal('錯誤', '查無報名資料'); return; }
            const display = document.getElementById('surveyUserDisplay');
            const hiddenId = document.getElementById('surveyHiddenIdNumber');
            const modal = document.getElementById('surveyModal');
            if(display) display.textContent = `填寫人: ${snap.docs[0].data().name}`;
            if(hiddenId) hiddenId.value = id;
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('modal-open');
            }
        };

        init();
    </script>

</body></html>