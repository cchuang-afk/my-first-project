<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄市學校護理人員繼續教育研習課程報名網</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 使用 Inter 字體作為主要字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* 主標題樣式 */
        .main-header {
            background-color: #0ea5e9; /* Sky 500 */
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* 彈窗背景層的動畫效果 */
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        /* 彈窗內容的動畫效果 */
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-50px);
            opacity: 0;
        }
        .modal-open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* 後台清單表格樣式 */
        .backend-table th, .backend-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            text-align: left;
        }
        .backend-table th {
            background-color: #e5e7eb; /* Gray 200 */
            font-weight: 600;
            color: #374151; /* Gray 700 */
            text-transform: none;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <!-- 主容器 -->
    <div class="min-h-screen flex flex-col items-center">
        <!-- 固定頂部標題欄 -->
        <header class="main-header w-full">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">高雄市學校護理人員繼續教育研習課程報名網</h1>
                <p class="text-sky-100 mt-1 text-lg">請填寫您的報名資訊</p>
            </div>
        </header>

        <main class="w-full max-w-4xl p-4 sm:p-8">
            
            <!-- Firebase 狀態/錯誤訊息 -->
            <div id="statusMessage" class="w-full max-w-2xl mx-auto p-3 mb-6 rounded-lg text-center text-sm font-medium transition duration-300 card">
                正在初始化系統...
            </div>

            <!-- 報名表單區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">報名表單</h2>

                <form id="registrationForm" class="space-y-4">
                    
                    <!-- 學校欄位 -->
                    <div>
                        <label for="school" class="block text-sm font-medium text-gray-700 mb-1">學校 (School)</label>
                        <input type="text" id="school" name="school" placeholder="請輸入學校名稱" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- 姓名欄位 -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名 (Name)</label>
                        <input type="text" id="name" name="name" placeholder="請輸入您的姓名" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <!-- 身份證字號欄位 -->
                    <div>
                        <label for="id_number" class="block text-sm font-medium text-gray-700 mb-1">身份證字號 (ID Number)</label>
                        <input type="text" id="id_number" name="id_number" placeholder="請輸入身份證字號 (例如: A123456789)" required
                               maxlength="10" 
                               pattern="[A-Z][0-9]{9}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                        <p class="mt-1 text-xs text-gray-500">格式: 1位大寫英文字母 + 9位數字</p>
                    </div>
                    
                    <!-- 中午餐點 (NEW) -->
                    <div>
                        <label for="meal" class="block text-sm font-medium text-gray-700 mb-1">中午餐點 (Meal)</label>
                        <select id="meal" name="meal" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                            <option value="葷食">葷食</option>
                            <option value="素食">素食</option>
                        </select>
                    </div>

                    <!-- 想請教講師問題 (NEW - 非必要填寫) -->
                    <div>
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1">想請教講師問題 (Question) (選填)</label>
                        <textarea id="question" name="question" placeholder="請詳細具體說明您想請教講師的問題"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 h-24"></textarea>
                    </div>
                    
                    <!-- 提交按鈕 -->
                    <button type="submit" id="submitButton"
                            class="w-full bg-sky-600 text-white py-3 mt-6 rounded-xl font-semibold hover:bg-sky-700 transition duration-200 shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50"
                            disabled>
                        立即報名
                    </button>
                </form>
            </div>

            <!-- 研習活動簽到區塊 (更新為三階段) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">研習活動簽到</h2>

                <div class="space-y-4">
                    <!-- 身份證字號欄位 for Sign-In/Out -->
                    <div>
                        <label for="sign_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            簽到/簽退身份證字號 (ID Number)
                        </label>
                        <input type="text" id="sign_id_number" placeholder="請輸入身份證字號進行簽到或簽退" required
                               maxlength="10" 
                               pattern="[A-Z][0-9]{9}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                    </div>
                    
                    <!-- 簽到/簽退時間設定 (已移除，將使用系統當前時間) -->

                    <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 pt-2">
                        <!-- 上午簽到按鈕 -->
                        <button id="morningCheckInButton" type="button" disabled
                                class="w-full sm:w-1/3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50">
                            上午簽到 (研習兩天)
                        </button>
                        <!-- 下午簽到按鈕 -->
                        <button id="afternoonCheckInButton" type="button" disabled
                                class="w-full sm:w-1/3 bg-yellow-600 text-white py-3 rounded-xl font-semibold hover:bg-yellow-700 transition duration-200 shadow-md disabled:opacity-50">
                            下午簽到 (研習兩天)
                        </button>
                        <!-- 下午簽退按鈕 -->
                        <button id="afternoonCheckOutButton" type="button" disabled
                                class="w-full sm:w-1/3 bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition duration-200 shadow-md disabled:opacity-50">
                            下午簽退 (研習兩天)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 取消報名區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">取消報名</h2>

                <div class="space-y-4">
                    <!-- 身份證字號欄位 for 取消 -->
                    <div>
                        <label for="cancel_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            欲取消報名者的身份證字號 (ID Number)
                        </label>
                        <input type="text" id="cancel_id_number" placeholder="請輸入身份證字號以取消報名" required
                               maxlength="10" 
                               pattern="[A-Z][0-9]{9}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    </div>

                    <!-- 取消按鈕 -->
                    <button id="cancelRegistrationButton" type="button" disabled
                            class="w-full bg-red-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-red-600 transition duration-200 shadow-lg disabled:opacity-50">
                        確定取消報名
                    </button>
                </div>
            </div>

            <!-- 學分查詢區塊 (NEW) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">學分查詢 <span class="text-sm font-normal text-gray-500">(查詢開放時間將另行公布)</span></h2>

                <div class="space-y-4">
                    <!-- 身份證字號欄位 for 查詢 -->
                    <div>
                        <label for="query_id_number" class="block text-sm font-medium text-gray-700 mb-1">
                            身份證字號 (ID Number)
                        </label>
                        <input type="text" id="query_id_number" placeholder="請輸入身份證字號以查詢學分狀態" required
                               maxlength="10" 
                               pattern="[A-Z][0-9]{9}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                    </div>

                    <!-- 查詢按鈕 -->
                    <button id="creditQueryButton" type="button" disabled
                            class="w-full bg-purple-500 text-white py-3 mt-4 rounded-xl font-semibold hover:bg-purple-600 transition duration-200 shadow-lg disabled:opacity-50">
                        查詢學分申請狀態
                    </button>
                </div>
            </div>
            
            <!-- 系統設定區塊 (更新為密碼控管顯示) -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card mb-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-700">時間簽到設定</h2>

                    <!-- 1. 顯示/隱藏 按鈕 (樣式已調整為與匯出按鈕相近) -->
                    <button id="toggleSettingsButton" type="button" disabled
                            class="px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                        設定時間
                    </button>
                </div>
                
                <p class="mt-4 text-gray-500 text-sm">
                    點擊按鈕後輸入密碼，即可設定簽到/簽退的開放時間區間。
                </p>

                <!-- 2. 密碼驗證區塊 (預設隱藏) -->
                <div id="settingsAccessSection" class="hidden p-4 mt-4 bg-yellow-50 border border-yellow-300 rounded-xl shadow-inner">
                    <label for="settingsAccessPassword" class="block text-sm font-medium text-yellow-700 mb-2">
                        <span class="font-bold">🔒 密碼驗證：</span> 輸入密碼以存取設定。
                    </label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="settingsAccessPassword" placeholder="輸入密碼..."
                               class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150">
                        <button id="confirmSettingsAccessButton" type="button"
                                class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                            確認存取
                        </button>
                    </div>
                    <p id="accessError" class="text-red-600 text-xs mt-2 hidden">密碼錯誤，請重新輸入。</p>
                </div>
                
                <!-- 3. 時間設定輸入區塊 (預設隱藏，驗證成功後顯示) -->
                <div class="space-y-4 hidden mt-4" id="settingsInputsContainer">
                    
                    <!-- 上午簽到時間區間設定 -->
                    <div class="space-y-2 border-b pb-4 border-amber-100">
                        <label class="block text-sm font-bold text-gray-700">上午簽到開放區間 (Morning Check-in Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_morning_ci_start" class="block text-xs font-medium text-gray-500 mb-1">開始時間</label>
                                <input type="datetime-local" id="setting_morning_ci_start" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_morning_ci_end" class="block text-xs font-medium text-gray-500 mb-1">結束時間</label>
                                <input type="datetime-local" id="setting_morning_ci_end" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>

                    <!-- 下午簽到時間區間設定 -->
                    <div class="space-y-2 border-b pb-4 border-amber-100">
                        <label class="block text-sm font-bold text-gray-700">下午簽到開放區間 (Afternoon Check-in Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_afternoon_ci_start" class="block text-xs font-medium text-gray-500 mb-1">開始時間</label>
                                <input type="datetime-local" id="setting_afternoon_ci_start" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_afternoon_ci_end" class="block text-xs font-medium text-gray-500 mb-1">結束時間</label>
                                <input type="datetime-local" id="setting_afternoon_ci_end" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 下午簽退時間區間設定 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">下午簽退開放區間 (Afternoon Check-out Time Range)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="setting_afternoon_co_start" class="block text-xs font-medium text-gray-500 mb-1">開始時間</label>
                                <input type="datetime-local" id="setting_afternoon_co_start" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                            <div>
                                <label for="setting_afternoon_co_end" class="block text-xs font-medium text-gray-500 mb-1">結束時間</label>
                                <input type="datetime-local" id="setting_afternoon_co_end" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:focus:border-amber-500 transition duration-150">
                            </div>
                        </div>
                    </div>

                    <!-- 儲存/還原按鈕區塊 -->
                    <div id="settingsSaveSection" class="p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-inner space-y-2">
                        <label class="block text-sm font-medium text-yellow-700 mb-2">
                            <span class="font-bold">💾 設定操作：</span> 儲存或還原時間區間。
                        </label>
                        <button id="saveSettingsButton" type="button" disabled
                                class="w-full px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition duration-150 shadow-md disabled:opacity-50">
                            儲存設定
                        </button>
                        <button id="resetTimeSettingsButton" type="button" disabled
                                class="w-full px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-lg hover:bg-gray-600 transition duration-150 shadow-md disabled:opacity-50">
                            還原時間設定 (至預設值)
                        </button>
                    </div>
                </div>
            </div>

            <!-- 後台資料操作區塊 -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700 whitespace-nowrap">後台資料操作</h2>
                    
                    <!-- 進入系統按鈕 (預設顯示) -->
                    <button id="accessBackendButton" type="button" disabled
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50">
                        進入系統
                    </button>
                </div>
                
                <!-- 密碼輸入區塊 (通用) -->
                <div id="passwordSection" class="hidden p-4 mt-4 bg-gray-50 border border-red-300 rounded-lg shadow-inner">
                    <label for="backendPassword" class="block text-sm font-medium text-red-700 mb-2">
                        <span class="font-bold">🔒 密碼驗證：</span> 請輸入密碼以進入後台。
                    </label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="backendPassword" placeholder="輸入密碼..."
                               class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                        <button id="confirmBackendAccessButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                            確認進入
                        </button>
                    </div>
                    <p id="backendAccessError" class="text-red-600 text-xs mt-2 hidden">密碼錯誤，請重新輸入。</p>
                </div>

                <!-- 後台功能和清單區塊 (預設隱藏) -->
                <div id="backendContent" class="hidden space-y-6 mt-6 pt-4 border-t border-gray-200">
                    
                    <h3 class="text-xl font-semibold text-gray-700">操作按鈕</h3>
                    <div class="flex flex-wrap space-x-2 w-full justify-start mb-6">
                        <!-- 匯出 CSV 按鈕 -->
                        <button id="exportCsvButton" type="button"
                                class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            匯出 CSV
                        </button>
                        <!-- 清空報名資料按鈕 -->
                        <button id="clearDataButton" type="button"
                                class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            清空報名資料
                        </button>
                         <!-- 清除簽到/簽退按鈕 (NEW) -->
                        <button id="clearSignaturesButton" type="button"
                                class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            清除簽到/簽退
                        </button>
                        <!-- 新增會員按鈕 (NEW) -->
                        <button id="addMemberButton" type="button"
                                class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition duration-150 shadow-md mb-2 sm:mb-0">
                            新增會員
                        </button>
                    </div>

                    
                    <!-- 報名清單區塊 (已移除) -->
                    <div id="registrationsListContainer" class="overflow-x-auto shadow-inner rounded-lg border">
                        <p class="p-4 text-center text-gray-500">清單功能已移除。請使用上方按鈕匯出資料。</p>
                    </div>
                </div>

                <p id="backendInfoText" class="mt-4 text-gray-500 text-sm">
                    點擊「進入系統」並輸入密碼以查看報名者清單及管理資料。
                </p>
            </div>
        </main>

        <!-- 顯示 User ID 供協作用途 -->
        <p class="mt-4 text-xs text-gray-400">
            <span class="font-semibold">當前使用者 ID:</span> <span id="currentUserId">N/A</span>
        </p>

    </div>

    <!-- 非會員報名錯誤彈窗 (Modal) -->
    <div id="errorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-500">
            
            <!-- 錯誤圖標 (使用 SVG) -->
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.302 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="errorTitle">報名失敗</h3>
            <p class="text-gray-600 mb-6" id="errorMessage">您非會員無法報名，請洽會員組</p>

            <!-- 關閉按鈕 -->
            <button id="closeErrorModalButton" type="button"
                    class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-md">
                確定
            </button>
        </div>
    </div>

    <!-- 簽到/簽退成功彈窗 (Modal) -->
    <div id="signSuccessModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- 成功圖標 (使用 SVG) -->
            <svg class="w-16 h-16 text-sky-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2" id="signSuccessTitle">操作成功！</h3>
            <p class="text-gray-600 mb-6" id="signSuccessMessage">您已成功完成簽到/簽退。</p>

            <!-- 關閉按鈕 -->
            <button id="closeSignModalButton" type="button"
                    class="w-full bg-sky-500 text-white py-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-200 shadow-md">
                確定
            </button>
        </div>
    </div>
    
    <!-- 報名成功彈窗 (Modal) -->
    <div id="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            
            <!-- 成功圖標 (使用 SVG) -->
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>

            <h3 class="text-3xl font-bold text-gray-800 mb-2">報名成功！</h3>
            <p class="text-gray-600 mb-6">您已成功完成研習報名，謝謝您的參與。</p>

            <!-- 關閉按鈕 -->
            <button id="closeModalButton" type="button"
                    class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-200 shadow-md">
                確定
            </button>
        </div>
    </div>
    
    <!-- 確認操作彈窗 (用於清空資料前的二次確認) -->
    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-lg p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-red-600">
            
            <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>

            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="confirmTitle">確認操作</h3>
            <p class="text-gray-600 mb-6" id="confirmMessage">您確定要清空所有報名紀錄嗎？此操作無法復原！</p>

            <!-- 按鈕區塊 -->
            <div class="flex justify-center space-x-4">
                <button id="cancelConfirmButton" type="button"
                        class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 shadow-md">
                    取消
                </button>
                <button id="executeConfirmButton" type="button"
                        class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md">
                    確定清空
                </button>
            </div>
        </div>
    </div>

    <!-- 新增會員彈窗 (NEW) -->
    <div id="addMemberModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg bg-gray-900/50" aria-modal="true" role="dialog">
        <div class="modal-content bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl text-center border-t-4 border-green-500">
            
            <h3 class="text-2xl font-bold text-gray-800 mb-2">新增報名會員</h3>
            <p class="text-gray-600 mb-4">請輸入新的會員身份證字號，將其加入報名白名單。</p>

            <div class="space-y-3 text-left">
                <label for="newMemberIdInput" class="block text-sm font-medium text-gray-700">身份證字號 (ID Number)</label>
                <input type="text" id="newMemberIdInput" placeholder="例如: A123456789" required
                       maxlength="10" 
                       pattern="[A-Z][0-9]{9}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 uppercase">
                <p id="memberAddMessage" class="text-xs text-red-500 hidden mt-1"></p>
            </div>

            <!-- 按鈕區塊 -->
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancelAddMemberButton" type="button"
                        class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 shadow-md">
                    取消
                </button>
                <button id="confirmAddMemberButton" type="button"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md">
                    確認新增
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, orderBy, setDoc, getDoc, getDocs, where, updateDoc, doc, deleteDoc, onSnapshot, FieldValue, deleteField
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Log 級別為 Debug
        setLogLevel('debug');

        // --- 設定密碼與會員名單 ---
        const EXPORT_PASSWORD = '661113'; // 管理員密碼
        
        // ** 報名會員白名單 (基於身份證字號) **
        // 這是最新的身份證字號白名單，用於報名驗證
        const REGISTRATION_ID_WHITELIST = [
            'A220444341', 'A220710340', 'A221690507', 'A223395916', 'A223752966', 'A224117621',
            'B220564616', 'B220716558', 'B221770734', 'B221875305', 'B222409118', 'C220033144',
            'C220273728', 'C221179925', 'D221280353', 'D221353191', 'D221368665', 'D221792812',
            'D221823723', 'D221848444', 'D222011281', 'D222243694', 'D222371031', 'D222987959',
            'E122740419', 'E124843842', 'E220079704', 'E220195418', 'E220210483', 'E220297962',
            'E220308460', 'E220341689', 'E220342293', 'E220388084', 'E220393996', 'E220524099',
            'E220616789', 'E220666234', 'E220689602', 'E220741983', 'E220779674', 'E220843580',
            'E220877353', 'E220913836', 'E220961056', 'E221050972', 'E221059948', 'E221070992',
            'E221136539', 'E221163769', 'E221221784', 'E221263095', 'E221304644', 'E221355543',
            'E221368586', 'E221385792', 'E221408398', 'E221577969', 'E221613399', 'E221672861',
            'E221680327', 'E221778500', 'E221803053', 'E221836052', 'E222059559', 'E222066303',
            'E222072534', 'E222084463', 'E222104791', 'E222112015', 'E222139623', 'E222150962',
            'E222155949', 'E222177025', 'E222177570', 'E222232843', 'E222235022', 'E222258963',
            'E222277342', 'E222327570', 'E222407411', 'E222435237', 'E222448681', 'E222452434',
            'E222536677', 'E222566675', 'E222566782', 'E222570295', 'E222635102', 'E222670432',
            'E222704219', 'E222796093', 'E222805917', 'E222841084', 'E222873899', 'E222884525',
            'E222891164', 'E222959581', 'E222988108', 'E223009017', 'E223016254', 'E223091024',
            'E223130393', 'E223175409', 'E223198671', 'E223236452', 'E223272403', 'E223277588',
            'E223326871', 'E223327092', 'E223335889', 'E223477300', 'E223478450', 'E223526791',
            'E223669737', 'E223691435', 'E223830058', 'E223882347', 'E224015135', 'E224300540',
            'E224422630', 'E224518604', 'E224586111', 'E224700960', 'E224800616', 'E226866087',
            'F223485974', 'F224168089', 'F224229658', 'F224623012', 'F224680982', 'F225807610',
            'F226263872', 'F227465496', 'G220794119', 'G221261379', 'G221383236', 'H221334878',
            'H221939300', 'H222198063', 'I200051735', 'J220066489', 'K220138632', 'L220395735',
            'L221013063', 'L221450039', 'L222150396', 'L222419863', 'L222905382', 'L223725235',
            'L225440226', 'M221390351', 'M221598437', 'M221599596', 'M221636843', 'M221660465',
            'M221800852', 'M222018107', 'M222116706', 'N220244548', 'N222547846', 'N222642051',
            'N222752856', 'N222923122', 'N222975591', 'N224125759', 'N224134623', 'N224781506',
            'N225495223', 'P220185590', 'P220716675', 'P220795603', 'P220940304', 'P221674032',
            'P221697848', 'P222200385', 'P222391103', 'P222924200', 'P223101916', 'Q220793280',
            'Q221048248', 'Q221349795', 'Q221352970', 'Q221421854', 'Q222027841', 'Q222573080',
            'Q222623389', 'Q222649374', 'Q222681998', 'Q222955911', 'Q222965355', 'Q223147922',
            'R220035435', 'R220067231', 'R220277835', 'R220443428', 'R220503858', 'R220841362',
            'R220924893', 'R221035386', 'R221313581', 'R221516895', 'R221566288', 'R221644143',
            'R221804907', 'R221887022', 'R222149183', 'R222279828', 'R222456914', 'R222526617',
            'R222599727', 'R222639495', 'R222723812', 'R222945578', 'R223039382', 'R223244730',
            'R223366428', 'R223489784', 'R224258676', 'R224394971', 'S120099116', 'S220147726',
            'S220171722', 'S220186590', 'S220200577', 'S220200817', 'S220209632', 'S220218588',
            'S220224808', 'S220227238', 'S220228422', 'S220228520', 'S220235285', 'S220247589',
            'S220261632', 'S220303920', 'S220323075', 'S220375444', 'S220408288', 'S220424808',
            'S220456542', 'S220489514', 'S220501588', 'S220508452', 'S220516981', 'S220573404',
            'S220692753', 'S220694766', 'S220773502', 'S220796023', 'S220797502', 'S220901177',
            'S220940085', 'S220951668', 'S220951677', 'S220983179', 'S221023798', 'S221069098',
            'S221088137', 'S221134796', 'S221195262', 'S221222424', 'S221279432', 'S221280328',
            'S221283356', 'S221334429', 'S221337626', 'S221363260', 'S221396929', 'S221428560',
            'S221436419', 'S221493816', 'S221512389', 'S221528510', 'S221553853', 'S221578485',
            'S221584812', 'S221613023', 'S221614879', 'S221625514', 'S221676093', 'S221687612',
            'S221691625', 'S221715988', 'S221794032', 'S221809270', 'S221829334', 'S221847903',
            'S221914909', 'S221920452', 'S221958296', 'S221981777', 'S221989719', 'S222007770',
            'S222069850', 'S222097158', 'S222097783', 'S222108325', 'S222132616', 'S222140172',
            'S222140350', 'S222142498', 'S222167753', 'S222171239', 'S222213312', 'S222222820',
            'S222248164', 'S222255927', 'S222256291', 'S222285309', 'S222285907', 'S222292206',
            'S222294139', 'S222300598', 'S222305119', 'S222313773', 'S222324918', 'S222327188',
            'S222376396', 'S222380407', 'S222380425', 'S222385279', 'S222386221', 'S222389053',
            'S222426006', 'S222428662', 'S222451509', 'S222451803', 'S222530756', 'S222547457',
            'S222557873', 'S222561091', 'S222571471', 'S222658357', 'S222670317', 'S222701282',
            'S222712641', 'S222724016', 'S222760754', 'S222765679', 'S222798776', 'S222830448',
            'S222841718', 'S222894791', 'S222894933', 'S222899492', 'S222899652', 'S223031047',
            'S223039927', 'S223044455', 'S223124912', 'S223173004', 'S223313188', 'S223345484',
            'S223356147', 'S223392581', 'S223404095', 'S223445943', 'S223458262', 'S223472897',
            'S223473661', 'S223498373', 'S223503039', 'S223513517', 'S223517337', 'S223577664',
            'S223647661', 'S223738952', 'S223811885', 'S223823876', 'S223904287', 'S223918905',
            'S223940425', 'S224055096', 'S224081149', 'S224279407', 'S224339355', 'S224644459',
            'S224714625', 'S224725842', 'S225056088', 'T220124877', 'T220149623', 'T220184079',
            'T220257424', 'T220577949', 'T220606785', 'T220619308', 'T220643493', 'T220742151',
            'T220754633', 'T220910579', 'T221102213', 'T221185696', 'T221459708', 'T221520775',
            'T221718426', 'T221733889', 'T221761365', 'T222175998', 'T222230449', 'T222280912',
            'T222322853', 'T222325229', 'T222334335', 'T222334415', 'T222347538', 'T222350946',
            'T222361010', 'T222542444', 'T222592042', 'T222634198', 'T222641371', 'T222661006',
            'T222833100', 'T222835364', 'T223014636', 'T223121994', 'T223143874', 'T223208227',
            'T223230489', 'T223268741', 'T223321789', 'T223340113', 'T223363456', 'T223435028',
            'T223450329', 'T223476403', 'T223501349', 'T223506960', 'T223562619', 'T223601746',
            'T223686445', 'T223819748', 'U220722810', 'U220728536', 'U220822253', 'V220445720',
            'V220877482', 'W200265559', 'X220049013', 'X220083908', 'S225795339', 'S225615872',
            'S225901935', 'T221761365', 'S225642066', 'S225641989', 'S225568878' // 從圖像中補充的身份證字號
        ];
        
        // ** 學分查詢身份證字號白名單 (使用您提供的圖檔資訊) **
        const CREDIT_ID_WHITELIST = [
            'S222327188',
            'S225795339',
            'S225615872',
            'S225901935',
            'T221761365',
            'S225642066',
            'S225641989',
            'S225568878'
        ];
        
        // --- 全域變數與初始化 ---
        let db;
        let auth;
        let userId = 'anonymous';
        let isAuthReady = false;
        let isBackendAccessed = false; // NEW: 追蹤後台是否已登入
        
        // 全域簽到/簽退時間區間設定 (Date Object) - 更新為三個區間
        let morningCheckInStartTime = null; 
        let morningCheckInEndTime = null; 
        let afternoonCheckInStartTime = null; 
        let afternoonCheckInEndTime = null; 
        let afternoonCheckOutStartTime = null; 
        let afternoonCheckOutEndTime = null; 
        
        
        // *******************************************************************
        // ❗ 針對「Firebase 配置遺失」的錯誤修復與說明 ❗
        // 
        // 1. 如果您在 Canvas 環境中運行：請保持以下程式碼不變。
        // 2. 如果您在本地 HTML 檔案中運行：請務必將您在 Firebase Console 取得的專案配置物件
        //    填入下方的 `YOUR_LOCAL_FIREBASE_CONFIG` 中。
        
        // 如果您在本地執行，請在下方的 { } 內貼上您的 Firebase 配置物件。
        const YOUR_LOCAL_FIREBASE_CONFIG = {
  apiKey: "AIzaSyBlqR82MrYJB_SCIrlSxdcUdDrW6K96TrE",
  authDomain: "csvs-8b55d.firebaseapp.com",
  projectId: "csvs-8b55d",
  storageBucket: "csvs-8b55d.firebasestorage.app",
  messagingSenderId: "93064933978",
  appId: "1:93064933978:web:226fc3a8a271b2a4975e63",
  measurementId: "G-W2ZJKEMPV4"
}; 
        
        // *******************************************************************
        
        // 取得環境變數，這是 Firebase 必要的配置
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // 如果 Canvas 環境變數不存在，則使用 YOUR_LOCAL_FIREBASE_CONFIG
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) 
            : YOUR_LOCAL_FIREBASE_CONFIG;
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        

        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        
        // 簽到/簽退相關元素 - 更新為三階段按鈕
        const signIdNumberInput = document.getElementById('sign_id_number');
        const morningCheckInButton = document.getElementById('morningCheckInButton');
        const afternoonCheckInButton = document.getElementById('afternoonCheckInButton');
        const afternoonCheckOutButton = document.getElementById('afternoonCheckOutButton');
        
        // 系統設定相關元素
        const morningCheckInStartTimeInput = document.getElementById('setting_morning_ci_start');
        const morningCheckInEndTimeInput = document.getElementById('setting_morning_ci_end');
        const afternoonCheckInStartTimeInput = document.getElementById('setting_afternoon_ci_start');
        const afternoonCheckInEndTimeInput = document.getElementById('setting_afternoon_ci_end');
        const afternoonCheckOutStartTimeInput = document.getElementById('setting_afternoon_co_start');
        const afternoonCheckOutEndTimeInput = document.getElementById('setting_afternoon_co_end');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const resetTimeSettingsButton = document.getElementById('resetTimeSettingsButton'); // NEW

        // 取消報名元素
        const cancelRegistrationButton = document.getElementById('cancelRegistrationButton'); // NEW

        // 學分查詢元素
        const creditQueryButton = document.getElementById('creditQueryButton'); // NEW
        
        // 新增的設定存取元素
        const toggleSettingsButton = document.getElementById('toggleSettingsButton');
        const settingsAccessSection = document.getElementById('settingsAccessSection');
        const settingsAccessPasswordInput = document.getElementById('settingsAccessPassword');
        const confirmSettingsAccessButton = document.getElementById('confirmSettingsAccessButton');
        const settingsInputsContainer = document.getElementById('settingsInputsContainer');
        const accessError = document.getElementById('accessError');

        // 後台操作相關元素 (NEW/REPLACED)
        const accessBackendButton = document.getElementById('accessBackendButton');
        const backendContent = document.getElementById('backendContent');
        const backendPasswordInput = document.getElementById('backendPassword'); // 重新定義 ID
        const confirmBackendAccessButton = document.getElementById('confirmBackendAccessButton'); // 重新定義 ID
        const backendAccessError = document.getElementById('backendAccessError'); // 重新定義 ID
        const registrationsListContainer = document.getElementById('registrationsListContainer');
        const backendInfoText = document.getElementById('backendInfoText');

        const exportCsvButton = document.getElementById('exportCsvButton');
        const clearDataButton = document.getElementById('clearDataButton'); 
        const clearSignaturesButton = document.getElementById('clearSignaturesButton'); // NEW

        // 新增會員相關元素
        const addMemberButton = document.getElementById('addMemberButton');
        const addMemberModal = document.getElementById('addMemberModal');
        const cancelAddMemberButton = document.getElementById('cancelAddMemberButton');
        const confirmAddMemberButton = document.getElementById('confirmAddMemberButton');
        const newMemberIdInput = document.getElementById('newMemberIdInput');
        const memberAddMessage = document.getElementById('memberAddMessage');

        // 彈窗
        const successModal = document.getElementById('successModal'); // 報名成功
        const closeModalButton = document.getElementById('closeModalButton');
        const signSuccessModal = document.getElementById('signSuccessModal'); // 簽到/簽退成功 & 取消報名成功
        const closeSignModalButton = document.getElementById('closeSignModalButton');
        const signSuccessTitle = document.getElementById('signSuccessTitle');
        const signSuccessMessage = document.getElementById('signSuccessMessage');
        const errorModal = document.getElementById('errorModal'); // 報名錯誤 & 查詢失敗
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const confirmModal = document.getElementById('confirmModal'); // 清空資料二次確認
        const cancelConfirmButton = document.getElementById('cancelConfirmButton');
        const executeConfirmButton = document.getElementById('executeConfirmButton');


        let areSettingsVisible = false; // 追蹤設定區塊是否已成功驗證並顯示

        // --- 彈窗相關函數 ---

        function showSuccessModal() {
            successModal.classList.remove('hidden');
            setTimeout(() => { successModal.classList.add('modal-open'); }, 10);
        }

        function hideSuccessModal() {
            successModal.classList.remove('modal-open');
            setTimeout(() => { successModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * 顯示簽到/簽退/取消報名/學分查詢成功彈窗。
         * @param {string} title 標題
         * @param {string} message 訊息內容
         */
        function showSignSuccessModal(title, message) {
            signSuccessTitle.textContent = title;
            signSuccessMessage.textContent = message;
            signSuccessModal.classList.remove('hidden');
            setTimeout(() => { signSuccessModal.classList.add('modal-open'); }, 10);
        }
        
        function hideSignSuccessModal() {
            signSuccessModal.classList.remove('modal-open');
            setTimeout(() => { signSuccessModal.classList.add('hidden'); }, 300);
        }

        /**
         * 顯示報名/查詢錯誤彈窗。
         * @param {string} title 標題
         * @param {string} message 訊息內容
         */
        function showErrorModal(title, message) {
            errorTitle.textContent = title;
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            setTimeout(() => { errorModal.classList.add('modal-open'); }, 10);
        }
        
        function hideErrorModal() {
            errorModal.classList.remove('modal-open');
            setTimeout(() => { errorModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * 顯示二次確認彈窗
         * @param {string} title 標題
         * @param {string} message 訊息
         * @param {string} actionType 'clearData' or 'clearSignatures' or 'resetTime'
         */
        function showConfirmModal(title, message, actionType) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            // 設置按鈕的執行操作
            executeConfirmButton.setAttribute('data-action', actionType);
            if (actionType === 'clearData') {
                executeConfirmButton.textContent = '確定清空';
            } else if (actionType === 'clearSignatures') {
                executeConfirmButton.textContent = '確定還原';
            } else if (actionType === 'resetTime') {
                 executeConfirmButton.textContent = '確定重設';
            }

            confirmModal.classList.remove('hidden');
            setTimeout(() => { confirmModal.classList.add('modal-open'); }, 10);
        }

        /**
         * 隱藏二次確認彈窗
         */
        function hideConfirmModal() {
            confirmModal.classList.remove('modal-open');
            executeConfirmButton.removeAttribute('data-action');
            setTimeout(() => { confirmModal.classList.add('hidden'); }, 300);
        }
        
        /**
         * 顯示新增會員彈窗
         */
        function showAddMemberModal() {
            addMemberModal.classList.remove('hidden');
            memberAddMessage.classList.add('hidden');
            newMemberIdInput.value = '';
            setTimeout(() => { addMemberModal.classList.add('modal-open'); }, 10);
        }
        
        /**
         * 隱藏新增會員彈窗
         */
        function hideAddMemberModal() {
            addMemberModal.classList.remove('modal-open');
            setTimeout(() => { addMemberModal.classList.add('hidden'); }, 300);
        }


        /**
         * 顯示訊息給使用者，並設定樣式
         * @param {string} message 訊息內容
         * @param {string} type 液類型: 'info', 'success', 'error'
         * @param {number} duration 訊息顯示時間 (毫秒), 預設 5000ms
         */
        function displayMessage(message, type = 'info', duration = 5000) {
            let bgColor = '';
            let textColor = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-sky-100';
                    textColor = 'text-sky-800';
                    break;
            }
            
            // 立即顯示訊息
            statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300 ${bgColor} ${textColor}`;
            statusMessage.textContent = message;

            // 設置計時器，在一段時間後清除訊息
            clearTimeout(window.statusMessageTimeout);
            if (duration > 0) {
                window.statusMessageTimeout = setTimeout(() => {
                    // 清除樣式和內容
                    statusMessage.className = `w-full max-w-2xl p-3 mb-4 rounded-lg text-center text-sm font-medium transition duration-300`;
                    statusMessage.textContent = '系統準備就緒。';
                }, duration);
            }
        }
        
        /**
         * 格式化 Date 物件為 datetime-local 輸入格式 (YYYY-MM-DDTHH:MM)
         * @param {Date} dateObj 
         */
        function formatToLocalDatetime(dateObj) {
            // 確保輸入是 Date 物件
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            
            // 調整時區偏移，以顯示正確的本地時間在 datetime-local 輸入框
            const tempDate = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000));
            return tempDate.toISOString().slice(0, 16);
        }

        /**
         * 格式化時間戳 helper
         */
        const formatTimestamp = (ts) => {
            if (ts instanceof Date) {
                 return ts.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            } else if (ts && ts.toDate) {
                return ts.toDate().toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
            return 'N/A';
        }

        /**
         * 獲取公用資料集的 Firestore 集合參考
         */
        function getRegistrationsCollectionRef() {
            // 使用公共路徑: /artifacts/{appId}/public/data/registrations
            return collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
        }
        
        /**
         * 獲取系統設定文件的 Firestore 文件參考
         */
        function getSettingsDocRef() {
            // 使用公共路徑: /artifacts/{appId}/public/data/app_settings/config
            return doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config');
        }

        /**
         * 初始化 Firebase 應用程式和身份驗證
         */
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                // 如果 firebaseConfig 為空物件，表示本地配置遺失
                displayMessage('錯誤：Firebase 配置遺失。請參考程式碼中的註釋，在 `YOUR_LOCAL_FIREBASE_CONFIG` 處填入您的 Firebase 專案配置。', 'error', 0);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                displayMessage('正在進行身份驗證...', 'info', 0);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        displayMessage('系統初始化成功，歡迎使用！', 'success');
                        submitButton.disabled = false;
                        morningCheckInButton.disabled = false;
                        afternoonCheckInButton.disabled = false;
                        afternoonCheckOutButton.disabled = false;
                        toggleSettingsButton.disabled = false; // 啟用設定按鈕
                        accessBackendButton.disabled = false; // 啟用後台進入按鈕 // NEW
                        cancelRegistrationButton.disabled = false; // 啟用取消報名按鈕
                        creditQueryButton.disabled = false; // 啟用學分查詢按鈕
                        isAuthReady = true;
                        await fetchSettings(); // 載入系統設定
                    } else {
                        // 如果沒有用戶，嘗試匿名登入
                        if (initialAuthToken) {
                            // 使用提供的客製化 token 登入
                            await signInWithCustomToken(auth, initialAuthToken); 
                        } else {
                            // 否則使用匿名登入
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                displayMessage(`Firebase 初始化失敗: ${error.message} (請檢查配置)`, 'error', 0);
            }
        }
        
        // --- 報名清單顯示與更新 (已移除即時監聽) ---

        /**
         * 渲染報名者清單到畫面上 (僅在後台登入時使用一次)
         * @param {Array<Object>} registrations 報名資料陣列
         */
        function renderRegistrationsList(registrations) {
            // 由於清單功能已移除，此函數現在只用於 CSV 匯出前的資料處理，但為了兼容性保留結構。
            // 這裡不再進行前端渲染。
            return; 
        }

        /**
         * 從 Firestore 獲取資料並開始即時監聽 (此處改為僅獲取資料，不進行監聽)
         */
        function setupBackendListener() {
            // 由於清單已移除，此處不再需要設置 onSnapshot。
            // 程式碼已精簡，以符合移除清單功能的需求。
            console.log("Backend: Listing feature removed. Ready for export/clear operations.");
        }


        // --- 系統設定操作 ---

        /**
         * 從 Firestore 獲取系統設定
         */
        async function fetchSettings() {
            if (!db) return;

            try {
                const settingsRef = getSettingsDocRef();
                const docSnap = await getDoc(settingsRef);

                const nowDatetime = formatToLocalDatetime(new Date());

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 轉換 Firestore Timestamp/Date 為 JavaScript Date object - 更新為六個時間
                    morningCheckInStartTime = data.morningCheckInStartTime && data.morningCheckInStartTime.toDate ? data.morningCheckInStartTime.toDate() : null;
                    morningCheckInEndTime = data.morningCheckInEndTime && data.morningCheckInEndTime.toDate ? data.morningCheckInEndTime.toDate() : null;
                    afternoonCheckInStartTime = data.afternoonCheckInStartTime && data.afternoonCheckInStartTime.toDate ? data.afternoonCheckInStartTime.toDate() : null;
                    afternoonCheckInEndTime = data.afternoonCheckInEndTime && data.afternoonCheckInEndTime.toDate ? data.afternoonCheckInEndTime.toDate() : null;
                    afternoonCheckOutStartTime = data.afternoonCheckOutStartTime && data.afternoonCheckOutStartTime.toDate ? data.afternoonCheckOutStartTime.toDate() : null;
                    afternoonCheckOutEndTime = data.afternoonCheckOutEndTime && data.afternoonCheckOutEndTime.toDate ? data.afternoonCheckOutEndTime.toDate() : null;

                    // 更新 UI 輸入框的值，如果為 null 則使用當前時間
                    morningCheckInStartTimeInput.value = morningCheckInStartTime ? formatToLocalDatetime(morningCheckInStartTime) : nowDatetime;
                    morningCheckInEndTimeInput.value = morningCheckInEndTime ? formatToLocalDatetime(morningCheckInEndTime) : nowDatetime;
                    afternoonCheckInStartTimeInput.value = afternoonCheckInStartTime ? formatToLocalDatetime(afternoonCheckInStartTime) : nowDatetime;
                    afternoonCheckInEndTimeInput.value = afternoonCheckInEndTime ? formatToLocalDatetime(afternoonCheckInEndTime) : nowDatetime;
                    afternoonCheckOutStartTimeInput.value = afternoonCheckOutStartTime ? formatToLocalDatetime(afternoonCheckOutStartTime) : nowDatetime;
                    afternoonCheckOutEndTimeInput.value = afternoonCheckOutEndTime ? formatToLocalDatetime(afternoonCheckOutEndTime) : nowDatetime;

                    displayMessage('系統設定已載入。', 'info', 3000);
                } else {
                    // 如果沒有設定檔，初始化輸入框為當前時間
                    morningCheckInStartTimeInput.value = nowDatetime;
                    morningCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckInStartTimeInput.value = nowDatetime;
                    afternoonCheckInEndTimeInput.value = nowDatetime;
                    afternoonCheckOutStartTimeInput.value = nowDatetime;
                    afternoonCheckOutEndTimeInput.value = nowDatetime;
                    displayMessage('系統設定文件不存在，請進行初始化設定。', 'info', 5000);
                }
                
                saveSettingsButton.disabled = false; // 載入完成後啟用儲存按鈕
                resetTimeSettingsButton.disabled = false; // 載入完成後啟用還原按鈕

            } catch (error) {
                console.error("獲取系統設定失敗:", error);
                displayMessage('獲取系統設定失敗。', 'error', 5000);
            }
        }

        /**
         * 處理顯示/隱藏設定區塊
         */
        function handleToggleSettings() {
            if (!isAuthReady) return;
            
            // 每次點擊都重設密碼驗證狀態
            settingsAccessSection.classList.add('hidden');
            settingsInputsContainer.classList.add('hidden');
            settingsAccessPasswordInput.value = '';
            accessError.classList.add('hidden');

            if (areSettingsVisible) {
                // 如果目前是顯示狀態，點擊則隱藏
                areSettingsVisible = false;
                displayMessage('系統設定已隱藏。', 'info', 2000);
            } else {
                // 如果目前是隱藏狀態，則顯示密碼區塊進行存取驗證
                settingsAccessSection.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('請輸入密碼以存取設定。', 'info', 5000);
            }
        }

        /**
         * 處理確認存取設定區塊的密碼
         */
        function handleConfirmSettingsAccess() {
            const enteredPassword = settingsAccessPasswordInput.value;
            
            if (enteredPassword === EXPORT_PASSWORD) {
                // 密碼正確: 顯示設定輸入區塊，隱藏驗證區塊
                settingsAccessSection.classList.add('hidden');
                settingsInputsContainer.classList.remove('hidden');
                areSettingsVisible = true;
                settingsAccessPasswordInput.value = ''; // 清空密碼
                accessError.classList.add('hidden');
                displayMessage('密碼正確，設定區塊已開啟。', 'success', 3000);

            } else {
                // 密碼錯誤: 顯示錯誤，清空輸入框
                settingsAccessPasswordInput.value = '';
                accessError.classList.remove('hidden');
                settingsAccessPasswordInput.focus();
                displayMessage('密碼錯誤，無法存取設定。', 'error', 5000);
            }
        }

        /**
         * 儲存系統設定 (更新為六個時間區間)
         */
        async function handleSaveSettings() {
            if (!isAuthReady || !areSettingsVisible) {
                displayMessage('請先存取設定區塊並確保系統已準備好。', 'error');
                return;
            }

            saveSettingsButton.disabled = true;
            saveSettingsButton.textContent = '儲存中...';
            
            // 獲取六個時間字串
            const miStartStr = morningCheckInStartTimeInput.value;
            const miEndStr = morningCheckInEndTimeInput.value;
            const aiStartStr = afternoonCheckInStartTimeInput.value;
            const aiEndStr = afternoonCheckInEndTimeInput.value;
            const aoStartStr = afternoonCheckOutStartTimeInput.value;
            const aoEndStr = afternoonCheckOutEndTimeInput.value;

            // 檢查所有欄位是否填寫
            if (!miStartStr || !miEndStr || !aiStartStr || !aiEndStr || !aoStartStr || !aoEndStr) {
                displayMessage('所有簽到/簽退時間區間都必須設定。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }

            // 轉換為 Date 物件
            const miStartDate = new Date(miStartStr);
            const miEndDate = new Date(miEndStr);
            const aiStartDate = new Date(aiStartStr);
            const aiEndDate = new Date(aiEndStr);
            const aoStartDate = new Date(aoStartStr);
            const aoEndDate = new Date(aoEndStr);
            
            // 檢查是否為無效日期
            if (isNaN(miStartDate.getTime()) || isNaN(miEndDate.getTime()) || 
                isNaN(aiStartDate.getTime()) || isNaN(aiEndDate.getTime()) || 
                isNaN(aoStartDate.getTime()) || isNaN(aoEndDate.getTime())) {
                displayMessage('無效的時間格式，請檢查輸入。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }

            // 驗證區間邏輯
            if (miStartDate.getTime() >= miEndDate.getTime()) {
                 displayMessage('上午簽到開始時間必須早於結束時間。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }
            if (aiStartDate.getTime() >= aiEndDate.getTime()) {
                 displayMessage('下午簽到開始時間必須早於結束時間。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }
            if (aoStartDate.getTime() >= aoEndDate.getTime()) {
                 displayMessage('下午簽退開始時間必須早於結束時間。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }
            // 檢查時間連貫性 (上午結束 < 下午開始, 下午結束 < 簽退開始)
            if (miEndDate.getTime() >= aiStartDate.getTime()) {
                displayMessage('上午簽到結束時間必須早於下午簽到開始時間。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }
            if (aiEndDate.getTime() >= aoStartDate.getTime()) {
                displayMessage('下午簽到結束時間必須早於下午簽退開始時間。', 'error');
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
                return;
            }

            const newSettings = {
                morningCheckInStartTime: miStartDate,
                morningCheckInEndTime: miEndDate,
                afternoonCheckInStartTime: aiStartDate,
                afternoonCheckInEndTime: aiEndDate,
                afternoonCheckOutStartTime: aoStartDate,
                afternoonCheckOutEndTime: aoEndDate
            };

            try {
                // 使用 setDoc 覆蓋或創建單一設定文件
                await setDoc(getSettingsDocRef(), newSettings, { merge: true });
                
                // 更新本地狀態
                morningCheckInStartTime = miStartDate;
                morningCheckInEndTime = miEndDate;
                afternoonCheckInStartTime = aiStartDate;
                afternoonCheckInEndTime = aiEndDate;
                afternoonCheckOutStartTime = aoStartDate;
                afternoonCheckOutEndTime = aoEndDate;
                
                displayMessage('系統設定儲存成功！', 'success');

                // 儲存成功後收起設定視窗
                settingsInputsContainer.classList.add('hidden');
                areSettingsVisible = false;

            } catch (error) {
                console.error("儲存系統設定失敗:", error);
                displayMessage(`儲存設定失敗: ${error.message}`, 'error');
            } finally {
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = '儲存設定';
            }
        }

        /**
         * 處理還原時間設定至預設值 (NEW)
         */
        async function handleResetTimeSettings() {
             if (!isAuthReady || !areSettingsVisible) {
                displayMessage('請先存取設定區塊。', 'error');
                return;
            }
            
            hideConfirmModal(); // 隱藏確認彈窗
            displayMessage('正在還原時間設定...', 'info', 0);
            
            try {
                const settingsRef = getSettingsDocRef();
                
                // 將所有時間欄位設置為 deleteField() 來清除
                const resetData = {
                    morningCheckInStartTime: deleteField(),
                    morningCheckInEndTime: deleteField(),
                    afternoonCheckInStartTime: deleteField(),
                    afternoonCheckInEndTime: deleteField(),
                    afternoonCheckOutStartTime: deleteField(),
                    afternoonCheckOutEndTime: deleteField(),
                };
                
                await updateDoc(settingsRef, resetData);
                
                // 重新載入設定以更新本地狀態和 UI
                await fetchSettings();
                
                // 儲存成功後收起設定視窗
                settingsInputsContainer.classList.add('hidden');
                areSettingsVisible = false;

                displayMessage('時間設定已還原為預設值，請重新設定。', 'success');
                
            } catch (error) {
                console.error("還原時間設定失敗:", error);
                displayMessage(`還原設定失敗: ${error.message}`, 'error');
            }
        }


        /**
         * 提交報名表單
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) {
                displayMessage('系統尚未準備好，請稍候再試。', 'error');
                return;
            }

            // 禁用按鈕防止重複提交
            submitButton.disabled = true;
            submitButton.textContent = '報名中...';

            const school = document.getElementById('school').value.trim();
            const name = document.getElementById('name').value.trim();
            const id_number = document.getElementById('id_number').value.trim().toUpperCase(); 
            const meal = document.getElementById('meal').value; // NEW
            const question = document.getElementById('question').value.trim(); // NEW

            // 基本驗證
            if (!school || !name || !id_number || !meal) {
                displayMessage('學校、姓名、身份證字號及餐點欄位都必須填寫！', 'error');
                submitButton.disabled = false;
                submitButton.textContent = '立即報名';
                return;
            }
            
            // 身份證字號格式驗證 (簡易版: 10碼，首字英文，後9碼數字)
            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(id_number)) {
                displayMessage('報名身份證字號格式不正確，請檢查。', 'error');
                submitButton.disabled = false;
                submitButton.textContent = '立即報名';
                return;
            }
            
            // *** 報名檢查: 檢查是否在會員名單內 (以身份證字號為依據) ***
            if (!REGISTRATION_ID_WHITELIST.includes(id_number)) {
                // 使用新增的錯誤彈窗 (NEW)
                showErrorModal('報名失敗', '您非會員無法報名，請洽會員組');
                submitButton.disabled = false;
                submitButton.textContent = '立即報名';
                return;
            }
            // **********************************

            // 檢查是否已報名 (仍以身份證字號為唯一鍵)
            const qCheck = query(getRegistrationsCollectionRef(), where('id_number', '==', id_number));
            const existingDocs = await getDocs(qCheck);
            if (!existingDocs.empty) {
                displayMessage('您已使用此身份證字號報名過，請勿重複報名。', 'error');
                submitButton.disabled = false;
                submitButton.textContent = '立即報名';
                return;
            }


            const newRegistration = {
                school,
                name,
                id_number,
                meal,       // NEW
                question,   // NEW
                timestamp: new Date(), // 使用當前時間記錄報名
                registeredBy: userId,
                morningCheckInTime: null, // 新增欄位
                afternoonCheckInTime: null, // 新增欄位
                afternoonCheckOutTime: null // 新增欄位
            };

            try {
                await addDoc(getRegistrationsCollectionRef(), newRegistration);
                
                // *** 報名成功後顯示彈窗 ***
                showSuccessModal(); 

                form.reset(); 

            } catch (error) {
                console.error("新增報名資料失敗:", error);
                displayMessage(`報名失敗: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '立即報名';
            }
        }

        /**
         * 處理取消報名 (NEW)
         */
        async function handleCancelRegistration() {
            if (!isAuthReady) {
                displayMessage('系統尚未準備好，請稍候再試。', 'error');
                return;
            }

            const idNumber = document.getElementById('cancel_id_number').value.trim().toUpperCase();

            if (!idNumber) {
                displayMessage('請輸入身份證字號以取消報名。', 'error');
                return;
            }
            
            const button = document.getElementById('cancelRegistrationButton');
            button.disabled = true;
            button.textContent = '處理取消中...';

            try {
                const q = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showErrorModal('取消失敗', '查無此身份證字號的報名紀錄，請確認輸入是否正確。');
                    return;
                }

                // 找到文件 (應該只有一個)
                const docId = snapshot.docs[0].id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', docId));

                // 顯示成功彈窗
                showSignSuccessModal('取消成功', '您已取消研習報名成功。');
                document.getElementById('cancel_id_number').value = '';

            } catch (error) {
                console.error("取消報名失敗:", error);
                displayMessage(`取消報名失敗: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '確定取消報名';
            }
        }


        /**
         * 處理上午簽到
         */
        async function handleMorningCheckIn() {
            await processSignAction('morningCheckIn');
        }

        /**
         * 處理下午簽到
         */
        async function handleAfternoonCheckIn() {
            await processSignAction('afternoonCheckIn');
        }

        /**
         * 處理下午簽退
         */
        async function handleAfternoonCheckOut() {
            await processSignAction('afternoonCheckOut');
        }

        /**
         * 處理學分查詢 (NEW) - **使用身份證字號白名單進行核對**
         */
        async function handleCreditQuery() {
            if (!isAuthReady) {
                displayMessage('系統尚未準備好，請稍候再試。', 'error');
                return;
            }

            const idNumber = document.getElementById('query_id_number').value.trim().toUpperCase();

            if (!idNumber) {
                displayMessage('請輸入身份證字號以進行查詢。', 'error');
                return;
            }
            
            const button = document.getElementById('creditQueryButton');
            button.disabled = true;
            button.textContent = '查詢中...';

            try {
                // 1. 驗證身份證字號格式
                const idRegex = /^[A-Z][0-9]{9}$/;
                if (!idRegex.test(idNumber)) {
                    showErrorModal('查詢失敗', '身份證字號格式不正確，請檢查。');
                    return;
                }

                // 2. **NEW: 查詢身份證字號是否在學分白名單中**
                if (CREDIT_ID_WHITELIST.includes(idNumber)) {
                    // 找到了，顯示成功訊息
                    showSignSuccessModal('學分查詢結果', '學會已為您申請學分');
                    
                } else {
                    // 未找到，顯示失敗訊息
                    showErrorModal('學分查詢結果', '尚未申請，請洽會員組');
                }

            } catch (error) {
                console.error("學分查詢失敗:", error);
                showErrorModal('查詢失敗', `發生錯誤，請稍後再試：${error.message}`);
            } finally {
                document.getElementById('query_id_number').value = '';
                button.disabled = false;
                button.textContent = '查詢學分申請狀態';
            }
        }


        /**
         * 處理簽到/簽退的通用邏輯 (更新為三階段)
         * @param {string} actionType 'morningCheckIn', 'afternoonCheckIn', or 'afternoonCheckOut'
         */
        async function processSignAction(actionType) {
            if (!isAuthReady) {
                displayMessage('系統尚未準備好，請稍候再試。', 'error');
                return;
            }

            const idNumber = signIdNumberInput.value.trim().toUpperCase();
            
            if (!idNumber) {
                displayMessage('請輸入身份證字號以進行操作。', 'error');
                return;
            }

            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                displayMessage('身份證字號格式不正確，請檢查。', 'error');
                return;
            }
            
            // *** 使用系統當前時間 ***
            const signDate = new Date();
            // ************************


            // 動態獲取按鈕
            const button = document.getElementById(actionType + 'Button'); 
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = '處理中...';
            
            try {
                // --- 步驟 1: 根據操作類型設定驗證參數 ---
                let startTime = null;
                let endTime = null;
                let actionName = '';
                let updateField = '';

                switch (actionType) {
                    case 'morningCheckIn':
                        startTime = morningCheckInStartTime;
                        endTime = morningCheckInEndTime;
                        actionName = '上午簽到';
                        updateField = 'morningCheckInTime';
                        break;
                    case 'afternoonCheckIn':
                        startTime = afternoonCheckInStartTime;
                        endTime = afternoonCheckInEndTime;
                        actionName = '下午簽到';
                        updateField = 'afternoonCheckInTime';
                        break;
                    case 'afternoonCheckOut':
                        startTime = afternoonCheckOutStartTime;
                        endTime = afternoonCheckOutEndTime;
                        actionName = '下午簽退';
                        updateField = 'afternoonCheckOutTime';
                        break;
                    default:
                        displayMessage('無效的操作類型。', 'error');
                        return;
                }
                
                // 檢查開放區間
                if (!startTime || !endTime) {
                    showErrorModal('操作失敗', `錯誤：尚未設定 ${actionName} 的開放時間區間，請洽管理員設定。`);
                    return; // 嚴格阻止操作，直到設定完成
                }

                // 檢查是否在區間內
                if (signDate.getTime() < startTime.getTime() || signDate.getTime() > endTime.getTime()) {
                    const rangeStr = `${startTime.toLocaleString('zh-TW')} 到 ${endTime.toLocaleString('zh-TW')}`;
                    showErrorModal('操作失敗', `${actionName}服務未在開放區間！開放時間為 ${rangeStr}。`);
                    return; // 阻止操作，因為不在時間範圍內
                }

                // --- 步驟 2: 查找報名紀錄 (確認此人是否已報名成功) ---
                const q = query(getRegistrationsCollectionRef(), where('id_number', '==', idNumber));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // 只有成功報名的人才能簽到/退
                    showErrorModal('簽到失敗', '查無此報名紀錄，請確認身份證字號是否正確。');
                    return;
                }

                // 找到文件 (應該只有一個)
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'registrations', snapshot.docs[0].id);
                const data = snapshot.docs[0].data();
                const updateData = {};
                
                // 檢查是否重複操作
                if (data[updateField]) {
                    showErrorModal('重複操作', `您已於 ${formatTimestamp(data[updateField])} 完成${actionName}，請勿重複操作。`);
                    return;
                }

                // --- 步驟 3: 執行簽到/簽退邏輯與交叉驗證 (已移除關聯性檢查) ---
                
                // 注意：這裡移除了所有上午/下午的順序檢查，現在只需檢查是否重複即可。

                updateData[updateField] = signDate;

                await updateDoc(docRef, updateData);
                signIdNumberInput.value = ''; // 清空身份證字號輸入框
                
                // *** 簽到/簽退成功後顯示彈窗 ***
                showSignSuccessModal('操作成功', `${actionName}成功！您已完成本次操作。`);
                
            } catch (error) {
                console.error(`處理 ${actionType} 失敗:`, error);
                displayMessage(`處理失敗: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // --- 後台管理操作 (NEW) ---

        /**
         * 處理點擊「進入系統」按鈕
         */
        function handleAccessBackend() {
            if (!isAuthReady) return;
            
            // 每次點擊都重設密碼驗證狀態
            backendContent.classList.add('hidden');
            backendPasswordInput.value = '';
            backendAccessError.classList.add('hidden');
            
            // 顯示密碼驗證區塊
            passwordSection.classList.remove('hidden');
            accessBackendButton.disabled = true;
            backendInfoText.textContent = '請輸入密碼以進入後台管理介面。';
            backendPasswordInput.focus();
        }

        /**
         * 處理確認後台存取密碼
         */
        function handleConfirmBackendAccess() {
            const enteredPassword = backendPasswordInput.value;

            if (enteredPassword !== EXPORT_PASSWORD) {
                // 密碼錯誤
                backendPasswordInput.value = '';
                backendAccessError.classList.remove('hidden');
                backendPasswordInput.focus();
                displayMessage('後台密碼錯誤，請重新輸入。', 'error');
                return;
            }

            // 密碼正確
            passwordSection.classList.add('hidden'); // 隱藏密碼區塊
            accessBackendButton.classList.add('hidden'); // 隱藏進入系統按鈕
            backendContent.classList.remove('hidden'); // 顯示後台內容
            backendInfoText.textContent = '您已進入後台管理模式。';
            
            // 由於清單功能已移除，我們不再需要啟動監聽器或設置 loading 狀態

            isBackendAccessed = true;
            setupBackendListener(); // 移除即時監聽清單啟動
            
            displayMessage('後台存取成功！', 'success');
        }
        
        /**
         * 處理新增會員 (NEW)
         */
        function handleAddMember() {
            if (!isBackendAccessed) {
                displayMessage('請先進入後台系統。', 'error');
                return;
            }
            showAddMemberModal();
        }

        /**
         * 處理確認新增會員身份證字號 (NEW)
         */
        function handleConfirmAddMember() {
            const idNumber = newMemberIdInput.value.trim().toUpperCase();

            // 1. 驗證格式
            const idRegex = /^[A-Z][0-9]{9}$/;
            if (!idRegex.test(idNumber)) {
                memberAddMessage.classList.remove('text-green-500');
                memberAddMessage.classList.add('text-red-500');
                memberAddMessage.textContent = '身份證字號格式不正確 (A123456789)。';
                memberAddMessage.classList.remove('hidden');
                return;
            }

            // 2. 檢查是否重複
            if (REGISTRATION_ID_WHITELIST.includes(idNumber)) {
                memberAddMessage.classList.remove('text-green-500');
                memberAddMessage.classList.add('text-red-500');
                memberAddMessage.textContent = '該身份證字號已存在於報名白名單中。';
                memberAddMessage.classList.remove('hidden');
                return;
            }
            
            // 3. 新增至白名單
            REGISTRATION_ID_WHITELIST.push(idNumber);
            memberAddMessage.classList.remove('text-red-500');
            memberAddMessage.classList.add('text-green-500');
            memberAddMessage.textContent = `成功新增 ${idNumber} 至報名白名單！`;
            memberAddMessage.classList.remove('hidden');
            console.log("Updated REGISTRATION_ID_WHITELIST:", REGISTRATION_ID_WHITELIST); // Console log for verification
            
            // 延遲關閉視窗
            setTimeout(hideAddMemberModal, 1500);
        }

        /**
         * 處理清空所有簽到/簽退紀錄 (NEW)
         */
        async function clearAllSignatures() {
            if (!isAuthReady || !db || !isBackendAccessed) {
                displayMessage('請先進入後台系統。', 'error');
                return;
            }
            
            hideConfirmModal(); // 隱藏確認彈窗
            displayMessage('正在清空簽到/簽退紀錄...', 'info', 0);
            
            try {
                const q = query(getRegistrationsCollectionRef());
                const snapshot = await getDocs(q);
                let updateCount = 0;
                
                const updatePromises = [];
                snapshot.forEach((docSnap) => {
                    // 批量更新，將所有簽到/簽退時間設為 null
                    updatePromises.push(updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', docSnap.id), {
                        morningCheckInTime: null,
                        afternoonCheckInTime: null,
                        afternoonCheckOutTime: null
                    }));
                    updateCount++;
                });
                
                await Promise.all(updatePromises);
                
                displayMessage(`已成功清除 ${updateCount} 筆報名資料的簽到/簽退紀錄！`, 'success');

            } catch (error) {
                console.error("清空簽到紀錄失敗:", error);
                displayMessage(`清除簽到/簽退失敗: ${error.message}`, 'error');
            }
        }


        /**
         * 處理清空報名資料 (二次確認後執行)
         */
        async function deleteAllRegistrations() {
            if (!isAuthReady || !db) {
                displayMessage('系統尚未準備好，無法執行清空操作。', 'error');
                return;
            }
            
            hideConfirmModal(); // 隱藏確認彈窗
            displayMessage('正在清空所有報名資料... 請勿關閉視窗。', 'error', 0);

            try {
                const q = query(getRegistrationsCollectionRef());
                const snapshot = await getDocs(q);
                let deleteCount = 0;
                
                // 逐一刪除文件
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                    deleteCount++;
                });
                
                await Promise.all(deletePromises);
                
                displayMessage(`已成功清空 ${deleteCount} 筆報名紀錄！`, 'success');

            } catch (error) {
                console.error("清空資料失敗:", error);
                displayMessage(`清空資料失敗: ${error.message}`, 'error');
            }
        }


        /**
         * 從 Firestore 抓取所有報名資料並匯出為 CSV。
         */
        async function fetchDataAndExportToCsv() {
            if (!isAuthReady || !db || !isBackendAccessed) {
                displayMessage('請先進入後台系統。', 'error');
                return;
            }
            
            exportCsvButton.disabled = true;
            exportCsvButton.textContent = '獲取資料中...';
            displayMessage('正在從資料庫獲取資料...', 'info');

            try {
                // **MODIFIED: 移除 orderBy**
                const q = query(getRegistrationsCollectionRef()); 

                const snapshot = await getDocs(q);
                const registrations = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // 獲取原始資料，包含簽到簽退時間
                    registrations.push({ 
                        school: data.school,
                        name: data.name,
                        id_number: data.id_number, 
                        timestamp: data.timestamp,
                        meal: data.meal || '', // NEW
                        question: data.question || '', // NEW
                        morningCheckInTime: data.morningCheckInTime || null, // NEW
                        afternoonCheckInTime: data.afternoonCheckInTime || null, // NEW
                        afternoonCheckOutTime: data.afternoonCheckOutTime || null, // NEW
                        registeredBy: data.registeredBy
                    });
                });
                
                // 執行下載
                performCsvDownload(registrations);

            } catch (error) {
                console.error("獲取資料失敗:", error);
                displayMessage(`匯出失敗: ${error.message}`, 'error');
            } finally {
                 exportCsvButton.disabled = false;
                 exportCsvButton.textContent = '匯出 CSV';
            }
        }
        
        /**
         * 將資料轉換為 CSV 並觸發下載
         * @param {Array<object>} registrations 報名資料陣列
         */
        function performCsvDownload(registrations) {
            if (registrations.length === 0) {
                displayMessage('資料庫中沒有報名紀錄可供匯出。', 'error');
                return;
            }

            // 更新 CSV 標頭
            const headers = [
                "報名時間", "學校", "姓名", "身份證字號", "餐點", "講師問題", // ADDED NEW FIELDS
                "是否上午簽到", "上午簽到時間", 
                "是否下午簽到", "下午簽到時間", 
                "是否下午簽退", "下午簽退時間", 
                "註冊者ID"
            ];
            
            // 獲取並格式化行數據
            const rows = registrations.map(reg => {
                const registrationTime = formatTimestamp(reg.timestamp);
                
                const morningCheckInTimeStr = formatTimestamp(reg.morningCheckInTime);
                const afternoonCheckInTimeStr = formatTimestamp(reg.afternoonCheckInTime);
                const afternoonCheckOutTimeStr = formatTimestamp(reg.afternoonCheckOutTime);
                
                // 新增：是否簽到/簽退的註記
                const isMorningCheckedIn = reg.morningCheckInTime ? '是' : '否';
                const isAfternoonCheckedIn = reg.afternoonCheckInTime ? '是' : '否';
                const isAfternoonCheckedOut = reg.afternoonCheckOutTime ? '是' : '否';


                // 使用 JSON.stringify 並替換掉引號，以正確處理包含逗號的字串
                const cleanAndQuote = (str) => `"${String(str).replace(/"/g, '""')}"`;
                
                return [
                    cleanAndQuote(registrationTime),
                    cleanAndQuote(reg.school || ''),
                    cleanAndQuote(reg.name || ''),
                    cleanAndQuote(reg.id_number || ''),
                    cleanAndQuote(reg.meal || ''), // NEW
                    cleanAndQuote(reg.question || ''), // NEW
                    
                    cleanAndQuote(isMorningCheckedIn),      
                    cleanAndQuote(morningCheckInTimeStr),   
                    
                    cleanAndQuote(isAfternoonCheckedIn),    
                    cleanAndQuote(afternoonCheckInTimeStr), 

                    cleanAndQuote(isAfternoonCheckedOut),   
                    cleanAndQuote(afternoonCheckOutTimeStr),

                    cleanAndQuote(reg.registeredBy || '')
                ];
            });

            // 結合標頭和行數據
            const csvContent = [
                headers.join(','), // 標頭
                ...rows.map(e => e.join(',')) // 行數據
            ].join('\n');

            // 觸發下載
            // "\ufeff" 是 BOM，確保中文在 Excel 中正確顯示
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            const now = new Date();
            const fileName = `研習報名清單_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.csv`;
            
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            displayMessage('報名清單已匯出為 CSV 檔案！', 'success');
        }


        // --- 事件監聽器和啟動 ---
        
        form.addEventListener('submit', handleFormSubmit);
        
        // 後台進入與操作
        accessBackendButton.addEventListener('click', handleAccessBackend); // 點擊進入系統
        confirmBackendAccessButton.addEventListener('click', handleConfirmBackendAccess); // 確認密碼
        exportCsvButton.addEventListener('click', fetchDataAndExportToCsv); // 匯出 CSV (已進入後台，無需再次密碼)
        
        // 清空資料 (需要二次確認，所以只觸發彈窗)
        clearDataButton.addEventListener('click', () => {
             showConfirmModal('清空確認', '您確定要清空所有報名紀錄嗎？此操作無法復原！', 'clearData');
        }); 
        
        // 清空簽到/簽退 (需要二次確認)
        clearSignaturesButton.addEventListener('click', () => {
             showConfirmModal('清空簽到/簽退確認', '您確定要清除所有報名紀錄中的簽到和簽退時間嗎？此操作會將所有簽到狀態還原為「未簽到」。', 'clearSignatures');
        }); 
        
        // **NEW: 還原時間設定按鈕**
        resetTimeSettingsButton.addEventListener('click', () => {
            if (!areSettingsVisible) {
                displayMessage('請先透過密碼存取設定區塊。', 'error');
                return;
            }
            showConfirmModal('重設時間確認', '您確定要清除所有簽到/簽退的開放時間設定嗎？清除後，請重新設定時間區間。', 'resetTime');
        });

        // 取消報名按鈕
        document.getElementById('cancelRegistrationButton').addEventListener('click', handleCancelRegistration);
        
        // 學分查詢按鈕 (NEW)
        document.getElementById('creditQueryButton').addEventListener('click', handleCreditQuery);
        
        // 新增會員按鈕 (NEW)
        addMemberButton.addEventListener('click', handleAddMember);
        cancelAddMemberButton.addEventListener('click', hideAddMemberModal);
        confirmAddMemberButton.addEventListener('click', handleConfirmAddMember);


        // 二次確認彈窗按鈕
        cancelConfirmButton.addEventListener('click', hideConfirmModal); // 取消清空
        executeConfirmButton.addEventListener('click', () => {
            const action = executeConfirmButton.getAttribute('data-action');
            if (action === 'clearData') {
                deleteAllRegistrations();
            } else if (action === 'clearSignatures') {
                clearAllSignatures();
            } else if (action === 'resetTime') {
                handleResetTimeSettings();
            }
        }); // 確定執行操作

        // 簽到/簽退功能
        morningCheckInButton.addEventListener('click', handleMorningCheckIn);
        afternoonCheckInButton.addEventListener('click', handleAfternoonCheckIn);
        afternoonCheckOutButton.addEventListener('click', handleAfternoonCheckOut);
        
        // 系統設定功能
        toggleSettingsButton.addEventListener('click', handleToggleSettings); // 點擊顯示/隱藏設定區塊
        confirmSettingsAccessButton.addEventListener('click', handleConfirmSettingsAccess); // 密碼驗證存取
        saveSettingsButton.addEventListener('click', handleSaveSettings); // 儲存設定事件

        // 彈窗關閉
        closeModalButton.addEventListener('click', hideSuccessModal);
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideSuccessModal(); // 點擊背景區域也關閉
            }
        });
        
        // 簽到/簽退彈窗關閉
        closeSignModalButton.addEventListener('click', hideSignSuccessModal);
        signSuccessModal.addEventListener('click', (e) => {
            if (e.target === signSuccessModal) {
                hideSignSuccessModal();
            }
        });

        // 報名錯誤彈窗關閉
        closeErrorModalButton.addEventListener('click', hideErrorModal);
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                hideErrorModal();
            }
        });
        
        // 清空確認彈窗關閉
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                hideConfirmModal();
            }
        });


        // 啟動應用程式
        initializeFirebase();

    </script>
</body>
</html>